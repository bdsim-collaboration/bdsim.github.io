<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Accelerator Test Facility 2 - KEK, Japan &mdash; BDSIM 1.7.7.develop documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=fd3f3429" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=106dc6df"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Trajectory Generation" href="worked_example_trajectories/worked_example_trajectories1.html" />
    <link rel="prev" title="Collimation" href="worked_example_collimation/worked_example_collimation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            BDSIM
              <img src="_static/bdsim-logo-small.jpg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.7.7.develop
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="licence.html">Licence &amp; Disclaimer</a></li>
<li class="toctree-l1"><a class="reference internal" href="authorship.html">Authorship</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="running.html">Running BDSIM</a></li>
<li class="toctree-l1"><a class="reference internal" href="input_syntax.html">Input Syntax</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_construction.html">Model Construction</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_control.html">Model Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_customisation.html">Model Customisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_conversion.html">Model Conversion</a></li>
<li class="toctree-l1"><a class="reference internal" href="externalgeometry.html">External Geometry Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="output.html">Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="output_analysis.html">Output Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="python_utilities.html">Python Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualisation.html">Visualisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="interfacing.html">Interfacing</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="examples.html">Examples &amp; Tests</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="examples.html#basic-examples">Basic Examples</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="examples.html#worked-examples">Worked Examples</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="worked_example_target/worked_example_target.html">Analysis of Thin Target Products</a></li>
<li class="toctree-l3"><a class="reference internal" href="worked_example_collimation/worked_example_collimation.html">Collimation</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Accelerator Test Facility 2 - KEK, Japan</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#topics-covered">Topics Covered</a></li>
<li class="toctree-l4"><a class="reference internal" href="#contents">Contents</a></li>
<li class="toctree-l4"><a class="reference internal" href="#preparation">Preparation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#model-description">Model Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="#input-preparation">Input Preparation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#input-inspection">Input Inspection</a></li>
<li class="toctree-l4"><a class="reference internal" href="#conversion">Conversion</a></li>
<li class="toctree-l4"><a class="reference internal" href="#optical-validation">Optical Validation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-to-model">Adding to Model</a></li>
<li class="toctree-l4"><a class="reference internal" href="#changing-beam-distribution">Changing Beam Distribution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#halo-simulation">Halo Simulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#analysis">Analysis</a></li>
<li class="toctree-l4"><a class="reference internal" href="#spectra-at-plane">Spectra at Plane</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="worked_example_trajectories/worked_example_trajectories1.html">Trajectory Generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="worked_example_custom_analysis/worked_example_custom_analysis.html">Custom Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="worked_example_no_accelerator/worked_example_no_accelerator.html">No Accelerator Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="worked_example_model_model/model-model-single-pass.html">Model Model - Single Pass</a></li>
<li class="toctree-l3"><a class="reference internal" href="worked_example_machine_diagram/worked_example_machine_diagram.html">Machine Diagram</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#specific-machines">Specific Machines</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html#features">Features</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="support.html">Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="history.html">Version History</a></li>
<li class="toctree-l1"><a class="reference internal" href="developer.html">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_description.html">Model Description</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">BDSIM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="examples.html">Examples &amp; Tests</a></li>
      <li class="breadcrumb-item active">Accelerator Test Facility 2 - KEK, Japan</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/worked_example_atf2.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="accelerator-test-facility-2-kek-japan">
<h1>Accelerator Test Facility 2 - KEK, Japan<a class="headerlink" href="#accelerator-test-facility-2-kek-japan" title="Link to this heading"></a></h1>
<section id="topics-covered">
<h2>Topics Covered<a class="headerlink" href="#topics-covered" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Prepare TWISS file from MADX</p></li>
<li><p>Handle MADX TFS output</p></li>
<li><p>Convert MADX to BDSIM</p></li>
<li><p>Compare optics</p></li>
<li><p>Geometry placement</p></li>
<li><p>Beam halo</p></li>
<li><p>Make particle spectra</p></li>
<li><p>Analyse beam loss fraction</p></li>
<li><p>Use MADX, pymadx, pybdsim, bdsim, rebdsim, rebdsimOptics, rebdsimHistoMerge, ROOT</p></li>
<li><p>Based on several models in <code class="code docutils literal notranslate"><span class="pre">bdsim/examples/atf2</span></code></p></li>
</ul>
</section>
<section id="contents">
<h2>Contents<a class="headerlink" href="#contents" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#preparation">Preparation</a></p></li>
<li><p><a class="reference internal" href="#model-description">Model Description</a></p></li>
<li><p><a class="reference internal" href="#input-preparation">Input Preparation</a></p></li>
<li><p><a class="reference internal" href="#input-inspection">Input Inspection</a></p></li>
<li><p><a class="reference internal" href="#conversion">Conversion</a></p></li>
<li><p><a class="reference internal" href="#optical-validation">Optical Validation</a></p></li>
<li><p><a class="reference internal" href="#adding-to-model">Adding to Model</a></p></li>
<li><p><a class="reference internal" href="#changing-beam-distribution">Changing Beam Distribution</a></p></li>
<li><p><a class="reference internal" href="#halo-simulation">Halo Simulation</a></p></li>
<li><p><a class="reference internal" href="#analysis">Analysis</a></p></li>
<li><p><a class="reference internal" href="#spectra-at-plane">Spectra at Plane</a></p></li>
</ul>
</section>
<section id="preparation">
<h2>Preparation<a class="headerlink" href="#preparation" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>BDSIM has been compiled and installed.</p></li>
<li><p>The (DY)LD_LIBRARY_PATH and ROOT_INCLUDE_PATH environmental variables are set as
described in <a class="reference internal" href="output_analysis.html#output-analysis-setup"><span class="std std-ref">Setup</span></a>.</p></li>
<li><p>ROOT can be imported in Python</p></li>
<li><p><cite>pymadx</cite> and <cite>pybdsim</cite> have been installed.</p></li>
</ul>
</section>
<section id="model-description">
<h2>Model Description<a class="headerlink" href="#model-description" title="Link to this heading"></a></h2>
<p>This is the 1.3GeV energy scaled test facility for the ILC final focus system.
The real machine consists of an approximately 70m normal conducting linac,
transfer line, racetrack damping ring and finally an extraction line. This
model represents only the ~100m single-pass extraction line.</p>
</section>
<section id="input-preparation">
<h2>Input Preparation<a class="headerlink" href="#input-preparation" title="Link to this heading"></a></h2>
<p>A MAD-X job was used to prepare a Twiss table from MAD-X in TFS format. This is included in
<cite>bdsim/examples/atf2/atf2-nominal-twiss-v5.2.tfs.tar.gz</cite>. The file was prepared by adding
the following to the end of the MAD-X job:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">select</span><span class="p">,</span><span class="n">flag</span><span class="o">=</span><span class="n">twiss</span><span class="p">,</span> <span class="n">clear</span><span class="p">;</span>
<span class="n">twiss</span><span class="p">,</span><span class="n">sequence</span><span class="o">=</span><span class="n">ATF2</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">atf2</span><span class="o">-</span><span class="n">nominal</span><span class="o">-</span><span class="n">twiss</span><span class="o">-</span><span class="n">v5</span><span class="mf">.2</span><span class="o">.</span><span class="n">tfs</span><span class="p">;</span>
</pre></div>
</div>
<p>As we don’t specify any columns, all columns are written out (~250). Whilst this may seem
overkill, it ensures we don’t miss any of the required columns for conversion.</p>
<p>For convenience we compress this to save space. <cite>pybdsim</cite> and <cite>pymadx</cite> both work
with a compressed TFS file without the need to decompress it.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tar</span> <span class="o">-</span><span class="n">czf</span> <span class="n">atf2</span><span class="o">-</span><span class="n">nominal</span><span class="o">-</span><span class="n">twiss</span><span class="o">-</span><span class="n">v5</span><span class="mf">.2</span><span class="o">.</span><span class="n">tfs</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span> <span class="n">atf2</span><span class="o">-</span><span class="n">nominal</span><span class="o">-</span><span class="n">twiss</span><span class="o">-</span><span class="n">v5</span><span class="mf">.2</span><span class="o">.</span><span class="n">tfs</span>
</pre></div>
</div>
</section>
<section id="input-inspection">
<h2>Input Inspection<a class="headerlink" href="#input-inspection" title="Link to this heading"></a></h2>
<p>We can inspect the model as provided by MAD-X with pymadx in Python.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">python</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">pymadx</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">pymadx</span><span class="o">.</span><span class="n">Data</span><span class="o">.</span><span class="n">Tfs</span><span class="p">(</span><span class="s2">&quot;atf2-nominal-twiss-v5.2.tfs.tar.gz&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">ReportPopulations</span><span class="p">()</span>
<span class="n">Filename</span> <span class="o">&gt;</span> <span class="n">atf2</span><span class="o">-</span><span class="n">nominal</span><span class="o">-</span><span class="n">twiss</span><span class="o">-</span><span class="n">v5</span><span class="mf">.2</span><span class="o">.</span><span class="n">tfs</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="n">Total</span> <span class="n">number</span> <span class="n">of</span> <span class="n">items</span> <span class="o">&gt;</span> <span class="mi">1032</span>
<span class="n">Type</span><span class="o">...........</span> <span class="n">Population</span>
<span class="n">MULTIPOLE</span><span class="o">......</span> <span class="mi">516</span>
<span class="n">DRIFT</span><span class="o">..........</span> <span class="mi">201</span>
<span class="n">QUADRUPOLE</span><span class="o">.....</span> <span class="mi">102</span>
<span class="n">MARKER</span><span class="o">.........</span> <span class="mi">78</span>
<span class="n">MONITOR</span><span class="o">........</span> <span class="mi">64</span>
<span class="n">SBEND</span><span class="o">..........</span> <span class="mi">24</span>
<span class="n">SEXTUPOLE</span><span class="o">......</span> <span class="mi">18</span>
<span class="n">HKICKER</span><span class="o">........</span> <span class="mi">15</span>
<span class="n">VKICKER</span><span class="o">........</span> <span class="mi">14</span>
</pre></div>
</div>
<p>We can also inspect the strengths of all the sextupoles for example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sextupoles</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">GetElementsOfType</span><span class="p">(</span><span class="s1">&#39;SEXTUPOLE&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">len</span><span class="p">(</span><span class="n">sextupoles</span><span class="p">)</span>
<span class="go">18</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">sextupoles</span><span class="p">)</span>
<span class="go">pymadx.Data.Tfs</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sextupoles</span><span class="o">.</span><span class="n">GetColumn</span><span class="p">(</span><span class="s2">&quot;K2L&quot;</span><span class="p">)</span><span class="o">/</span><span class="n">sextupoles</span><span class="o">.</span><span class="n">GetColumn</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>This produces the following figure:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/sextupolek2.png"><img alt="_images/sextupolek2.png" src="_images/sextupolek2.png" style="width: 70%;" /></a>
</figure>
</section>
<section id="conversion">
<h2>Conversion<a class="headerlink" href="#conversion" title="Link to this heading"></a></h2>
<p>The model can be converted to BDSIM’s GMAD syntax with the converter provided in <cite>pybdsim</cite>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">python</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">pybdsim</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">pybdsim</span><span class="o">.</span><span class="n">Convert</span><span class="o">.</span><span class="n">MadxTfs2Gmad</span><span class="p">(</span><span class="s1">&#39;atf2-nominal-twiss-v5.2.tfs.tar.gz&#39;</span><span class="p">,</span> <span class="s1">&#39;atf2bdsim&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The converter will automatically generate a Twiss beam distribution based on the first element
of the lattice. If the first element is <strong>not a marker</strong> the beam will be wrong as the optical
functions from MAD-X are typically at the end of each element (they can be set to the middle too,
but not to the beginning). The user should check the distribution.</p>
<p>This converts the model as is. We can also prepare a linear only version of the model:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">pybdsim</span><span class="o">.</span><span class="n">Convert</span><span class="o">.</span><span class="n">MadxTfs2Gmad</span><span class="p">(</span><span class="s1">&#39;atf2-nominal-twiss-v5.2.tfs.tar.gz&#39;</span><span class="p">,</span> <span class="s1">&#39;atf2bdsimlinear&#39;</span><span class="p">,</span> <span class="n">linear</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Several gmad files are created:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">ls</span>
<span class="n">atf2bdsimlinear</span><span class="o">.</span><span class="n">gmad</span>
<span class="n">atf2bdsimlinear_beam</span><span class="o">.</span><span class="n">gmad</span>
<span class="n">atf2bdsimlinear_components</span><span class="o">.</span><span class="n">gmad</span>
<span class="n">atf2bdsimlinear_options</span><span class="o">.</span><span class="n">gmad</span>
<span class="n">atf2bdsimlinear_sequence</span><span class="o">.</span><span class="n">gmad</span>
</pre></div>
</div>
<p>The components are defined in the file with <cite>components</cite> suffix, the sequence, options and beam similarly.
These GMAD files are included in the <em>main</em> file <cite>atf2bdsimlinear.gmad</cite>.</p>
<ul class="simple">
<li><p>No options are required by default to get a working model.</p></li>
<li><p>Only tracking is provided by default - no physics processes are registered.</p></li>
<li><p>By default, a sampler is attached to all items with the <code class="code docutils literal notranslate"><span class="pre">sample,</span> <span class="pre">all;</span></code> command in the main file.</p></li>
</ul>
</section>
<section id="optical-validation">
<h2>Optical Validation<a class="headerlink" href="#optical-validation" title="Link to this heading"></a></h2>
<p>First we validate that the Twiss beam definition in the converted model is correct for
our machine. This is the case as the first item in the lattice is a marker in the MAD-X
job. The emittance and energy spread were also correctly specified in the MAD-X job and
have therefore been converted correctly.</p>
<p>We run 1000 particles to validate the optics:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bdsim</span> <span class="o">--</span><span class="n">file</span><span class="o">=</span><span class="n">atf2bdsimlinear</span><span class="o">.</span><span class="n">gmad</span> <span class="o">--</span><span class="n">outfile</span><span class="o">=</span><span class="n">o1</span> <span class="o">--</span><span class="n">batch</span> <span class="o">--</span><span class="n">ngenerate</span><span class="o">=</span><span class="mi">1000</span>
</pre></div>
</div>
<p>This output file can then be analysed to calculate the beam size and optical functions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rebdsimOptics</span> <span class="n">o1</span><span class="o">.</span><span class="n">root</span> <span class="n">optics</span><span class="o">.</span><span class="n">root</span>
</pre></div>
</div>
<p>We can now compare the optical functions using <cite>pybdsim</cite>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">python</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">pybdsim</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pybdsim</span><span class="o">.</span><span class="n">Compare</span><span class="o">.</span><span class="n">MadxVsBDSIM</span><span class="p">(</span><span class="s1">&#39;atf2-nominal-twiss-v5.2-sige0.tfs&#39;</span><span class="p">,</span> <span class="s1">&#39;optics.root&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This produces a series of plots comparing beam size and optical functions such as the following:</p>
<figure class="align-center" id="id1">
<a class="reference internal image-reference" href="_images/sigma.pdf"><img alt="_images/sigma.pdf" src="_images/sigma.pdf" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text">Beam size.</span><a class="headerlink" href="#id1" title="Link to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id2">
<a class="reference internal image-reference" href="_images/sigmap.pdf"><img alt="_images/sigmap.pdf" src="_images/sigmap.pdf" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text">Angular beam size.</span><a class="headerlink" href="#id2" title="Link to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id3">
<a class="reference internal image-reference" href="_images/mean.pdf"><img alt="_images/mean.pdf" src="_images/mean.pdf" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text">Beam centroid.</span><a class="headerlink" href="#id3" title="Link to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id4">
<a class="reference internal image-reference" href="_images/beta.pdf"><img alt="_images/beta.pdf" src="_images/beta.pdf" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text">Twiss <span class="math notranslate nohighlight">\(\beta\)</span> function. Only the first part is shown due to the large variation.</span><a class="headerlink" href="#id4" title="Link to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id5">
<a class="reference internal image-reference" href="_images/alpha.pdf"><img alt="_images/alpha.pdf" src="_images/alpha.pdf" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text">Twiss <span class="math notranslate nohighlight">\(\alpha\)</span> function. Only the first part is shown due to the large variation.</span><a class="headerlink" href="#id5" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>Note, with nonlinear optics (i.e. including sextupoles and higher) the emittance between
each plane (horizontal, vertical) will be mixed and the calculated optical functions are
not representative. A model converted with the ‘linear’ flag will however be valid.</p>
<p>This step verifies that the model has been prepared correctly and matches the model
in the original program, MAD-X.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The energy spread used in BDSIM beam definition must be the same as that in
the Twiss output from MAD-X for the comparison to be valid.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The errors are the statistical uncertainty associated with the calculation. It
is possible depending on the number of particles for the model to agree but
the original lie outside the error bars.</p>
</div>
</section>
<section id="adding-to-model">
<h2>Adding to Model<a class="headerlink" href="#adding-to-model" title="Link to this heading"></a></h2>
<p>At this point, we can add more detail to the model. Here we place a GDML file containing
the tunnel geometry around the beam line. This geometry was prepared externally and
designed to have a hollow outermost ‘world’ volume so that it does not overlap with the
beam line - both exist at the same level in the hierarchy. If the tunnel container were not
hollow, the beam line would overlap with the tunnel geometry and tracking would be invalid.</p>
<p>In the main GMAD file, we define a placement of the geometry with the appropriate transform.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tun</span> <span class="p">:</span> <span class="n">placement</span><span class="p">,</span> <span class="n">geometryFile</span><span class="o">=</span><span class="s2">&quot;gdml:atf2_tunnel.gdml&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=-</span><span class="mf">4.5</span><span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">49</span><span class="o">*</span><span class="n">m</span><span class="p">;</span>
</pre></div>
</div>
<p>The example GDML file (“atf2_tunnel.gdml”) is provided in <code class="code docutils literal notranslate"><span class="pre">bdsim/examples/atf2/</span></code>. An example
file including this geometry with the placement above is provided in
<code class="code docutils literal notranslate"><span class="pre">bdsim/examples/atf2/nlsige/atf2-with-tunnel.gmad</span></code>.</p>
<p>Care must be taken not to place geometry that overlaps with the beam line otherwise the tracking
will be wrong. Using the <code class="code docutils literal notranslate"><span class="pre">option,</span> <span class="pre">checkOverlaps=1;</span></code> option is recommended when placing the
geometry for the first time. Once validated, this can be turned off for speed.</p>
<figure class="align-center" id="id6">
<a class="reference internal image-reference" href="_images/atf2-with-tunnel.png"><img alt="_images/atf2-with-tunnel.png" src="_images/atf2-with-tunnel.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text">Visualisation of the ATF2 in BDSIM with GDML tunnel model.</span><a class="headerlink" href="#id6" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>Geometry can be added for magnet yokes, placed alongside the beam line and placed
in the beam line. See <a class="reference internal" href="model_customisation.html#externally-provided-geometry"><span class="std std-ref">Externally Provided Geometry</span></a> for more details.</p>
<p>Custom field maps could also be added to the yokes of particular magnets. A general field map
for quadrupoles could also be added for example and auto-scaling used to scale the field map
for each quadrupole it’s attached to. See <a class="reference internal" href="model_customisation.html#field-maps"><span class="std std-ref">Fields</span></a> for more details.</p>
<p>One simple change is to specify a default aperture for all components.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">option</span><span class="p">,</span> <span class="n">aper1</span><span class="o">=</span><span class="mf">1.5</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
        <span class="n">beampipeThickness</span><span class="o">=</span><span class="mi">1</span><span class="o">*</span><span class="n">mm</span><span class="p">;</span>
</pre></div>
</div>
<p>The typical beam pipe width of the ATF2 is 30mm and the thickness ~1.5mm.</p>
</section>
<section id="changing-beam-distribution">
<h2>Changing Beam Distribution<a class="headerlink" href="#changing-beam-distribution" title="Link to this heading"></a></h2>
<p>As the model stands, it is not very interesting. The default aperture of 5cm is much bigger
than the typical sigma of the beam, which from the optics plots above can seen to be of order
1mm. To experience even a few hits, would require billions of events to be simulated, which is
of course not very efficient. We therefore specify a <strong>halo</strong> distribution of particles that
are likely to hit the aperture. The halo distribution is described in <a class="reference internal" href="model_control.html#beam-distributions"><span class="std std-ref">Beam Distributions</span></a>
and specifically in <a class="reference internal" href="model_control.html#beam-halo-distribution"><span class="std std-ref">halo</span></a>. We define a halo distribution according
to the normal Twiss parameters at the start of the lattice but with a much greater sigma.</p>
<p>Even if a Gaussian distribution is ultimately required, a common technique is
to generate a uniform distribution of particles and then weight the events in analysis
according to the Gaussian.</p>
<p>Here is an example halo distribution</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">beam</span><span class="p">,</span> <span class="n">alfx</span><span class="o">=</span><span class="mf">1.108024744</span><span class="p">,</span>
      <span class="n">alfy</span><span class="o">=-</span><span class="mf">1.907222942</span><span class="p">,</span>
      <span class="n">betx</span><span class="o">=</span><span class="mf">6.848560987</span><span class="o">*</span><span class="n">m</span><span class="p">,</span>
      <span class="n">bety</span><span class="o">=</span><span class="mf">2.935758992</span><span class="o">*</span><span class="n">m</span><span class="p">,</span>
      <span class="n">distrType</span><span class="o">=</span><span class="s2">&quot;halo&quot;</span><span class="p">,</span>
      <span class="n">emitx</span><span class="o">=</span><span class="mf">2e-09</span><span class="o">*</span><span class="n">m</span><span class="p">,</span>
      <span class="n">emity</span><span class="o">=</span><span class="mf">1.195785323e-11</span><span class="o">*</span><span class="n">m</span><span class="p">,</span>
      <span class="n">energy</span><span class="o">=</span><span class="mf">1.282</span><span class="o">*</span><span class="n">GeV</span><span class="p">,</span>
      <span class="n">particle</span><span class="o">=</span><span class="s2">&quot;e-&quot;</span><span class="p">,</span>
      <span class="n">sigmaE</span><span class="o">=</span><span class="mf">0.0008</span><span class="p">,</span>
      <span class="n">haloNSigmaXInner</span>      <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
      <span class="n">haloNSigmaXOuter</span>      <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
      <span class="n">haloNSigmaYInner</span>      <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
      <span class="n">haloNSigmaYOuter</span>      <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
      <span class="n">haloPSWeightParameter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
      <span class="n">haloPSWeightFunction</span>  <span class="o">=</span> <span class="s2">&quot;oneoverr&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>To validate this distribution and visualise it, we can generate only the particles without
performing the full simulation. We execute BDSIM with the <code class="code docutils literal notranslate"><span class="pre">--generatePrimariesOnly</span></code>
option. As the generation is very quick, we can afford to generate a large number of particles.
Here 10000 were generated in approximately 10s.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bdsim</span> <span class="o">--</span><span class="n">file</span><span class="o">=</span><span class="n">atf2</span><span class="o">-</span><span class="n">halo</span><span class="o">.</span><span class="n">gmad</span> <span class="o">--</span><span class="n">generatePrimariesOnly</span> <span class="o">--</span><span class="n">outfile</span><span class="o">=</span><span class="n">haloprimaries</span> <span class="o">--</span><span class="n">batch</span> <span class="o">--</span><span class="n">ngenerate</span><span class="o">=</span><span class="mi">10000</span>
</pre></div>
</div>
<p>We can then load and visualise the data using <cite>pybdsim</cite>. This is shown using a convenience function
for the primary particle distribution:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">python</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">pybdsim</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pybdsim</span><span class="o">.</span><span class="n">Plot</span><span class="o">.</span><span class="n">PrimaryPhaseSpace</span><span class="p">(</span><span class="s1">&#39;haloprimaries.root&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This produces the following figures. The user of course can create their own plots by loading the data.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/atf2-halo1.png"><img alt="_images/atf2-halo1.png" src="_images/atf2-halo1.png" style="width: 100%;" /></a>
</figure>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/atf2-halo2.png"><img alt="_images/atf2-halo2.png" src="_images/atf2-halo2.png" style="width: 100%;" /></a>
</figure>
<p>The raw data can be loaded from any sampler manually:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">python</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">pybdsim</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">d</span> <span class="o">=</span> <span class="n">pybdsim</span><span class="o">.</span><span class="n">Data</span><span class="o">.</span><span class="n">Load</span><span class="p">(</span><span class="s2">&quot;haloprimaries.root&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">psd</span> <span class="o">=</span> <span class="n">pybdsim</span><span class="o">.</span><span class="n">Data</span><span class="o">.</span><span class="n">PhaseSpaceData</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">allData</span> <span class="o">=</span> <span class="n">pybdsim</span><span class="o">.</span><span class="n">Data</span><span class="o">.</span><span class="n">SamplerData</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>The “phase space data” is only the data required to make the above plots. The “sampler data” is all the data
including weights, PDG ID, track ID etc.</p>
<p>The object “psd” here contains a member dictionary called “data” that has a numpy array for each
key inside it.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">psd</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="go">[&#39;energy&#39;, &#39;T&#39;, &#39;yp&#39;, &#39;y&#39;, &#39;x&#39;, &#39;xp&#39;, &#39;z&#39;, &#39;zp&#39;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">psd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="halo-simulation">
<h2>Halo Simulation<a class="headerlink" href="#halo-simulation" title="Link to this heading"></a></h2>
<p>As the model stands, no physics processes are registered so any particles
hitting the machine will not interact with the matter and pass straight through. This
is useful for efficient tracking and optical validation but not useful for a physics study.
We therefore specify a physics list. For a 1.3GeV electron, the basic electromagnetic
physics list from Geant4 as well as the decay physics and some muon specific processes
are useful. The full set of physics lists are described in <a class="reference internal" href="model_control.html#physics-processes"><span class="std std-ref">Physics Processes</span></a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">option</span><span class="p">,</span> <span class="n">physicsList</span><span class="o">=</span><span class="s2">&quot;em decay muon&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>By default, samplers are attached to everything. Whilst suitable for optical comparison
this produces a huge amount of data for a physics study. We turn this off by commenting
it out with an exclamation mark.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!sample, all;
</pre></div>
</div>
<p>We have now specified the halo distribution as described above, a default aperture and
physics processes. One final step is to turn off sensitivity to the tunnel geometry as
this is not required.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tun</span> <span class="p">:</span> <span class="n">placement</span><span class="p">,</span> <span class="n">geometryFile</span><span class="o">=</span><span class="s2">&quot;gdml:../atf2_tunnel.gdml&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=-</span><span class="mf">4.5</span><span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">49</span><span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">sensitive</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>The input gmad file prepared is supplied in <code class="code docutils literal notranslate"><span class="pre">bdsim/examples/atf2/nlsige/atf2-halo.gmad</span></code>.</p>
<p>We first run a small sample to gauge the length of the simulation and that the results
are very roughly what we expect or want to see (before running a large number of particles).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">bdsim</span> <span class="o">--</span><span class="n">file</span><span class="o">=</span><span class="n">atf2</span><span class="o">-</span><span class="n">halo</span><span class="o">.</span><span class="n">gmad</span> <span class="o">--</span><span class="n">outfile</span><span class="o">=</span><span class="n">t1</span> <span class="o">--</span><span class="n">batch</span> <span class="o">--</span><span class="n">ngenerate</span><span class="o">=</span><span class="mi">100</span>
</pre></div>
</div>
<p>This took approximately 10s to simulate and produced an output file “t1.root”. We perform
a very quick and simple analysis now to investigate what happened in the simulation.</p>
</section>
<section id="analysis">
<h2>Analysis<a class="headerlink" href="#analysis" title="Link to this heading"></a></h2>
<p>The first simple analysis step is make a histogram of the mean energy deposition per event.
BDSIM by default records a histogram of energy deposition per event. One could run the
analysis tool <cite>rebdsim</cite> with an input <em>analysisConfig.txt</em> specifying histograms. This would
also merge (take the average of) the pre-made per event histograms. A utility is provided for
merging only the histograms.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">rebdsimHistoMerge</span> <span class="n">t1</span><span class="o">.</span><span class="n">root</span> <span class="n">t1_ana</span><span class="o">.</span><span class="n">root</span>
</pre></div>
</div>
<p>This loops over all events in the file and combines the per event histograms and writes them
to a file called “t1_ana.root” here. To inspect this file, we load it in ROOT and browse it
using a <em>TBrowser</em>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&gt; root -l t1_ana.root
&gt; $&gt; TBrowser tb;
</pre></div>
</div>
<p>This produces the following browser. We double click on the “t1_ana.root” file and then the
folders inside. There is a folder for each Tree in the output and then per entry simple and
merged histograms. We look inside and double click on the histogram to view it.</p>
<figure class="align-center" id="id7">
<a class="reference internal image-reference" href="_images/atf2-tbrowser.png"><img alt="_images/atf2-tbrowser.png" src="_images/atf2-tbrowser.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text">TBrowser in ROOT showing file structure from <cite>rebdsim</cite> / <cite>rebdsimHistoMerge</cite>.</span><a class="headerlink" href="#id7" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>The energy deposition is in GeV / event. The horizontal axis is the curvilinear S coordinate in
metres. The default binning is 1m and can be controlled with the option
<code class="code docutils literal notranslate"><span class="pre">option,</span> <span class="pre">elossHistoBinWidth=1*m;</span></code>.</p>
<p>As the level of energy deposition varies by many orders of magnitude, it is useful to
view the histogram on a logarithmic scale. By right-clicking in the TBrowser close to the
axis, the option “SetLogy” can be used.</p>
<figure class="align-center" id="id8">
<a class="reference internal image-reference" href="_images/atf2-tbrowser-setlog.png"><img alt="_images/atf2-tbrowser-setlog.png" src="_images/atf2-tbrowser-setlog.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text">Setting log y axis in ROOT.</span><a class="headerlink" href="#id8" title="Link to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center" id="id9">
<a class="reference internal image-reference" href="_images/atf2-tbrowser-log.png"><img alt="_images/atf2-tbrowser-log.png" src="_images/atf2-tbrowser-log.png" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text">Energy deposition for 100 events from halo simulation.</span><a class="headerlink" href="#id9" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>We can then repeat this simulation and simple analysis for a greater number of primary particles. The
file <code class="code docutils literal notranslate"><span class="pre">examples/atf2/10khalo_ana.root</span></code> is included from the analysis of 10000 particles. The simulation
took 976s and produced a 178MB ROOT output file on the developer’s computer.</p>
</section>
<section id="spectra-at-plane">
<h2>Spectra at Plane<a class="headerlink" href="#spectra-at-plane" title="Link to this heading"></a></h2>
<p>To investigate the radiation at a plane at some point in the accelerator we can place a sampler
on an element of interest. Here, we place a sampler on “B5FFB”, which is a dipole at the end of
the long straight section in the lattice. In reality, cherenkov detectors were placed after this
dipole in the past for detecting signal from experiments such as the laserwire experiment. The sampler
is added via the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sample</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="n">B5FFB</span><span class="p">;</span>
</pre></div>
</div>
<p>Sampler record the passage of any particle through them, even if it’s backwards or the same particle
again. They are (by default) a 5m wide square plane that’s 1pm thick.</p>
<p>A simple analysis is to make a 2D histogram of the particle flux and the energy weighted particle
flux at this plane. To do this we use the analysis tool <cite>rebdsim</cite>. This takes an input text file
defining histograms. The syntax is described in <a class="reference internal" href="output_analysis.html#analysis-preparing-analysis-config"><span class="std std-ref">Preparing an Analysis Configuration File</span></a>. The
analysisConfig.txt used is provided in <code class="code docutils literal notranslate"><span class="pre">examples/atf2/analysisConfig.txt</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">InputFilePath</span>            <span class="mi">10</span><span class="n">k</span><span class="o">.</span><span class="n">root</span>
<span class="n">OutputFileName</span>           <span class="mi">10</span><span class="n">khalo_ana</span><span class="o">.</span><span class="n">root</span>
<span class="c1"># Object       treeName   Histogram Name         # Bins   Binning              Variable          Selection</span>
<span class="n">Histogram1D</span>    <span class="n">Event</span><span class="o">.</span>     <span class="n">XFlux</span>                  <span class="p">{</span><span class="mi">40</span><span class="p">}</span>     <span class="p">{</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>               <span class="n">B5FFB</span><span class="o">.</span><span class="n">x</span>           <span class="mi">1</span>
<span class="n">Histogram1D</span>    <span class="n">Event</span><span class="o">.</span>     <span class="n">XFlux</span><span class="o">-</span><span class="n">Energy</span><span class="o">-</span><span class="n">Weighted</span>  <span class="p">{</span><span class="mi">40</span><span class="p">}</span>     <span class="p">{</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>               <span class="n">B5FFB</span><span class="o">.</span><span class="n">x</span>           <span class="n">B5FFB</span><span class="o">.</span><span class="n">energy</span>
<span class="n">Histogram1D</span>    <span class="n">Event</span><span class="o">.</span>     <span class="n">YFlux</span>                  <span class="p">{</span><span class="mi">40</span><span class="p">}</span>     <span class="p">{</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>               <span class="n">B5FFB</span><span class="o">.</span><span class="n">y</span>           <span class="mi">1</span>
<span class="n">Histogram1D</span>    <span class="n">Event</span><span class="o">.</span>     <span class="n">YFlux</span><span class="o">-</span><span class="n">Energy</span><span class="o">-</span><span class="n">Weighted</span>  <span class="p">{</span><span class="mi">40</span><span class="p">}</span>     <span class="p">{</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>               <span class="n">B5FFB</span><span class="o">.</span><span class="n">y</span>           <span class="n">B5FFB</span><span class="o">.</span><span class="n">energy</span>
<span class="n">Histogram2D</span>    <span class="n">Event</span><span class="o">.</span>     <span class="n">XYFlux</span>                 <span class="p">{</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">}</span>  <span class="p">{</span><span class="o">-</span><span class="mf">0.5</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span><span class="o">-</span><span class="mf">0.5</span><span class="p">:</span><span class="mf">0.5</span><span class="p">}</span>  <span class="n">B5FFB</span><span class="o">.</span><span class="n">y</span><span class="p">:</span><span class="n">B5FFB</span><span class="o">.</span><span class="n">x</span>   <span class="mi">1</span>
<span class="n">Histogram2D</span>    <span class="n">Event</span><span class="o">.</span>     <span class="n">XYFlux</span><span class="o">-</span><span class="n">Energy</span><span class="o">-</span><span class="n">Weighted</span> <span class="p">{</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">}</span>  <span class="p">{</span><span class="o">-</span><span class="mf">0.5</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span><span class="o">-</span><span class="mf">0.5</span><span class="p">:</span><span class="mf">0.5</span><span class="p">}</span>  <span class="n">B5FFB</span><span class="o">.</span><span class="n">y</span><span class="p">:</span><span class="n">B5FFB</span><span class="o">.</span><span class="n">x</span>   <span class="n">B5FFB</span><span class="o">.</span><span class="n">energy</span>
<span class="n">Histogram1D</span>    <span class="n">Event</span><span class="o">.</span>     <span class="n">XPhotons</span>               <span class="p">{</span><span class="mi">40</span><span class="p">}</span>     <span class="p">{</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>               <span class="n">B5FFB</span><span class="o">.</span><span class="n">x</span>           <span class="n">B5FFB</span><span class="o">.</span><span class="n">partID</span><span class="o">==</span><span class="mi">22</span>
<span class="n">Histogram1D</span>    <span class="n">Event</span><span class="o">.</span>     <span class="n">XElectrons</span>             <span class="p">{</span><span class="mi">40</span><span class="p">}</span>     <span class="p">{</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>               <span class="n">B5FFB</span><span class="o">.</span><span class="n">x</span>           <span class="n">B5FFB</span><span class="o">.</span><span class="n">partID</span><span class="o">==</span><span class="mi">11</span>
<span class="n">Histogram1D</span>    <span class="n">Event</span><span class="o">.</span>     <span class="n">XPositrons</span>             <span class="p">{</span><span class="mi">40</span><span class="p">}</span>     <span class="p">{</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>               <span class="n">B5FFB</span><span class="o">.</span><span class="n">x</span>           <span class="n">B5FFB</span><span class="o">.</span><span class="n">partID</span><span class="o">==-</span><span class="mi">11</span>
</pre></div>
</div>
<p>We can view the histograms as before, but we can also easily load them in Python and
make our own plots.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">python</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">pybdsim</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">d</span> <span class="o">=</span> <span class="n">pybdsim</span><span class="o">.</span><span class="n">Data</span><span class="o">.</span><span class="n">Load</span><span class="p">(</span><span class="s2">&quot;10khalo_ana.root&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">d</span><span class="o">.</span> <span class="o">&lt;</span><span class="n">tab</span><span class="o">&gt;</span>
<span class="n">d</span><span class="o">.</span><span class="n">ConvertToPybdsimHistograms</span> <span class="n">d</span><span class="o">.</span><span class="n">histograms1dpy</span>             <span class="n">d</span><span class="o">.</span><span class="n">histograms3dpy</span>
<span class="n">d</span><span class="o">.</span><span class="n">filename</span>                   <span class="n">d</span><span class="o">.</span><span class="n">histograms2d</span>               <span class="n">d</span><span class="o">.</span><span class="n">histogramspy</span>
<span class="n">d</span><span class="o">.</span><span class="n">histograms</span>                 <span class="n">d</span><span class="o">.</span><span class="n">histograms2dpy</span>             <span class="n">d</span><span class="o">.</span><span class="n">ListOfDirectories</span>
<span class="n">d</span><span class="o">.</span><span class="n">histograms1d</span>               <span class="n">d</span><span class="o">.</span><span class="n">histograms3d</span>               <span class="n">d</span><span class="o">.</span><span class="n">ListOfTrees</span>
</pre></div>
</div>
<p>The <cite>pybdsim</cite> data loader automatically extracts the root histograms into Python dictionaries
called “histogramsXd” where “X” is the number of dimensions. All exist in “histograms”. These
are also automatically converted to numpy arrays and held in classes provided by <cite>pybdsim</cite> in
the same members suffixed with “py” such as “d.histograms1dpy”. Calling these dictionaries
shows the name of the histogram that is the full path inside the file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;Event/MergedHistograms/ElossHisto&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">ROOT</span><span class="o">.</span><span class="n">TH1D</span> <span class="nb">object</span> <span class="p">(</span><span class="s2">&quot;ElossHisto&quot;</span><span class="p">)</span> <span class="n">at</span> <span class="mh">0x7f83a0cfba20</span><span class="o">&gt;</span><span class="p">,</span>
<span class="s1">&#39;Event/MergedHistograms/ElossPEHisto&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">ROOT</span><span class="o">.</span><span class="n">TH1D</span> <span class="nb">object</span> <span class="p">(</span><span class="s2">&quot;ElossPEHisto&quot;</span><span class="p">)</span> <span class="n">at</span> <span class="mh">0x7f83a1970000</span><span class="o">&gt;</span><span class="p">,</span>
<span class="s1">&#39;Event/MergedHistograms/PhitsHisto&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">ROOT</span><span class="o">.</span><span class="n">TH1D</span> <span class="nb">object</span> <span class="p">(</span><span class="s2">&quot;PhitsHisto&quot;</span><span class="p">)</span> <span class="n">at</span> <span class="mh">0x7f83a0cfa8e0</span><span class="o">&gt;</span><span class="p">,</span>
<span class="s1">&#39;Event/MergedHistograms/PhitsPEHisto&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">ROOT</span><span class="o">.</span><span class="n">TH1D</span> <span class="nb">object</span> <span class="p">(</span><span class="s2">&quot;PhitsPEHisto&quot;</span><span class="p">)</span> <span class="n">at</span> <span class="mh">0x7f83a1a00640</span><span class="o">&gt;</span><span class="p">,</span>
<span class="s1">&#39;Event/MergedHistograms/PlossHisto&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">ROOT</span><span class="o">.</span><span class="n">TH1D</span> <span class="nb">object</span> <span class="p">(</span><span class="s2">&quot;PlossHisto&quot;</span><span class="p">)</span> <span class="n">at</span> <span class="mh">0x7f83a0cfb310</span><span class="o">&gt;</span><span class="p">,</span>
<span class="s1">&#39;Event/MergedHistograms/PlossPEHisto&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">ROOT</span><span class="o">.</span><span class="n">TH1D</span> <span class="nb">object</span> <span class="p">(</span><span class="s2">&quot;PlossPEHisto&quot;</span><span class="p">)</span> <span class="n">at</span> <span class="mh">0x7f83a1a00a30</span><span class="o">&gt;</span><span class="p">,</span>
<span class="s1">&#39;Event/PerEntryHistograms/XElectrons&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">ROOT</span><span class="o">.</span><span class="n">TH1D</span> <span class="nb">object</span> <span class="p">(</span><span class="s2">&quot;XElectrons&quot;</span><span class="p">)</span> <span class="n">at</span> <span class="mh">0x7f83a0cd89b0</span><span class="o">&gt;</span><span class="p">,</span>
<span class="s1">&#39;Event/PerEntryHistograms/XFlux&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">ROOT</span><span class="o">.</span><span class="n">TH1D</span> <span class="nb">object</span> <span class="p">(</span><span class="s2">&quot;XFlux&quot;</span><span class="p">)</span> <span class="n">at</span> <span class="mh">0x7f83a0c94300</span><span class="o">&gt;</span><span class="p">,</span>
<span class="s1">&#39;Event/PerEntryHistograms/XFlux-Energy-Weighted&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">ROOT</span><span class="o">.</span><span class="n">TH1D</span> <span class="nb">object</span> <span class="p">(</span><span class="s2">&quot;XFlux-Energy-Weighted&quot;</span><span class="p">)</span> <span class="n">at</span> <span class="mh">0x7f83a0cd70f0</span><span class="o">&gt;</span><span class="p">,</span>
<span class="s1">&#39;Event/PerEntryHistograms/XPhotons&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">ROOT</span><span class="o">.</span><span class="n">TH1D</span> <span class="nb">object</span> <span class="p">(</span><span class="s2">&quot;XPhotons&quot;</span><span class="p">)</span> <span class="n">at</span> <span class="mh">0x7f83a0cd8320</span><span class="o">&gt;</span><span class="p">,</span>
<span class="s1">&#39;Event/PerEntryHistograms/XPositrons&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">ROOT</span><span class="o">.</span><span class="n">TH1D</span> <span class="nb">object</span> <span class="p">(</span><span class="s2">&quot;XPositrons&quot;</span><span class="p">)</span> <span class="n">at</span> <span class="mh">0x7f83a0cd95a0</span><span class="o">&gt;</span><span class="p">,</span>
<span class="s1">&#39;Event/PerEntryHistograms/XYFlux&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">ROOT</span><span class="o">.</span><span class="n">TH2D</span> <span class="nb">object</span> <span class="p">(</span><span class="s2">&quot;XYFlux&quot;</span><span class="p">)</span> <span class="n">at</span> <span class="mh">0x7f839c5ef200</span><span class="o">&gt;</span><span class="p">,</span>
<span class="s1">&#39;Event/PerEntryHistograms/XYFlux-Energy-Weighted&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">ROOT</span><span class="o">.</span><span class="n">TH2D</span> <span class="nb">object</span> <span class="p">(</span><span class="s2">&quot;XYFlux-Energy-Weighted&quot;</span><span class="p">)</span> <span class="n">at</span> <span class="mh">0x7f839c5eb000</span><span class="o">&gt;</span><span class="p">,</span>
<span class="s1">&#39;Event/PerEntryHistograms/YFlux&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">ROOT</span><span class="o">.</span><span class="n">TH1D</span> <span class="nb">object</span> <span class="p">(</span><span class="s2">&quot;YFlux&quot;</span><span class="p">)</span> <span class="n">at</span> <span class="mh">0x7f83a0cd74e0</span><span class="o">&gt;</span><span class="p">,</span>
<span class="s1">&#39;Event/PerEntryHistograms/YFlux-Energy-Weighted&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">ROOT</span><span class="o">.</span><span class="n">TH1D</span> <span class="nb">object</span> <span class="p">(</span><span class="s2">&quot;YFlux-Energy-Weighted&quot;</span><span class="p">)</span> <span class="n">at</span> <span class="mh">0x7f83a0cd7de0</span><span class="o">&gt;</span><span class="p">}</span>
</pre></div>
</div>
<p>The Python versions can be easily plotted using <cite>pybdsim</cite>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pybdsim</span><span class="o">.</span><span class="n">Plot</span><span class="o">.</span><span class="n">Histogram1D</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">histograms1dpy</span><span class="p">[</span><span class="s1">&#39;Event/PerEntryHistograms/XElectrons&#39;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pybdsim</span><span class="o">.</span><span class="n">Plot</span><span class="o">.</span><span class="n">Histogram2D</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">histograms2dpy</span><span class="p">[</span><span class="s1">&#39;Event/PerEntryHistograms/XYFlux&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>These produce the following figures.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/atf2-1d-example-plot.pdf"><img alt="_images/atf2-1d-example-plot.pdf" src="_images/atf2-1d-example-plot.pdf" style="width: 100%;" /></a>
</figure>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/atf2-2d-example-plot.pdf"><img alt="_images/atf2-2d-example-plot.pdf" src="_images/atf2-2d-example-plot.pdf" style="width: 60%;" /></a>
</figure>
<p>We leave it to the user to create the plots they desire. However, the primary particle impact, loss
and associated energy deposition is a useful standard plot that is provided in <cite>pybdsim</cite>. The optional
survey arguments allow a machine diagram to be added on top of the plot.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pybdsim</span><span class="o">.</span><span class="n">Plot</span><span class="o">.</span><span class="n">LossAndEnergyDeposition</span><span class="p">(</span><span class="s1">&#39;10khalo_ana.root&#39;</span><span class="p">,</span> <span class="n">tfssurvey</span><span class="o">=</span><span class="s1">&#39;../atf2-nominal-twiss-v5.2.tfs.tar.gz&#39;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-center" id="id10">
<a class="reference internal image-reference" href="_images/atf2-losses.pdf"><img alt="_images/atf2-losses.pdf" src="_images/atf2-losses.pdf" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text">Primary particle impact points, losses and energy deposition from the simulation.</span><a class="headerlink" href="#id10" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>Just the energy deposition can be plotted.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pybdsim</span><span class="o">.</span><span class="n">Plot</span><span class="o">.</span><span class="n">EnergyDeposition</span><span class="p">(</span><span class="s1">&#39;10khalo_ana.root&#39;</span><span class="p">,</span> <span class="n">tfssurvey</span><span class="o">=</span><span class="s1">&#39;../atf2-nominal-twiss-v5.2.tfs.tar.gz&#39;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-center" id="id11">
<a class="reference internal image-reference" href="_images/atf2-energy-deposition.pdf"><img alt="_images/atf2-energy-deposition.pdf" src="_images/atf2-energy-deposition.pdf" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text">Primary particle impact points, losses and energy deposition from the simulation.</span><a class="headerlink" href="#id11" title="Link to this image"></a></p>
</figcaption>
</figure>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="worked_example_collimation/worked_example_collimation.html" class="btn btn-neutral float-left" title="Collimation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="worked_example_trajectories/worked_example_trajectories1.html" class="btn btn-neutral float-right" title="Trajectory Generation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Beam Delivery Simulation (BDSIM) Copyright (c) Royal Holloway, University of London, 2001 - 2025.
      <span class="lastupdated">Last updated on Jun 13, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JYMKZHVZJ2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-JYMKZHVZJ2', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>