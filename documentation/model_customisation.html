<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Model Customisation &mdash; BDSIM 1.7.7.develop documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=fd3f3429" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=106dc6df"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Model Conversion" href="model_conversion.html" />
    <link rel="prev" title="Model Control" href="model_control.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            BDSIM
              <img src="_static/bdsim-logo-small.jpg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.7.7.develop
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="licence.html">Licence &amp; Disclaimer</a></li>
<li class="toctree-l1"><a class="reference internal" href="authorship.html">Authorship</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="running.html">Running BDSIM</a></li>
<li class="toctree-l1"><a class="reference internal" href="input_syntax.html">Input Syntax</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_construction.html">Model Construction</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_control.html">Model Control</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Model Customisation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#fields">Fields</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#field-general-notes">Field General Notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#minimal-example">Minimal Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="#field-map-definition">Field Map Definition</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#autoscaling">AutoScaling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#field-types">Field Types</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pure-fields-types">Pure Fields Types</a></li>
<li class="toctree-l4"><a class="reference internal" href="#field-reflections-and-transforms">Field Reflections and Transforms</a></li>
<li class="toctree-l4"><a class="reference internal" href="#modulators">Modulators</a></li>
<li class="toctree-l4"><a class="reference internal" href="#integrators">Integrators</a></li>
<li class="toctree-l4"><a class="reference internal" href="#interpolators">Interpolators</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#file-formats">File Formats</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sub-fields">Sub-Fields</a></li>
<li class="toctree-l3"><a class="reference internal" href="#field-map-visualisation">Field Map Visualisation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#field-map-visualisation-queries">Field Map Visualisation - Queries</a></li>
<li class="toctree-l3"><a class="reference internal" href="#field-map-preparation">Field Map Preparation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#field-map-validation">Field Map Validation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#query-by-points-file">Query By Points File</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#field-map-interpolation">Field Map Interpolation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#materials-and-atoms">Materials and Atoms</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#single-element">Single Element</a></li>
<li class="toctree-l3"><a class="reference internal" href="#custom-single-element-material">Custom Single Element Material</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compound-material-by-atoms">Compound Material by Atoms</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compound-material-by-mass-fraction">Compound Material by Mass Fraction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#predefined-materials">Predefined Materials</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vacuum-and-air">Vacuum and Air</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#aperture-parameters">Aperture Parameters</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#circular">circular</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rectangular">rectangular</a></li>
<li class="toctree-l3"><a class="reference internal" href="#elliptical">elliptical</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lhc">lhc</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lhcdetailed">lhcdetailed</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rectellipse">rectellipse</a></li>
<li class="toctree-l3"><a class="reference internal" href="#racetrack">racetrack</a></li>
<li class="toctree-l3"><a class="reference internal" href="#octagonal">octagonal</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rhombus">rhombus</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pointsfile">pointsfile</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#magnet-geometry-parameters">Magnet Geometry Parameters</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#no-magnet-outer-geometry-none">No Magnet Outer Geometry - “<cite>none</cite>”</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cylindrical-cylindrical">Cylindrical - “<cite>cylindrical</cite>”</a></li>
<li class="toctree-l3"><a class="reference internal" href="#poles-circular-polescircular">Poles Circular - “<cite>polescircular</cite>”</a></li>
<li class="toctree-l3"><a class="reference internal" href="#poles-square-default-polessquare">Poles Square (Default) - “<cite>polessquare</cite>”</a></li>
<li class="toctree-l3"><a class="reference internal" href="#poles-faceted-polesfacet">Poles Faceted - “<cite>polesfacet</cite>”</a></li>
<li class="toctree-l3"><a class="reference internal" href="#poles-faceted-with-crop-polesfacetcrop">Poles Faceted with Crop - “<cite>polesfacetcrop</cite>”</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lhc-left-right-lhcleft-lhcright">LHC Left &amp; Right - “<cite>lhcleft</cite>” | “<cite>lhcright</cite>”</a></li>
<li class="toctree-l3"><a class="reference internal" href="#external-magnet-geometry">External Magnet Geometry</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#cavity-geometry-parameters">Cavity Geometry Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#externally-provided-geometry">Externally Provided Geometry</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#geometry-formats">Geometry Formats</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gdml-geometry-specifics">GDML Geometry Specifics</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#auxiliary-colour-information">Auxiliary Colour Information</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creating-gdml-geometry">Creating GDML Geometry</a></li>
<li class="toctree-l4"><a class="reference internal" href="#material-names-and-usage">Material Names And Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#gdml-preprocessing">GDML Preprocessing</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#external-world-geometry">External World Geometry</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#placements">Placements</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#external-geometry-file">External Geometry File</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bdsim-component">BDSIM Component</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tunnel-geometry">Tunnel Geometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="#crystals">Crystals</a></li>
<li class="toctree-l2"><a class="reference internal" href="#colours">Colours</a></li>
<li class="toctree-l2"><a class="reference internal" href="#automatic-colours">Automatic Colours</a></li>
<li class="toctree-l2"><a class="reference internal" href="#regions">Regions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#one-turn-map">One Turn Map</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="model_conversion.html">Model Conversion</a></li>
<li class="toctree-l1"><a class="reference internal" href="externalgeometry.html">External Geometry Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="output.html">Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="output_analysis.html">Output Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="python_utilities.html">Python Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualisation.html">Visualisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="interfacing.html">Interfacing</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples &amp; Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html">Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="history.html">Version History</a></li>
<li class="toctree-l1"><a class="reference internal" href="developer.html">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_description.html">Model Description</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">BDSIM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Model Customisation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/model_customisation.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="model-customisation">
<span id="id1"></span><h1>Model Customisation<a class="headerlink" href="#model-customisation" title="Link to this heading"></a></h1>
<ul class="simple">
<li><p><a class="reference internal" href="#field-maps"><span class="std std-ref">Fields</span></a></p></li>
<li><p><a class="reference internal" href="#materials-and-atoms"><span class="std std-ref">Materials and Atoms</span></a></p></li>
<li><p><a class="reference internal" href="#aperture-parameters"><span class="std std-ref">Aperture Parameters</span></a></p></li>
<li><p><a class="reference internal" href="#magnet-geometry-parameters"><span class="std std-ref">Magnet Geometry Parameters</span></a></p></li>
<li><p><a class="reference internal" href="#cavity-geometry-parameters"><span class="std std-ref">Cavity Geometry Parameters</span></a></p></li>
<li><p><a class="reference internal" href="#externally-provided-geometry"><span class="std std-ref">Externally Provided Geometry</span></a> Formats</p></li>
<li><p><a class="reference internal" href="#placements"><span class="std std-ref">Placements</span></a> of Geometry</p></li>
<li><p><a class="reference internal" href="#tunnel-geometry"><span class="std std-ref">Tunnel Geometry</span></a></p></li>
<li><p><a class="reference internal" href="#crystals"><span class="std std-ref">Crystals</span></a></p></li>
<li><p><a class="reference internal" href="#colours"><span class="std std-ref">Colours</span></a></p></li>
<li><p><a class="reference internal" href="#regions"><span class="std std-ref">Regions</span></a></p></li>
<li><p><a class="reference internal" href="#one-turn-map"><span class="std std-ref">One Turn Map</span></a></p></li>
</ul>
<section id="fields">
<span id="field-maps"></span><h2>Fields<a class="headerlink" href="#fields" title="Link to this heading"></a></h2>
<p>BDSIM provides the facility to overlay magnetic, electric, or combined electromagnetic fields
on an element, as defined either by an externally provided field map or by a ‘pure’ field from
an equation already included in BDSIM. A field map is an array of evenly space points in <strong>Cartesian</strong>
coordinates that define the field as a 3-vector at that point.</p>
<p>A field can be applied to an element or a piece of geometry for:</p>
<ol class="arabic simple">
<li><p>only the “vacuum” volume(s) (“fieldVacuum”)</p></li>
<li><p>only the “outer” volume(s) outside the vacuum (i.e. the yoke) (“fieldOuter”)</p></li>
<li><p>or one full map for the whole element. (“fieldAll”)</p></li>
</ol>
<p>BDSIM allows any Geant4 integrator to be used to calculate the motion of the particle, which
can be chosen given knowledge of the smoothness of the field or the application (default is
a 4th order Runge Kutta). BDSIM also provides a selection of 1-4D interpolators that are used
to provide the field value in between the data points in the supplied field map.</p>
<p>To overlay a field, one must define a field ‘object’ in the parser and then ‘attach’ it to an element.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f1</span><span class="p">:</span> <span class="n">field</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;bmap3d&quot;</span><span class="p">,</span> <span class="n">magneticFile</span><span class="o">=</span><span class="s2">&quot;bdsim3d:fieldmap.dat.gz&quot;</span><span class="p">;</span>
<span class="n">e1</span><span class="p">:</span> <span class="n">element</span><span class="p">,</span> <span class="n">geometryFile</span><span class="o">=</span><span class="s2">&quot;gdml:aPieceOfGeometry.gdml&quot;</span><span class="p">,</span> <span class="n">fieldAll</span><span class="o">=</span><span class="s2">&quot;f1&quot;</span><span class="p">;</span>
<span class="n">q1</span><span class="p">:</span> <span class="n">quadrupole</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">20</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span> <span class="n">k1</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">fieldOuter</span><span class="o">=</span><span class="s2">&quot;f1&quot;</span><span class="p">;</span>
<span class="n">h1</span><span class="p">:</span> <span class="n">hkicker</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">1</span><span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">fieldVacuum</span><span class="o">=</span><span class="s2">&quot;f1&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>These are all different uses of the same field map. <cite>e1</cite> uses a generic element with externally
provided geometry with a field map for all of the geometry. <cite>q1</cite> uses a BDSIM-generated quadrupole
with a perfect quadrupolar field in the beam pipe and vacuum and the field map for the yoke and surrounding
air in between the yoke and beam pipe. <cite>h1</cite> uses a BDSIM-generated horizontal kicker magnet and
BDSIM multipolar yoke field (the default) but with a custom field map for inside the vacuum only.
The field map is a 3D field map in BDSIM file format and uses cubic interpolation by default.</p>
<ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">field</span></code> objects are described below at: <a class="reference internal" href="#field-map-definition"><span class="std std-ref">Field Map Definition</span></a>.</p></li>
<li><p>Pure fields are described at: <a class="reference internal" href="#fields-pure-field-types"><span class="std std-ref">Pure Fields Types</span></a>.</p></li>
<li><p>Accepted file formats for a field object are described below at: <a class="reference internal" href="#field-map-file-formats"><span class="std std-ref">File Formats</span></a>.</p></li>
<li><p>Specific field map file format descriptions are described here: <a class="reference internal" href="dev_fields.html#field-map-formats"><span class="std std-ref">Field Map File Formats</span></a>.</p></li>
<li><p>Allowable different combinations of dimension are described here: <a class="reference internal" href="dev_fields.html#fields-different-dimensions"><span class="std std-ref">BDSIM Field Format Different Dimensions</span></a>.</p></li>
</ul>
<section id="field-general-notes">
<h3>Field General Notes<a class="headerlink" href="#field-general-notes" title="Link to this heading"></a></h3>
<p>Some notes on field maps in BDSIM:</p>
<ul class="simple">
<li><p>Fields are in a local Cartesian coordinate system with respect to the origin of the
element they are attached to.</p></li>
<li><p>The field may be attached to everything <strong>“fieldAll”</strong>; the vacuum volume <strong>“fieldVacuum”</strong>, or the
yoke <strong>“fieldOuter”</strong>.</p></li>
<li><p>Magnetic and electric field maps are specified in separate files and may have different interpolators.</p></li>
<li><p>Fields may have up to four dimensions.</p></li>
<li><p>The dimensions are (by default) in order <span class="math notranslate nohighlight">\(x,y,z,t\)</span>. For example, specifying a 3D field will be
<span class="math notranslate nohighlight">\(x,y,z\)</span> and a 2D field <span class="math notranslate nohighlight">\(x,y\)</span>.</p></li>
<li><p>Fields with different dimensions (e.g. <span class="math notranslate nohighlight">\(x,z\)</span> and constant <span class="math notranslate nohighlight">\(y\)</span>) can be used.</p></li>
<li><p>Cubic interpolation is used by default unless otherwise specified.</p></li>
<li><p>Geant4’s classical 4th order Runge Kutta is used as the default numerical integrator.</p></li>
</ul>
<p>For BDSIM format fields, the user can specify different dimension with the other dimensions
being assumed constant. For example, a field that varies in <span class="math notranslate nohighlight">\(x,z\)</span> is possible
(assumed constant in <span class="math notranslate nohighlight">\(y\)</span>). For BDSIM format fields, this is detected automatically by
the column labelling and the keys in the header of the file that specify the ranges in each
dimension. The dimensions must however be in ascending or descending order.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Currently only <strong>regular</strong> (evenly spaced) grids are supported with field maps. It would
require significant development to extend this to irregular grids. It’s strongly
recommended the user re-sample any existing field map into a regular grid. A regular
grid is also much faster for tracking purposes.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The maximum step length of a particle through an element is by default 10km in Geant4.
BDSIM reduces this to 110% the length of an element. In the case of a field map, the
step limit is not dynamically derived (in Geant4) from the variation in the field.
Too large a step may mean that the numerical integration along the step may not
‘see’ the variations in the field and therefore calculate the wrong motion. For
example, imagine a wiggler or undulator field map and only a few select points
along it’s length being queried - it may appear as a dipole field!
Therefore, when we use a field map in BDSIM, the step length is limited to the
minimum distance between points in any dimension of the field map. Depending on
how much the field map varies from point to point (density of samples) then the
user may wish to reduce this further with the parameter <code class="code docutils literal notranslate"><span class="pre">maximumStepLength</span></code>
below in the field definition. You may also wish to visualise the individual points
as described in <a class="reference internal" href="visualisation.html#visualisation-step-points"><span class="std std-ref">Visualising Step Points</span></a>.</p>
</div>
</section>
<section id="minimal-example">
<h3>Minimal Example<a class="headerlink" href="#minimal-example" title="Link to this heading"></a></h3>
<p>Here is a minimal example of a magnetic field in BDSIM format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">detfield</span><span class="p">:</span> <span class="n">field</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;bmap3d&quot;</span><span class="p">,</span>
                 <span class="n">magneticFile</span><span class="o">=</span><span class="s2">&quot;bdsim3d:fieldmap.dat.gz&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>This will use the “g4classicalrk4” integrator for the particle motion and the “cubic” (in 3D) interpolation
by default.</p>
<p>Here is example syntax to define a field object named ‘somefield’ in the parser and overlay it onto
a drift pipe where it covers the full volume of the drift (not outside it though):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">somefield</span><span class="p">:</span> <span class="n">field</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;ebmap2d&quot;</span><span class="p">,</span>
                  <span class="n">eScaling</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
                  <span class="n">bScaling</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span>
                  <span class="n">integrator</span> <span class="o">=</span> <span class="s2">&quot;g4classicalrk4&quot;</span><span class="p">,</span>
                  <span class="n">magneticFile</span> <span class="o">=</span> <span class="s2">&quot;poisson2d:/Path/To/File.TXT&quot;</span><span class="p">,</span>
                  <span class="n">magneticInterpolator</span> <span class="o">=</span> <span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
                  <span class="n">electricFile</span> <span class="o">=</span> <span class="s2">&quot;poisson2d:/Another/File.TXT&quot;</span><span class="p">,</span>
                  <span class="n">electricInterpolator</span> <span class="o">=</span> <span class="s2">&quot;linear&quot;</span><span class="p">;</span>

<span class="n">d1</span><span class="p">:</span> <span class="n">drift</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">aper1</span><span class="o">=</span><span class="mi">4</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span> <span class="n">fieldAll</span><span class="o">=</span><span class="s2">&quot;somefield&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>Each beam line element will allow “fieldAll”, “fieldVacuum” and “fieldOuter” to be specified.</p>
</section>
<section id="field-map-definition">
<span id="id2"></span><h3>Field Map Definition<a class="headerlink" href="#field-map-definition" title="Link to this heading"></a></h3>
<p>When defining a <code class="code docutils literal notranslate"><span class="pre">field</span></code> object, the following parameters can be specified. Usually,
only a small number of these possible parameters are needed. An example is given below.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Parameter</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>type</p></td>
<td><p>See type table below.</p></td>
</tr>
<tr class="row-odd"><td><p>eScaling</p></td>
<td><p>A numerical scaling factor that all electric field vectors’
amplitudes will be multiplied by</p></td>
</tr>
<tr class="row-even"><td><p>bScaling</p></td>
<td><p>A numerical scaling factor that all magnetic field vectors’
amplitudes will be multiplied by</p></td>
</tr>
<tr class="row-odd"><td><p>integrator</p></td>
<td><p>The integrator used to calculate the motion of the particle
in the field. See below for full list of supported integrators.</p></td>
</tr>
<tr class="row-even"><td><p>globalTransform</p></td>
<td><p>Boolean. Whether a transform from local curvilinear coordinates
to global coordinates should be provided (default true).</p></td>
</tr>
<tr class="row-odd"><td><p>magneticFile</p></td>
<td><p>“format:filePath” - see formats below.</p></td>
</tr>
<tr class="row-even"><td><p>magneticInterpolator</p></td>
<td><p>Which interpolator to use - see below for a full list.</p></td>
</tr>
<tr class="row-odd"><td><p>electricFile</p></td>
<td><p>“format:filePath” - see formats below.</p></td>
</tr>
<tr class="row-even"><td><p>electricInterpolator</p></td>
<td><p>Which interpolator to use - see below for a full list.</p></td>
</tr>
<tr class="row-odd"><td><p>magneticReflection</p></td>
<td><p>String of white-space separate relfection names to use.</p></td>
</tr>
<tr class="row-even"><td><p>electricReflection</p></td>
<td><p>String of white-space separate relfection names to use.</p></td>
</tr>
<tr class="row-odd"><td><p>fieldModulator</p></td>
<td><p>Name of modulator object to apply to the field definition.</p></td>
</tr>
<tr class="row-even"><td><p>x</p></td>
<td><p>x-offset from element it’s attached to</p></td>
</tr>
<tr class="row-odd"><td><p>y</p></td>
<td><p>y-offset from element it’s attached to</p></td>
</tr>
<tr class="row-even"><td><p>z</p></td>
<td><p>z-offset from element it’s attached to</p></td>
</tr>
<tr class="row-odd"><td><p>t</p></td>
<td><p>t-offset from <strong>Global</strong> t in seconds</p></td>
</tr>
<tr class="row-even"><td><p>phi</p></td>
<td><p>Euler phi rotation from the element the field is attached to</p></td>
</tr>
<tr class="row-odd"><td><p>theta</p></td>
<td><p>Euler theta rotation from the element the field is attached to</p></td>
</tr>
<tr class="row-even"><td><p>psi</p></td>
<td><p>Euler psi rotation from the element the field is attached to</p></td>
</tr>
<tr class="row-odd"><td><p>axisAngle</p></td>
<td><p>(Boolean) Use axis angle rotation variables. Default 0 (Euler).</p></td>
</tr>
<tr class="row-even"><td><p>axisX</p></td>
<td><p>x-component of axis defining axis / angle rotation</p></td>
</tr>
<tr class="row-odd"><td><p>axisY</p></td>
<td><p>y-component of axis defining axis / angle rotation</p></td>
</tr>
<tr class="row-even"><td><p>axisZ</p></td>
<td><p>z-component of axis defining axis / angle rotation</p></td>
</tr>
<tr class="row-odd"><td><p>angle</p></td>
<td><p>angle (rad) of defining axis / angle rotation</p></td>
</tr>
<tr class="row-even"><td><p>autoScale</p></td>
<td><p>This automatically calculates the field gradient at the origin
and the field magnitude will be automatically scaled according
to the normalised <cite>k</cite> strength (such as <cite>k1</cite> for a quadrupole)
for the magnet it’s attached to. Only applicable for when
attached to <cite>fieldOuter</cite> of aa magnet.</p></td>
</tr>
<tr class="row-odd"><td><p>maximumStepLength</p></td>
<td><p>The maximum permitted step length through the field. (m) No
length smaller than 1 micron is permitted currently.</p></td>
</tr>
<tr class="row-even"><td><p>electricSubField</p></td>
<td><p>Name of another field object like this one that will be used as
a electric ‘sub’ field that overlays this one.</p></td>
</tr>
<tr class="row-odd"><td><p>magneticSubField</p></td>
<td><p>Name of another field object like this one that will be used as
a magnetic ‘sub’ field that overlays this one.</p></td>
</tr>
<tr class="row-even"><td><p>fieldParameters</p></td>
<td><p>A string containing a white-space separated list of
<code class="code docutils literal notranslate"><span class="pre">parameter=value</span></code> when using a pure field type. See
<a class="reference internal" href="#fields-pure-field-types"><span class="std std-ref">Pure Fields Types</span></a>.</p></td>
</tr>
<tr class="row-odd"><td><p>frequency</p></td>
<td><p>Frequency (Hz) of the time-varying modulation of the field .</p></td>
</tr>
<tr class="row-even"><td><p>phase</p></td>
<td><p>Phase offset (rad) of the time-dependent modulation. It is
connected to tOffset and can be converted into it.</p></td>
</tr>
<tr class="row-odd"><td><p>tOffset</p></td>
<td><p><strong>Global</strong> time offset (s) of the time-dependent modulation.
It is internally translated into the phase offset.</p></td>
</tr>
<tr class="row-even"><td><p>modulator</p></td>
<td><p>Function that describes the time-variation of the field.
Currently, sin/SIN/Sin and cos/COS/Cos can be used.</p></td>
</tr>
</tbody>
</table>
<p>Advanced parameter to be used with caution:</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>maximumStepLengthOverride</p></td>
<td><p>Maximum step length (m) in the field that will override the
length calcualted from the minimal field map grid spacing.
This overrides <cite>maximumStepLength</cite> and the one calculated.</p></td>
</tr>
</tbody>
</table>
<p>Simple example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">detectorField</span><span class="p">:</span> <span class="n">field</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;bmap2d&quot;</span><span class="p">,</span>
                      <span class="n">magneticFile</span><span class="o">=</span><span class="s2">&quot;bdsim2d:fieldmap.dat&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>This will use a BDSIM format magnetic (only) field map. By default it will have cubic
interpolation and use a 4th order Runge Kutta integrator.</p>
<p>The maximum step length will be the <strong>minimum</strong> of:</p>
<ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">maximumStepLength</span></code> specified in the field definition</p></li>
<li><p>110% of the element length that the field is attached to</p></li>
<li><p>the global maximum step length</p></li>
<li><p>the minimum spacing in any dimension of the field map</p></li>
</ul>
<p>In the case of a 4D field, the velocity is assume to be <code class="code docutils literal notranslate"><span class="pre">c</span></code>, the speed of light,
for the spatial distance calculated from this.</p>
<p>Notes:</p>
<ul class="simple">
<li><p>See <a class="reference internal" href="#fields-sub-fields"><span class="std std-ref">Sub-Fields</span></a> below for more details on overlaying two field maps in one.</p></li>
<li><p>Either axis angle (with unit axis 3-vector) or Euler angles can be used to provide
the rotation between the element the field maps are attached to and the coordinates
of the field map. Use <cite>axisAngle=1</cite> to use the axis angle rotation scheme.</p></li>
<li><p>A right-handed coordinate system is used in Geant4, so positive x is out of a ring.</p></li>
<li><p>The time-modulation of the fields is off by default. It is implemented for field maps
(E, B and EM) in up to all three spatial dimensions. It is not necessary to define both,
phase and tOffset, as they have the same physical meaning. The modulation is calculated
according to <span class="math notranslate nohighlight">\(\sin(2\pi ft-\varphi)\)</span> or <span class="math notranslate nohighlight">\(\cos(2\pi ft-\varphi)\)</span> with <span class="math notranslate nohighlight">\(f\)</span>
being the frequency of the modulation, <span class="math notranslate nohighlight">\(t\)</span> the global time of the particle and
<span class="math notranslate nohighlight">\(\varphi\)</span> the shift wrt. the beginning of the oscillation.</p></li>
</ul>
<section id="autoscaling">
<h4>AutoScaling<a class="headerlink" href="#autoscaling" title="Link to this heading"></a></h4>
<p>BDSIM includes a feature called “autoScale” that allows the gradient to be calculated of a field
map when attached to the yoke of a magnet. The field map is then scaled by the required factor to
match the (normalised) strength of the magnet, e.g. <cite>k1</cite> for a quadrupole.</p>
<p>This only works when <cite>autoScale=1</cite> is used in the field definition and when the field is specified
for the <cite>fieldOuter</cite> parameter of a magnet such as a quadrupole, sextupole, or octupole.</p>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f1</span><span class="p">:</span> <span class="n">field</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;bmap2d&quot;</span><span class="p">,</span> <span class="n">magnetifFile</span><span class="o">=</span><span class="s2">&quot;bdsim:fieldmap.dat&quot;</span><span class="p">;</span>
<span class="n">q1</span><span class="p">:</span> <span class="n">quadrupole</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mf">2.99</span><span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">fieldOuter</span><span class="o">=</span><span class="s2">&quot;f1&quot;</span><span class="p">,</span> <span class="n">k1</span><span class="o">=-</span><span class="mf">0.03571027562065992</span><span class="p">;</span>
</pre></div>
</div>
<p>Example print out when running BDSIM would be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BDSIM</span> <span class="n">Field</span> <span class="n">Format</span><span class="o">&gt;</span> <span class="n">Loading</span> <span class="s2">&quot;/Users/lnevay/Desktop/gradient/QNRX0610005_-192.59A.map&quot;</span>
<span class="n">BDSIM</span> <span class="n">Field</span> <span class="n">Format</span><span class="o">&gt;</span> <span class="n">Loaded</span> <span class="mi">2099</span> <span class="n">lines</span> <span class="kn">from</span> <span class="nn">file</span>
<span class="n">BDSIM</span> <span class="n">Field</span> <span class="n">Format</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">Min</span> <span class="o">|</span> <span class="n">Max</span><span class="p">)</span> <span class="n">field</span> <span class="n">magnitudes</span> <span class="ow">in</span> <span class="n">loaded</span> <span class="n">file</span> <span class="p">(</span><span class="n">before</span> <span class="n">scaling</span><span class="p">):</span> <span class="p">(</span><span class="mi">0</span> <span class="o">|</span> <span class="mf">4.12849187851</span><span class="p">)</span>
<span class="n">autoScale</span><span class="o">&gt;</span> <span class="n">Calculated</span> <span class="n">k1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.0430970787713</span>
<span class="n">autoScale</span><span class="o">&gt;</span> <span class="n">Ratio</span> <span class="n">of</span> <span class="n">supplied</span> <span class="n">strength</span> <span class="n">to</span> <span class="n">calculated</span> <span class="nb">map</span> <span class="n">strength</span><span class="p">:</span> <span class="mf">0.828600838822</span>
<span class="n">autoScale</span><span class="o">&gt;</span> <span class="n">New</span> <span class="n">overall</span> <span class="n">scaling</span> <span class="n">factor</span><span class="p">:</span> <span class="mf">0.828600838822</span>
</pre></div>
</div>
</section>
<section id="field-types">
<h4>Field Types<a class="headerlink" href="#field-types" title="Link to this heading"></a></h4>
<ul class="simple">
<li><p>These are not case sensitive.</p></li>
</ul>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Type String</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>bmap1d</p></td>
<td><p>1D magnetic only field map</p></td>
</tr>
<tr class="row-odd"><td><p>bmap2d</p></td>
<td><p>2D magnetic only field map</p></td>
</tr>
<tr class="row-even"><td><p>bmap3d</p></td>
<td><p>3D magnetic only field map</p></td>
</tr>
<tr class="row-odd"><td><p>bmap4d</p></td>
<td><p>4D magnetic only field map</p></td>
</tr>
<tr class="row-even"><td><p>emap1d</p></td>
<td><p>1D electric only field map</p></td>
</tr>
<tr class="row-odd"><td><p>emap2d</p></td>
<td><p>2D electric only field map</p></td>
</tr>
<tr class="row-even"><td><p>emap3d</p></td>
<td><p>3D electric only field map</p></td>
</tr>
<tr class="row-odd"><td><p>emap4d</p></td>
<td><p>4D electric only field map</p></td>
</tr>
<tr class="row-even"><td><p>ebmap1d</p></td>
<td><p>1D electric-magnetic field map</p></td>
</tr>
<tr class="row-odd"><td><p>ebmap2d</p></td>
<td><p>2D electric-magnetic field map</p></td>
</tr>
<tr class="row-even"><td><p>ebmap3d</p></td>
<td><p>3D electric-magnetic field map</p></td>
</tr>
<tr class="row-odd"><td><p>ebmap4d</p></td>
<td><p>4D electric-magnetic field map</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Some “pure” fields can be used also. Their names for the “type” are listed
in <a class="reference internal" href="dev_fields.html#dev-fields-pure-field-names"><span class="std std-ref">Field Names and Parameters</span></a>.</p>
</div>
</section>
<section id="pure-fields-types">
<span id="fields-pure-field-types"></span><h4>Pure Fields Types<a class="headerlink" href="#pure-fields-types" title="Link to this heading"></a></h4>
<p>“Pure” fields are ones that are described by equations in BDSIM. These are used
for all the generic accelerator components. Note, we may use custom numerical
integrators for tracking in accelerator components that <em>ignore</em> the field
that is required to be there for Geant4. However, these integrators often <em>fall-back</em>
to this field when tracking a particle in a direction they can’t handle.</p>
<p>The pure fields can be used as a field object in BDSIM. The <code class="code docutils literal notranslate"><span class="pre">type</span></code> in the
field definition must be exactly one of the internal names used for the field name.</p>
<ul class="simple">
<li><p>See field types here: <a class="reference internal" href="dev_fields.html#dev-fields-pure-field-names"><span class="std std-ref">Field Names and Parameters</span></a>.</p></li>
<li><p>No units or commas may be used inside the <code class="code docutils literal notranslate"><span class="pre">fieldParameters</span></code> string.</p></li>
<li><p>The <code class="code docutils literal notranslate"><span class="pre">fieldParameters</span></code> string should have parameter=value pairs white-space separated.</p></li>
<li><p>Normalised field strengths are used with respect to the beam particle and design energy.</p></li>
</ul>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f1</span><span class="p">:</span> <span class="n">field</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;dipole&quot;</span><span class="p">,</span> <span class="n">fieldParameters</span><span class="o">=</span><span class="s2">&quot;field=1.2 by=1.0&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>For a dipole field with value 1.2 T and along the unit Y axis (local). The other
components of the unit vector associated with it will default to 0.</p>
</section>
<section id="field-reflections-and-transforms">
<span id="fields-transforms"></span><h4>Field Reflections and Transforms<a class="headerlink" href="#field-reflections-and-transforms" title="Link to this heading"></a></h4>
<p>It is possible to exploit symmetry in a field map and use a field map with only
some fraction of the complete expected map. This speeds up start up time as there
is less to load and saves memory at run-time as there is less to store in memory.</p>
<p>Several operations are available and may be combined arbitrarily. These are specified
in the field definition in either <code class="code docutils literal notranslate"><span class="pre">magneticReflection</span></code> or <code class="code docutils literal notranslate"><span class="pre">electricReflection</span></code>.</p>
<ul class="simple">
<li><p>The reflection string must be a white-space separated list (if more than one) of
the below names.</p></li>
<li><p>For arrays to be reflected it is recommended that they run from 0 in that dimension
in a positive direction. e.g. a 1D map in <span class="math notranslate nohighlight">\(z\)</span> to be reflected would ideally
run from <span class="math notranslate nohighlight">\(z = 0 cm\)</span> to for example, <span class="math notranslate nohighlight">\(z = 20 cm\)</span>, i.e. a positive value.
However, the code will tolerate it going in a positive direction but from a negative
value towards 0.</p></li>
<li><p>The values exactly on the axis of reflection come from the original field map.</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Any partial field map used for a reflection must either have its
first data point on the axis of reflection or an integer number
of array steps from it. e.g. A 1D array in z to be reflected
runs from 0 cm to 20 cm - this OK. Another array in z runs from 1 cm
to 21 cm with 5 points - this is not OK. This is because the step size
is (21-1 / 5 = 4 cm). The distance from the reflection axis is 1 cm.
This would cause an irregularly spaced grid which there is no provision
for in BDSIM for interpolation. The tolerance for this calculation is
5% of the step size. The code will proceed, but the map may be
distorted at the boundaries.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is strongly recommended to visualise a reflected  (or indeed any) field map
before using it for a physics study to ensure it is correctly prepared. See
<a class="reference internal" href="#field-map-validation"><span class="std std-ref">Field Map Validation</span></a> and <a class="reference internal" href="#fields-visualisation-queries"><span class="std std-ref">Field Map Visualisation - Queries</span></a>.</p>
</div>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Reflection Name</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>flipx</p></td>
<td><p><span class="math notranslate nohighlight">\(\pm x \mapsto \mp x\)</span></p></td>
</tr>
<tr class="row-odd"><td><p>flipy</p></td>
<td><p><span class="math notranslate nohighlight">\(\pm y \mapsto \mp y\)</span></p></td>
</tr>
<tr class="row-even"><td><p>flipz</p></td>
<td><p><span class="math notranslate nohighlight">\(\pm z \mapsto \mp z\)</span></p></td>
</tr>
<tr class="row-odd"><td><p>flipt</p></td>
<td><p><span class="math notranslate nohighlight">\(\pm t \mapsto \mp t\)</span></p></td>
</tr>
<tr class="row-even"><td><p>reflectx</p></td>
<td><p><span class="math notranslate nohighlight">\(x \mapsto |x|\)</span></p></td>
</tr>
<tr class="row-odd"><td><p>reflecty</p></td>
<td><p><span class="math notranslate nohighlight">\(y \mapsto |y|\)</span></p></td>
</tr>
<tr class="row-even"><td><p>reflectz</p></td>
<td><p><span class="math notranslate nohighlight">\(z \mapsto |z|\)</span></p></td>
</tr>
<tr class="row-odd"><td><p>reflectt</p></td>
<td><p><span class="math notranslate nohighlight">\(t \mapsto |t|\)</span></p></td>
</tr>
<tr class="row-even"><td><p>reflectxydipole (*)</p></td>
<td><p>Reflect a positive x and y quadrant to
all four quadrants with appropriate
flips to make a dipolar field</p></td>
</tr>
<tr class="row-odd"><td><p>reflectxzdipole (*)</p></td>
<td><p>Reflect a dipole field about the x-z
plane but don’t reflect the y component
of the field to make a dipolar field</p></td>
</tr>
<tr class="row-even"><td><p>reflectyzdipole</p></td>
<td><p>equivalent to <cite>reflectx</cite></p></td>
</tr>
<tr class="row-odd"><td><p>reflectzsolenoid</p></td>
<td><p>Reflect about <span class="math notranslate nohighlight">\(z = 0\)</span>. Also, for
<span class="math notranslate nohighlight">\(z &lt; 0\)</span>, flip the x and y
components of the field</p></td>
</tr>
<tr class="row-even"><td><p>reflectxyquadrupole</p></td>
<td><p>Reflect a positive x and y quadrant to
all four quadrants with appropriate
flips to make a quadrupolar field</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>(*) See pictorial representation below</p></li>
</ul>
<p>For <code class="code docutils literal notranslate"><span class="pre">reflectxydipole</span></code>, <span class="math notranslate nohighlight">\(x \mapsto |x|\)</span> and <span class="math notranslate nohighlight">\(y \mapsto |y|\)</span>
for the array look up. Then the value found at that location if changed as follows:</p>
<ul class="simple">
<li><p>if <span class="math notranslate nohighlight">\(x &lt; 0 \wedge y \geqslant 0\)</span>, <span class="math notranslate nohighlight">\(B_x \mapsto -B_x\)</span></p></li>
<li><p>if <span class="math notranslate nohighlight">\(x \geqslant 0 \wedge y &lt; 0\)</span>, <span class="math notranslate nohighlight">\(B_x \mapsto -B_x\)</span></p></li>
<li><p>if <span class="math notranslate nohighlight">\(y &lt; 0\)</span>, <span class="math notranslate nohighlight">\(B_z \mapsto -B_z\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\wedge\)</span> is logical AND</p></li>
</ul>
<p>For <code class="code docutils literal notranslate"><span class="pre">reflectxzdipole</span></code>, <span class="math notranslate nohighlight">\(y \mapsto |y|\)</span> for the array look up. Then
the value found at that location if changed as follows:</p>
<ul class="simple">
<li><p>if <span class="math notranslate nohighlight">\(y &lt; 0\)</span>, <span class="math notranslate nohighlight">\(B_x \mapsto -B_x\)</span></p></li>
</ul>
<p>For <code class="code docutils literal notranslate"><span class="pre">reflectxzsolenoid</span></code>, <span class="math notranslate nohighlight">\(z \mapsto |z|\)</span> for the array look up. Then
the value found at that location if changed as follows:</p>
<ul class="simple">
<li><p>if <span class="math notranslate nohighlight">\(z &lt; 0\)</span>, <span class="math notranslate nohighlight">\(B_x \mapsto -B_x\)</span></p></li>
<li><p>if <span class="math notranslate nohighlight">\(z &lt; 0\)</span>, <span class="math notranslate nohighlight">\(B_y \mapsto -B_y\)</span></p></li>
</ul>
<p>For <code class="code docutils literal notranslate"><span class="pre">reflectxyquadrupole</span></code>, <span class="math notranslate nohighlight">\(x \mapsto |x|\)</span> and <span class="math notranslate nohighlight">\(y \mapsto |y|\)</span>
for the array look up. Then the value found at that location if changed as follows:</p>
<ul class="simple">
<li><p>if <span class="math notranslate nohighlight">\(x &lt; 0\)</span>, <span class="math notranslate nohighlight">\(B_y \mapsto -B_y\)</span></p></li>
<li><p>if <span class="math notranslate nohighlight">\(y &lt; 0\)</span>, <span class="math notranslate nohighlight">\(B_x \mapsto -B_x\)</span></p></li>
</ul>
<p>This logic would also be applicable for a dual beam accelerator dipole
such as the LHC dipole magnets where the dipole fields in each pipe have
opposite directions to bend the counter-circulating beams.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">magneticReflection</span><span class="o">=</span><span class="s2">&quot;flipx&quot;</span><span class="p">;</span>
<span class="n">magneticReflection</span><span class="o">=</span><span class="s2">&quot;flipx flipy&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>There are many practical examples in <code class="code docutils literal notranslate"><span class="pre">bdsim/examples/features/fields/maps_transformed/*.gmad</span></code>
where the example field maps are generated by querying a standard BDSIM component. In the case
of a dipole field, typically, a hkicker is used as the magnet is built without an angle to
simplify things.</p>
<p><strong>reflectxydipole</strong></p>
<figure class="align-center" id="id21">
<a class="reference internal image-reference" href="_images/reflectxydipole.jpg"><img alt="_images/reflectxydipole.jpg" src="_images/reflectxydipole.jpg" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text">Original dipole field from positive x-y quadrant (<em>left</em>), reflected using
<code class="code docutils literal notranslate"><span class="pre">reflectxydipole</span></code> (<em>right</em>). The view is with the z axis going into
the page and the the coordinate system is right-handed.</span><a class="headerlink" href="#id21" title="Link to this image"></a></p>
</figcaption>
</figure>
<p><strong>reflectxzdipole</strong></p>
<figure class="align-center" id="id22">
<a class="reference internal image-reference" href="_images/reflectxzdipole.jpg"><img alt="_images/reflectxzdipole.jpg" src="_images/reflectxzdipole.jpg" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text">Original dipole field from positive y half (<em>left</em>), reflected using
<code class="code docutils literal notranslate"><span class="pre">reflectxzdipole</span></code> (<em>right</em>).</span><a class="headerlink" href="#id22" title="Link to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="modulators">
<span id="field-modulators"></span><h4>Modulators<a class="headerlink" href="#modulators" title="Link to this heading"></a></h4>
<p>It is possible to scale or ‘modulate’ the field of any component in bdsim using a
“modulator” object. This conceptually can be a function of time, event number and
turn number for example. Only certain functions are provided but more can be added
easily by the developers if required - see <a class="reference internal" href="support.html#feature-request"><span class="std std-ref">Feature Request</span></a>.</p>
<ul class="simple">
<li><p>Whatever magnetic or electric field would be provided by the original field object
is multiplied by the (scalar) numerical factor from the modulator.</p></li>
</ul>
<p>A modulator is defined in the in put as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">objectname</span><span class="p">:</span> <span class="n">modulator</span><span class="p">,</span> <span class="n">parameter1</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">value</span><span class="p">,</span><span class="o">...</span> <span class="p">;</span>
</pre></div>
</div>
<p>The modulator is then ‘attahced’ to the beam line element in its definition:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">m1</span><span class="p">:</span> <span class="n">modulator</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;sint&quot;</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="mi">1</span><span class="o">*</span><span class="n">kHz</span><span class="p">,</span> <span class="n">amplitudeOffset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="n">rf1</span><span class="p">:</span> <span class="n">rfcavity</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">1</span><span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="mi">450</span><span class="o">*</span><span class="n">MHz</span><span class="p">,</span> <span class="n">fieldModulator</span><span class="o">=</span><span class="s2">&quot;m1&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>The function is described by the <code class="code docutils literal notranslate"><span class="pre">type</span></code> parameter which can be one of the following:</p>
<ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">sint</span></code> - sinusoid as a function of (local) time</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">singlobal</span></code> - sinusoid as a function of (global) time with no synchronous offset in time</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">tophatt</span></code> - a top hat function as a function of time</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">lineart</span></code> - similar to top hat but function depends linearly on time</p></li>
</ul>
<p>Each is described below.</p>
<p><strong>sint</strong></p>
<p>A sinusoidal modulator as a function of time T of the particle. The factor is
described by the equation:</p>
<div class="math notranslate nohighlight">
\[factor = \text{amplitudeOffset} + \text{amplitudeScale} * \sin (2 \pi f t + \phi)\]</div>
<p>The oscillator will by default have a zero phase that is synchronous with the centre
of the object it’s attached to in the beam line.</p>
<ul class="simple">
<li><p><cite>tOffset</cite> will take precedence over <cite>phase</cite></p></li>
</ul>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Parameter</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
<th class="head"><p><strong>Required</strong></p></th>
<th class="head"><p><strong>Default</strong></p></th>
<th class="head"><p><strong>Units</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><cite>amplitudeOffset</cite></p></td>
<td><p>Offset of numerical factor</p></td>
<td><p>No</p></td>
<td><p>0</p></td>
<td><p>None</p></td>
</tr>
<tr class="row-odd"><td><p><cite>amplitudeScale</cite></p></td>
<td><p>Multiplier of scale</p></td>
<td><p>No</p></td>
<td><p>1</p></td>
<td><p>None</p></td>
</tr>
<tr class="row-even"><td><p><cite>frequency</cite></p></td>
<td><p>Frequency of oscillator in (&gt;= 0)</p></td>
<td><p>Yes</p></td>
<td><p>0</p></td>
<td><p>Hz</p></td>
</tr>
<tr class="row-odd"><td><p><cite>phase</cite></p></td>
<td><p>Phase relative to synchronous phase</p></td>
<td><p>No</p></td>
<td><p>0</p></td>
<td><p>rad</p></td>
</tr>
<tr class="row-even"><td><p><cite>tOffset</cite></p></td>
<td><p>Optional time to use in place of phase</p></td>
<td><p>No</p></td>
<td><p>0</p></td>
<td><p>s</p></td>
</tr>
</tbody>
</table>
<p><strong>singlobalt</strong></p>
<p>This has the same equation as <cite>sint</cite>, however, no synchronous offset is added to the phase.
So, if one instance of this modulator is used on several elements, they will all oscillate
at the same time with the same phase, so a beam particle may see a different effect as it
passes each element.</p>
<ul class="simple">
<li><p>The same parameters as <cite>sint</cite> apply.</p></li>
<li><p><cite>phase</cite> takes precedence over <cite>offsetT</cite>.</p></li>
</ul>
<p><strong>tophatt</strong></p>
<p>A function that is on at a constant value inside a time window and 0 everywhere else in time.
It is described by the equation:</p>
<div class="math notranslate nohighlight">
\[\begin{split}factor &amp;= \textrm{amplitudeScale} \quad \textrm{if} \quad T0 &lt;= T &lt;= T1 \\
factor &amp;= 0 \quad \textrm{otherwise} \\\end{split}\]</div>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Parameter</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
<th class="head"><p><strong>Required</strong></p></th>
<th class="head"><p><strong>Default</strong></p></th>
<th class="head"><p><strong>Units</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><cite>T0</cite></p></td>
<td><p>Global starting time for ‘on’</p></td>
<td><p>Yes</p></td>
<td><p>0</p></td>
<td><p>s</p></td>
</tr>
<tr class="row-odd"><td><p><cite>T1</cite></p></td>
<td><p>Global time for ‘off’</p></td>
<td><p>Yes</p></td>
<td><p>0</p></td>
<td><p>s</p></td>
</tr>
<tr class="row-even"><td><p><cite>amplitudeScale</cite></p></td>
<td><p>Multiplier of scale</p></td>
<td><p>No</p></td>
<td><p>1</p></td>
<td><p>None</p></td>
</tr>
</tbody>
</table>
<p><strong>lineart</strong></p>
<p>A function that depends linearly on time inside a time window and is 0 everywhere else in time.
It is described by the equation:</p>
<div class="math notranslate nohighlight">
\[\begin{split}factor &amp;= \textrm{amplitudeScale} * t + \textrm{amplitudeOffset} \quad \textrm{if} \quad T0 &lt;= T &lt;= T1 \\
factor &amp;= 0 \quad \textrm{otherwise} \\\end{split}\]</div>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Parameter</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
<th class="head"><p><strong>Required</strong></p></th>
<th class="head"><p><strong>Default</strong></p></th>
<th class="head"><p><strong>Units</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><cite>T0</cite></p></td>
<td><p>Global starting time for ‘on’</p></td>
<td><p>Yes</p></td>
<td><p>0</p></td>
<td><p>s</p></td>
</tr>
<tr class="row-odd"><td><p><cite>T1</cite></p></td>
<td><p>Global time for ‘off’</p></td>
<td><p>Yes</p></td>
<td><p>0</p></td>
<td><p>s</p></td>
</tr>
<tr class="row-even"><td><p><cite>amplitudeScale</cite></p></td>
<td><p>Multiplier of scale</p></td>
<td><p>No</p></td>
<td><p>0</p></td>
<td><p>1/s</p></td>
</tr>
<tr class="row-odd"><td><p><cite>amplitudeOffset</cite></p></td>
<td><p>Offset of numerical factor</p></td>
<td><p>No</p></td>
<td><p>1</p></td>
<td><p>None</p></td>
</tr>
</tbody>
</table>
</section>
<section id="integrators">
<h4>Integrators<a class="headerlink" href="#integrators" title="Link to this heading"></a></h4>
<p>An integrator is an algorithm that calculates the particle motion in a field. There
are many algorithms - some fast, some more precise, some work only with certain fields.</p>
<p>The following integrators are provided.  The majority are interfaces to Geant4 integrators.
<em>g4classicalrk4</em> is typically the recommended default and is very robust.
<em>g4cashkarprkf45</em> is similar but slightly less CPU-intensive. For version Geant4.10.4
onwards, <em>g4dormandprince745</em> is the default recommended by Geant4 (although not the
BDSIM default currently). Note: any integrator capable of operating on EM fields
will work on solely B- or E-fields.</p>
<p>We recommend looking at the source .hh files in the Geant4 source code for an
explanation of each, as this is where they are documented. The source files can
be found in <cite>&lt;geant4-source-dir&gt;/source/geometry/magneticfield/include</cite>.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>String</strong></p></th>
<th class="head"><p><strong>B/EM</strong></p></th>
<th class="head"><p><strong>Time Varying</strong></p></th>
<th class="head"><p>Required Geant4 Version (&gt;)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>g4cashkarprkf45</p></td>
<td><p>EM</p></td>
<td><p>Y</p></td>
<td><p>10.0</p></td>
</tr>
<tr class="row-odd"><td><p>g4classicalrk4</p></td>
<td><p>EM</p></td>
<td><p>Y</p></td>
<td><p>10.0</p></td>
</tr>
<tr class="row-even"><td><p>g4constrk4</p></td>
<td><p>B</p></td>
<td><p>N</p></td>
<td><p>10.0</p></td>
</tr>
<tr class="row-odd"><td><p>g4expliciteuler</p></td>
<td><p>EM</p></td>
<td><p>Y</p></td>
<td><p>10.0</p></td>
</tr>
<tr class="row-even"><td><p>g4impliciteuler</p></td>
<td><p>EM</p></td>
<td><p>Y</p></td>
<td><p>10.0</p></td>
</tr>
<tr class="row-odd"><td><p>g4simpleheum</p></td>
<td><p>EM</p></td>
<td><p>Y</p></td>
<td><p>10.0</p></td>
</tr>
<tr class="row-even"><td><p>g4simplerunge</p></td>
<td><p>EM</p></td>
<td><p>Y</p></td>
<td><p>10.0</p></td>
</tr>
<tr class="row-odd"><td><p>g4exacthelixstepper</p></td>
<td><p>B</p></td>
<td><p>N</p></td>
<td><p>10.0</p></td>
</tr>
<tr class="row-even"><td><p>g4helixexpliciteuler</p></td>
<td><p>B</p></td>
<td><p>N</p></td>
<td><p>10.0</p></td>
</tr>
<tr class="row-odd"><td><p>g4helixheum</p></td>
<td><p>B</p></td>
<td><p>N</p></td>
<td><p>10.0</p></td>
</tr>
<tr class="row-even"><td><p>g4heliximpliciteuler</p></td>
<td><p>B</p></td>
<td><p>N</p></td>
<td><p>10.0</p></td>
</tr>
<tr class="row-odd"><td><p>g4helixmixedstepper</p></td>
<td><p>B</p></td>
<td><p>N</p></td>
<td><p>10.0</p></td>
</tr>
<tr class="row-even"><td><p>g4helixsimplerunge</p></td>
<td><p>B</p></td>
<td><p>N</p></td>
<td><p>10.0</p></td>
</tr>
<tr class="row-odd"><td><p>g4nystromrk4</p></td>
<td><p>B</p></td>
<td><p>N</p></td>
<td><p>10.0</p></td>
</tr>
<tr class="row-even"><td><p>g4rkg3stepper</p></td>
<td><p>B</p></td>
<td><p>N</p></td>
<td><p>10.0</p></td>
</tr>
<tr class="row-odd"><td><p>g4bogackishampine23</p></td>
<td><p>EM</p></td>
<td><p>Y</p></td>
<td><p>10.3</p></td>
</tr>
<tr class="row-even"><td><p>g4bogackishampine45</p></td>
<td><p>EM</p></td>
<td><p>Y</p></td>
<td><p>10.3</p></td>
</tr>
<tr class="row-odd"><td><p>g4dolomcprik34</p></td>
<td><p>EM</p></td>
<td><p>Y</p></td>
<td><p>10.3</p></td>
</tr>
<tr class="row-even"><td><p>g4dormandprince745</p></td>
<td><p>EM</p></td>
<td><p>Y</p></td>
<td><p>10.3</p></td>
</tr>
<tr class="row-odd"><td><p>g4dormandprincerk56</p></td>
<td><p>EM</p></td>
<td><p>Y</p></td>
<td><p>10.3</p></td>
</tr>
<tr class="row-even"><td><p>g4dormandprincerk78</p></td>
<td><p>EM</p></td>
<td><p>Y</p></td>
<td><p>10.3</p></td>
</tr>
<tr class="row-odd"><td><p>g4tsitourasrk45</p></td>
<td><p>EM</p></td>
<td><p>Y</p></td>
<td><p>10.3</p></td>
</tr>
<tr class="row-even"><td><p>g4rk547feq1</p></td>
<td><p>EM</p></td>
<td><p>Y</p></td>
<td><p>10.4</p></td>
</tr>
<tr class="row-odd"><td><p>g4rk547feq2</p></td>
<td><p>EM</p></td>
<td><p>Y</p></td>
<td><p>10.4</p></td>
</tr>
<tr class="row-even"><td><p>g4rk547feq3</p></td>
<td><p>EM</p></td>
<td><p>Y</p></td>
<td><p>10.4</p></td>
</tr>
</tbody>
</table>
</section>
<section id="interpolators">
<h4>Interpolators<a class="headerlink" href="#interpolators" title="Link to this heading"></a></h4>
<p>The field may be queried at any point inside the volume, so an interpolator is required
to provide a value of the field in between specified points in the field map.
There are many algorithms that can be used to interpolate the field map data. A
mathematical description of the ones provided in BDSIM as well as example plots
is shown in <a class="reference internal" href="dev_fields.html#field-interpolators"><span class="std std-ref">Field Map Interpolators</span></a>.</p>
<ul class="simple">
<li><p>This string is case-insensitive.</p></li>
</ul>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>String</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>nearest</p></td>
<td><p>Nearest neighbour interpolation</p></td>
</tr>
<tr class="row-odd"><td><p>linear</p></td>
<td><p>Linear interpolation</p></td>
</tr>
<tr class="row-even"><td><p>cubic</p></td>
<td><p>Cubic interpolation</p></td>
</tr>
<tr class="row-odd"><td><p>linearmag</p></td>
<td><p>Linear and magnitude interpolation</p></td>
</tr>
</tbody>
</table>
<p>Internally there is a different implementation for different numbers of dimensions and this
is automatically chosen based on the number of dimensions in the field map type.</p>
</section>
</section>
<section id="file-formats">
<span id="field-map-file-formats"></span><h3>File Formats<a class="headerlink" href="#file-formats" title="Link to this heading"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>BDSIM field maps by default have units <span class="math notranslate nohighlight">\(cm,s\)</span> and <span class="math notranslate nohighlight">\(T\)</span> for magnetic
field and <span class="math notranslate nohighlight">\(V/m\)</span> for electric field.</p>
</div>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Format</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>bdsim1d</p></td>
<td><p>1D BDSIM format file  (Units <span class="math notranslate nohighlight">\(cm, s, T, V\m\)</span>)</p></td>
</tr>
<tr class="row-odd"><td><p>bdsim2d</p></td>
<td><p>2D BDSIM format file  (Units <span class="math notranslate nohighlight">\(cm, s, T, V\m\)</span>)</p></td>
</tr>
<tr class="row-even"><td><p>bdsim3d</p></td>
<td><p>3D BDSIM format file  (Units <span class="math notranslate nohighlight">\(cm, s, T, V\m\)</span>)</p></td>
</tr>
<tr class="row-odd"><td><p>bdsim4d</p></td>
<td><p>4D BDSIM format file  (Units <span class="math notranslate nohighlight">\(cm, s, T, V\m\)</span>)</p></td>
</tr>
<tr class="row-even"><td><p>poisson2d</p></td>
<td><p>2D Poisson Superfish SF7 file</p></td>
</tr>
<tr class="row-odd"><td><p>poisson2dquad</p></td>
<td><p>2D Poisson Superfish SF7 file
for 1/8th of quadrupole</p></td>
</tr>
<tr class="row-even"><td><p>poisson2ddipole</p></td>
<td><p>2D Poisson Superfish SF7 file for positive
quadrant that’s reflected to produce a
full windowed dipole field</p></td>
</tr>
</tbody>
</table>
<p>Field maps in the following formats are accepted:</p>
<blockquote>
<div><ul class="simple">
<li><p>BDSIM’s own format (both uncompressed <code class="code docutils literal notranslate"><span class="pre">.dat</span></code> and gzip compressed files. <code class="code docutils literal notranslate"><span class="pre">gz</span></code> must be
in the file name for this to load correctly.)</p></li>
<li><p>Superfish Poisson 2D SF7</p></li>
</ul>
</div></blockquote>
<p>These are described in detail below. More field formats can be added
relatively easily - see <a class="reference internal" href="support.html#feature-request"><span class="std std-ref">Feature Request</span></a>. A detailed description
of the formats is given in <a class="reference internal" href="dev_fields.html#field-map-formats"><span class="std std-ref">Field Map File Formats</span></a>. A preparation guide
for BDSIM format files is provided here <a class="reference internal" href="dev_fields.html#field-map-file-preparation"><span class="std std-ref">BDSIM Field Map File Preparation</span></a>.</p>
</section>
<section id="sub-fields">
<span id="fields-sub-fields"></span><h3>Sub-Fields<a class="headerlink" href="#sub-fields" title="Link to this heading"></a></h3>
<p>A ‘sub-field’ is where one field map can be overlaid on top of another. The sub-field should be smaller
and will simply take precedence on the main field within its range. This is useful if for example a
precise field detailed field map is required for a smaller region but a coarser field map is suitable
for the majority of the component. Remember, field maps must contain regularly spaced data so if a high
density of points is required in one point, this would lead to an excessively large field map for the rest
of the element which may not be necessary and slow the loading and running of the simulation.</p>
<p>Inside the domain of the sub-field, only its interpolated value is used. The transition between the sub
and main field is hard and it is left to the user to ensure that the field values are continuous to
make physical sense.</p>
<ul class="simple">
<li><p>Currently only sub-magnetic and sub-electric fields are supported (no sub-electromagnetic fields).</p></li>
<li><p>The tilt or rotation of the field map (with respect to the element it is attached to) does not
apply to the region of applicability for the sub-field. However, the field is tilted appropriately.</p></li>
<li><p>The spatial (only) offset (x,y,z) of the sub-field applies to it independently of the offset of the
main outer field.</p></li>
<li><p>If a 2D field is used both fields apply infinitely in z in a 3D model, therefore the sub-field
will always take precedence for any z value as long as x and y are inside its limits.</p></li>
</ul>
<p>Below is an example of a sub-field that can be found in <code class="code docutils literal notranslate"><span class="pre">bdsim/examples/features/fields/subfield</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fpipe</span><span class="p">:</span> <span class="n">field</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;bmap2d&quot;</span><span class="p">,</span>
              <span class="n">magneticFile</span><span class="o">=</span><span class="s2">&quot;bdsim2d:inner.dat&quot;</span><span class="p">,</span>
              <span class="n">magneticInterpolator</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
              <span class="n">x</span><span class="o">=-</span><span class="mi">10</span><span class="o">*</span><span class="n">cm</span><span class="p">;</span>

<span class="n">fyoke</span><span class="p">:</span> <span class="n">field</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;bmap2d&quot;</span><span class="p">,</span>
              <span class="n">magneticFile</span><span class="o">=</span><span class="s2">&quot;bdsim2d:outer.dat&quot;</span><span class="p">,</span>
              <span class="n">magneticInterpolator</span><span class="o">=</span><span class="s2">&quot;cubic&quot;</span><span class="p">,</span>
              <span class="n">magneticSubField</span><span class="o">=</span><span class="s2">&quot;fpipe&quot;</span><span class="p">;</span>

<span class="n">d1</span><span class="p">:</span> <span class="n">drift</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">aper1</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">fieldAll</span><span class="o">=</span><span class="s2">&quot;fyoke&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>First a smaller field map is defined called “fpipe”. Secondly, a larger coarser field map is created
called “fyoke” that crucially refers to the <code class="code docutils literal notranslate"><span class="pre">magneticSubField=&quot;fpipe&quot;</span></code>. The sub-field applies
only in the range of the field map taken from the maximum and minimum coordinates in each dimension
when loading the field map. In the provided example, the “inner.dat” field map defines 4 points in a
2D square at +- 20 cm in both x and y with the same B field vector. Nearest neighbour interpolation
is used to ensure a perfect uniform field inside these points.</p>
<p>The second field definition using “outer.dat” ranges from +- 50 cm with a similar box of 4 points in 2D.
Each point has the same field value but with an opposing x component. The Python script used to create
these simple field maps is included alongside the example. The example combined field map is shown
in the visualiser below. The magnetic field lines were visualised using the Geant4 visualiser command
<code class="code docutils literal notranslate"><span class="pre">/vis/scene/add/magneticField</span> <span class="pre">10</span> <span class="pre">lightArrow</span></code>.</p>
<a class="reference internal image-reference" href="_images/fields-sub-field.png"><img alt="_images/fields-sub-field.png" class="align-center" src="_images/fields-sub-field.png" style="width: 60%;" /></a>
</section>
<section id="field-map-visualisation">
<span id="fields-visualisation"></span><h3>Field Map Visualisation<a class="headerlink" href="#field-map-visualisation" title="Link to this heading"></a></h3>
<p>Recent versions of Geant4 (&gt; 10.5) provide a mechanism in the visualiser to visualise
magnetic fields. The following command can be used to add magnetic field lines to
the visualisation.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">vis</span><span class="o">/</span><span class="n">scene</span><span class="o">/</span><span class="n">add</span><span class="o">/</span><span class="n">magneticField</span> <span class="mi">10</span> <span class="n">lightArrow</span>
</pre></div>
</div>
<p>This may take some time due to the Geant4 visualiser drawing many arrows individually. The
number 10 here sets a density of points. If few useful arrows appear, then this number can be
increased. Note, the time taken will go with the cube (i.e. N^3) of this number. Suggested
values are 10, 30, 40. An example can be seen above in the <a class="reference internal" href="#fields-sub-fields"><span class="std std-ref">Sub-Fields</span></a> section.</p>
<p>Geant4 attempts to identify which volumes have fields and distribute the appoints accordingly
in the global Cartesian frame. For a more controllable distribution, see <a class="reference internal" href="#fields-visualisation-queries"><span class="std std-ref">Field Map Visualisation - Queries</span></a>.</p>
</section>
<section id="field-map-visualisation-queries">
<span id="fields-visualisation-queries"></span><h3>Field Map Visualisation - Queries<a class="headerlink" href="#field-map-visualisation-queries" title="Link to this heading"></a></h3>
<p>Any query object (see <a class="reference internal" href="#field-map-validation"><span class="std std-ref">Field Map Validation</span></a>) can be drawn on the screen in the visualiser.
A query defines a grid of points where the field is queried or found out. By default, this is
written to a field map file. Any of these queries can also be shown in the visualiser. This is
controlled by the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">bds</span><span class="o">/</span><span class="n">field</span><span class="o">/</span><span class="n">drawQuery</span> <span class="o">&lt;</span><span class="n">query</span><span class="o">-</span><span class="nb">object</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>For a list of queries, one can do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">bds</span><span class="o">/</span><span class="n">field</span><span class="o">/</span><span class="n">listQueries</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="_images/field-query.png"><img alt="_images/field-query.png" class="align-center" src="_images/field-query.png" style="width: 80%;" /></a>
<p>You can find examples in <code class="code docutils literal notranslate"><span class="pre">bdsim/examples/features/field/yoke_scaling/</span></code>. There is
a view point macro that can be loaded in the visualiser (open icon in the top left) to
centre the view nicely and make a quadrupole transparent.</p>
<ul class="simple">
<li><p>The visualisation consists of arrows and a pixel / voxel for each query point. These
can be turned on or off individually, but one must be on. If both magnetic and electric
fields are visualised in one query, it is recommended to switch off boxes with <code class="code docutils literal notranslate"><span class="pre">drawBoxes=0</span></code>.</p></li>
<li><p>It may be required to make geometry partially transparent to see the field arrows.</p></li>
<li><p>4D queries will not work. Only up to 3D is supported.</p></li>
<li><p>The visualisation may become very slow if a large (e.g. &gt; 100x100 in x,y) points is used.
This is a limitation of the visualisation system in Geant4. Typically, the querying of
the model is very quick and it is drawing the arrows that takes time.</p></li>
<li><p>Magnetic fields are drawn with the matplotlib “viridis” colour scale and electric
fields with the “magma” colour scale.</p></li>
<li><p>Both electric and magnetic fields may be visualised as defined by the query object.</p></li>
<li><p>A query called in the visualiser will not be written to file.</p></li>
<li><p>If the magnitude of the field is 0 at the given query point, a small circular point
is drawn instead of an arrow.</p></li>
<li><p>The arrow length does not depend on the field magnitude - only the spacing of the query points.</p></li>
</ul>
</section>
<section id="field-map-preparation">
<h3>Field Map Preparation<a class="headerlink" href="#field-map-preparation" title="Link to this heading"></a></h3>
<p>It is not recommended to write a field map file by hand. This can create very hard to identify
subtle problems that may lead to unintended behaviour. It is recommended to use our Python
utility <cite>pybdsim</cite>. See the pybdsim manual for details on creating, converting and plotting
field maps in Python: <a class="reference external" href="http://www.pp.rhul.ac.uk/bdsim/pybdsim/fieldmaps.html">http://www.pp.rhul.ac.uk/bdsim/pybdsim/fieldmaps.html</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The order of looping over dimensions is important and must be correct otherwise, the
loaded field map may not be as intended. Use of a field map should be validated.
BDSIM actually ignores the coordinates in each line of the field map and assumes
the looping order and dimension based on the header information.</p>
</div>
</section>
<section id="field-map-validation">
<span id="id3"></span><h3>Field Map Validation<a class="headerlink" href="#field-map-validation" title="Link to this heading"></a></h3>
<p>To validate a field map loaded by BDSIM, we can <em>query</em> what is loaded and generate a new
output field map that we can then inspect or numerically compare in Python (e.g. using pybdsim).
To query a field map, we have a 2 options:</p>
<ol class="arabic simple">
<li><p>Query the field <em>object</em> as loaded by BDSIM - no 3D model is actually built.</p></li>
<li><p>Query a set of coordinates in the full BDSIM model and note the field found at each position.</p></li>
</ol>
<p>In both cases, a BDSIM-format field map file is written out.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Magnetic and Electric fields are handled independently and written to separate files,
in the same way they are loaded into BDSIM in separate files.</p>
</div>
<p><strong>Case 1</strong> uses an extra program provided with BDSIM called <code class="code docutils literal notranslate"><span class="pre">bdsinterpolator</span></code>. This can also
be used to re-interpolate a field map as described in <a class="reference internal" href="#field-map-interpolation"><span class="std std-ref">Field Map Interpolation</span></a>, but we
can use it to simply query the same points again. This program has no concept of a 3D model and
only loads the field map into memory. This provides a class that BDSIM would normally use in the
Geant4 model, however, without any 3D transforms from local (such as curvilinear) to global frames.</p>
<p><strong>Case 2</strong> uses BDSIM itself and a regular input file and the querying is done after construction
of the model but before a <em>Run</em> where <em>Events</em> are simulated.</p>
<p>In both cases, an input GMAD file is used that defines a <code class="code docutils literal notranslate"><span class="pre">query</span></code> object. The appropriate program
(<cite>bdsim</cite> or <cite>bdsinterpolator</cite>) is then executed with that as an argument. If we have a file
called <code class="code docutils literal notranslate"><span class="pre">test-field-map.gmad</span></code>, then we could do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bdsim</span> <span class="o">--</span><span class="n">file</span><span class="o">=</span><span class="n">test</span><span class="o">-</span><span class="n">field</span><span class="o">-</span><span class="nb">map</span><span class="o">.</span><span class="n">gmad</span> <span class="o">--</span><span class="n">batch</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bdsinterpolator</span> <span class="o">--</span><span class="n">file</span><span class="o">=</span><span class="n">test</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="nb">map</span><span class="o">.</span><span class="n">gmad</span>
</pre></div>
</div>
<p>The following parameters can be used in a query object:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Parameter</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>nx</p></td>
<td><p>Number of points to query in x (1 -&gt; N)</p></td>
</tr>
<tr class="row-odd"><td><p>ny</p></td>
<td><p>Number of points to query in y (1 -&gt; N)</p></td>
</tr>
<tr class="row-even"><td><p>nz</p></td>
<td><p>Number of points to query in z (1 -&gt; N)</p></td>
</tr>
<tr class="row-odd"><td><p>nt</p></td>
<td><p>Number of points to query in t (1 -&gt; N)</p></td>
</tr>
<tr class="row-even"><td><p>xmin</p></td>
<td><p>Start of x values to use</p></td>
</tr>
<tr class="row-odd"><td><p>xmax</p></td>
<td><p>Finish of x values to use</p></td>
</tr>
<tr class="row-even"><td><p>ymin</p></td>
<td><p>Start of y values to use</p></td>
</tr>
<tr class="row-odd"><td><p>ymax</p></td>
<td><p>Finish of y values to use</p></td>
</tr>
<tr class="row-even"><td><p>zmin</p></td>
<td><p>Start of z values to use</p></td>
</tr>
<tr class="row-odd"><td><p>zmax</p></td>
<td><p>Finish of z values to use</p></td>
</tr>
<tr class="row-even"><td><p>tmin</p></td>
<td><p>Start of t values to use</p></td>
</tr>
<tr class="row-odd"><td><p>tmax</p></td>
<td><p>Finish of t values to use</p></td>
</tr>
<tr class="row-even"><td><p>outfileMagnetic</p></td>
<td><p>Name of output file to write field map to (B)</p></td>
</tr>
<tr class="row-odd"><td><p>outfileElectric</p></td>
<td><p>Name of output file to write field map to (E)</p></td>
</tr>
<tr class="row-even"><td><p>fieldObject</p></td>
<td><p>Name of the field object in the input to query</p></td>
</tr>
<tr class="row-odd"><td><p>queryMagneticField</p></td>
<td><p>(1 or 0) whether to query the magnetic field
- default is False (0)</p></td>
</tr>
<tr class="row-even"><td><p>queryElectricField</p></td>
<td><p>(1 or 0) whether to query the electric field
- default is False (0)</p></td>
</tr>
<tr class="row-odd"><td><p>overwriteExistingFiles</p></td>
<td><p>Whether to overwrite existing output files
- default is True (1)</p></td>
</tr>
<tr class="row-even"><td><p>drawArrows</p></td>
<td><p>(1 or 0) Whether to draw arrows if used for
visualisation. Default is true.</p></td>
</tr>
<tr class="row-odd"><td><p>drawZeroValuePoints</p></td>
<td><p>(1 or 0) whether to draw a point even if the
queried field value is 0 in magnitude. Default
is true. Only applies to arrows.</p></td>
</tr>
<tr class="row-even"><td><p>drawBoxes</p></td>
<td><p>(1 or 0) Whether to draw pixels / voxel boxes
for each query point in the visualiser.
Default is true.</p></td>
</tr>
<tr class="row-odd"><td><p>boxAlpha</p></td>
<td><p>The transparency value for the boxes. Range
from 0 to 1 where 0 is invisible. Default is
0.2.</p></td>
</tr>
<tr class="row-even"><td><p>printTransform</p></td>
<td><p>(1 or 0) whether to print out the calculated
transform from the origin to the global
coordinates</p></td>
</tr>
<tr class="row-odd"><td><p>referenceElement</p></td>
<td><p>Element with respect to which the coordinates
are desired to be queried</p></td>
</tr>
<tr class="row-even"><td><p>referenceElementNumber</p></td>
<td><p>Instance of the reference element in the beam
line if it is used more than once (0-counting)
- default is 0</p></td>
</tr>
<tr class="row-odd"><td><p>s</p></td>
<td><p>Curvilinear S coordinate (global | local
depending on parameters)</p></td>
</tr>
<tr class="row-even"><td><p>x</p></td>
<td><p>Offset in x</p></td>
</tr>
<tr class="row-odd"><td><p>y</p></td>
<td><p>Offset in y</p></td>
</tr>
<tr class="row-even"><td><p>z</p></td>
<td><p>Offset in z</p></td>
</tr>
<tr class="row-odd"><td><p>phi</p></td>
<td><p>Euler angle phi for rotation</p></td>
</tr>
<tr class="row-even"><td><p>theta</p></td>
<td><p>Euler angle theta for rotation</p></td>
</tr>
<tr class="row-odd"><td><p>psi</p></td>
<td><p>Euler angle psi for rotation</p></td>
</tr>
<tr class="row-even"><td><p>axisX</p></td>
<td><p>Axis angle rotation x-component of unit vector</p></td>
</tr>
<tr class="row-odd"><td><p>axisY</p></td>
<td><p>Axis angle rotation y-component of unit vector</p></td>
</tr>
<tr class="row-even"><td><p>axisZ</p></td>
<td><p>Axis angle rotation z-component of unit vector</p></td>
</tr>
<tr class="row-odd"><td><p>angle</p></td>
<td><p>Axis angle, angle to rotate about unit vector</p></td>
</tr>
<tr class="row-even"><td><p>axisAngle</p></td>
<td><p>(1 or 0) use axis angle rotation instead of
the Euler angle.</p></td>
</tr>
<tr class="row-odd"><td><p>pointsFile</p></td>
<td><p>Name of a file listing points to be queried
instead of the linear range. See below.</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The transforms are made using the same variable names and logic as that of geometry
or sampler placements - see <a class="reference internal" href="#placements"><span class="std std-ref">Placements</span></a> for a full description of the possible
combination of parameters for the 3 ways of specifying a transform.</p>
</div>
<ul class="simple">
<li><p>The default is to query the magnetic field only and <strong>to overwrite</strong> files.</p></li>
<li><p>The magnetic field will be queried if neither <cite>queryMagneticField</cite> or
<cite>queryElectricField</cite> are set to 1 (on), but only if neither are specified.</p></li>
<li><p>The ranges defined will be queried in the global frame if no transform is specified,
otherwise they will be about the point / frame of the transform.</p></li>
<li><p>In the case where a reference element is used, the frame includes the offset of that
element, so the x,y = 0,0 point is the same as the element even if that is offset
from the reference axis of the accelerator.</p></li>
<li><p>If you don’t wish to query a dimension, then the number of points should be
1, which is the default and need not be specified.</p></li>
<li><p>Units are <strong>m</strong> and <strong>ns</strong> by default, the same as BDSIM.</p></li>
<li><p>One of <cite>queryMagneticField</cite> or <cite>queryElectricField</cite> must be true.</p></li>
</ul>
<p>Examples can be found in <code class="code docutils literal notranslate"><span class="pre">bdsim/examples/features/fields/query/query*</span></code>.</p>
<p>An example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">quA</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="mi">51</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=-</span><span class="mi">30</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="mi">30</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
            <span class="n">ny</span><span class="o">=</span><span class="mi">51</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=-</span><span class="mi">30</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">30</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
            <span class="n">queryMagneticField</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">outfileMagnetic</span><span class="o">=</span><span class="s2">&quot;out_query_2d_bfield_xy.dat&quot;</span><span class="p">,</span>
            <span class="n">z</span><span class="o">=</span><span class="mf">1.1</span><span class="o">*</span><span class="n">m</span><span class="p">,</span>
            <span class="n">overwriteExistingFiles</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
<section id="query-by-points-file">
<h4>Query By Points File<a class="headerlink" href="#query-by-points-file" title="Link to this heading"></a></h4>
<p>A specific set of points can be queried also. These should be listed in a text
file (file extension not important) with one set of coordinates per line.</p>
<p>File rules:</p>
<ul class="simple">
<li><p>lines with only white-space will be ignored</p></li>
<li><p>no comments are permitted</p></li>
<li><p>There should be a line at the top starting with ‘!’ and listing the dimensions (x,y,z,t)</p></li>
<li><p>The column names and coordinates should be separated by white-space</p></li>
<li><p>Any combination of x,y,z,t may be used</p></li>
<li><p>The units are fixed in metres for x,y,z and nanoseconds for t.</p></li>
<li><p>The file extension is ignored</p></li>
<li><p>The output field map is not usable in BDSIM as the header information will be incorrect</p></li>
</ul>
<p>Example file contents:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>! X Y Z
0 0 1
0 1 1
1 0 1
0 0 0
0 1 0
1 0 0
</pre></div>
</div>
<p>Or:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>! Z
1.1
1.2
1.3
1.4
</pre></div>
</div>
<p>More examples can be found in <code class="code docutils literal notranslate"><span class="pre">bdsim/examples/features/fields/query/query-points*</span></code>.</p>
</section>
</section>
<section id="field-map-interpolation">
<span id="id4"></span><h3>Field Map Interpolation<a class="headerlink" href="#field-map-interpolation" title="Link to this heading"></a></h3>
<p>A field map can be loaded and interpolated to generate a new field map. This can be done
with the exact same number and range of points as a way of validating the field map
was correctly prepared for BDSIM (by seeing the output file is the same as the input).</p>
<p>We could also interpolate the field map with different interpolation methods to compare,
or we could increase the density of points and then use a simpler interpolation (more memory,
but slightly faster simulation), although this is quite an optimisation step.</p>
<p>A tool, <code class="code docutils literal notranslate"><span class="pre">bdsinterpolator</span></code>, will load a GMAD file and obey only the <code class="code docutils literal notranslate"><span class="pre">query</span></code>
objects defined to generate output field maps.</p>
<p>This <strong>does not</strong> build a Geant4 model. It simply loads the field map and wraps it
in an interpolator. The interpolator is queried for a set of coordinates the resultant
field values written out as a field map in BDSIM format. This output file, if desired,
can be used in BDSIM subsequently.</p>
<p>This program takes an input GMAD file with a minimum of:</p>
<ol class="arabic simple">
<li><p>1x field object defined</p></li>
<li><p>1x query object defined</p></li>
</ol>
<p>Any parameters that are used for the placement transform (“referenceElement” onwards
in the table of <cite>query</cite> parameters in the above section) will be completely ignored.
The field is only queried in its own ‘local’ coordinate system in this program.</p>
<p>Examples can be found in <code class="code docutils literal notranslate"><span class="pre">bdsim/examples/features/fields/query</span></code>.</p>
<p>Usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bdsinterpolator</span> <span class="o">--</span><span class="n">file</span><span class="o">=&lt;</span><span class="n">my</span><span class="o">-</span><span class="n">file</span><span class="o">.</span><span class="n">gmad</span><span class="o">&gt;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>If more points are requested in the query in a dimension than are in the original
field map, then we are in effect interpolating the field.</p></li>
<li><p>If fewer points are requested in the query in a dimension than are in the original
field map, we are still interpolating values in the field map, but we are just
reducing the ‘resolution’ of the field map.</p></li>
</ul>
<p>Example in one gmad file called <code class="code docutils literal notranslate"><span class="pre">bdsim/examples/features/fields/maps_bdsim/2d_cubic.gmad</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f1</span><span class="p">:</span> <span class="n">field</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;bmap2d&quot;</span><span class="p">,</span>
               <span class="n">magneticFile</span> <span class="o">=</span> <span class="s2">&quot;bdsim2d:2dexample.dat&quot;</span><span class="p">,</span>
               <span class="n">magneticInterpolator</span> <span class="o">=</span> <span class="s2">&quot;cubic&quot;</span><span class="p">;</span>

<span class="n">q1</span><span class="p">:</span> <span class="n">query</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
           <span class="n">xmin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">30</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
           <span class="n">xmax</span> <span class="o">=</span> <span class="mi">30</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
           <span class="n">ny</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
           <span class="n">ymin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">50</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
           <span class="n">ymax</span> <span class="o">=</span> <span class="mi">50</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
           <span class="n">outfileMagnetic</span> <span class="o">=</span> <span class="s2">&quot;2d_interpolated_linear.dat&quot;</span><span class="p">,</span>
           <span class="n">fieldObject</span> <span class="o">=</span> <span class="s2">&quot;f1&quot;</span><span class="p">;</span>
</pre></div>
</div>
</section>
</section>
<section id="materials-and-atoms">
<span id="id5"></span><h2>Materials and Atoms<a class="headerlink" href="#materials-and-atoms" title="Link to this heading"></a></h2>
<p>All chemical elements are available in BDSIM as well as the Geant4 NIST database
of materials for use. Custom materials and can also be added via the parser. All materials
available in BDSIM can be found by executing BDSIM with the <code class="code docutils literal notranslate"><span class="pre">--materials</span></code> option.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bdsim</span> <span class="o">--</span><span class="n">materials</span>
</pre></div>
</div>
<p>Aside from these, several materials useful for accelerator applications are already defined
that are listed in <a class="reference internal" href="#predefined-materials"><span class="std std-ref">Predefined Materials</span></a>.</p>
<p>Generally, each beam line element accepts an argument “material” that is the
material used for that element. It is used differently depending on the element. For example,
in the case of a magnet, it is used for the yoke and for a collimator for the collimator
block.</p>
<section id="single-element">
<h3>Single Element<a class="headerlink" href="#single-element" title="Link to this heading"></a></h3>
<p>In the case of an element, the chemical symbol can be specified:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rc1</span><span class="p">:</span> <span class="n">rcol</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mf">0.6</span><span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">xsize</span><span class="o">=</span><span class="mf">1.2</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span> <span class="n">ysize</span><span class="o">=</span><span class="mf">0.6</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="s2">&quot;W&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>These are automatically prefixed with <code class="code docutils literal notranslate"><span class="pre">G4_</span></code> and retrieved from the NIST database of
materials.</p>
<p>The user can also define their own material and then refer to it by name when defining
a beam line element.</p>
</section>
<section id="custom-single-element-material">
<h3>Custom Single Element Material<a class="headerlink" href="#custom-single-element-material" title="Link to this heading"></a></h3>
<p>If the material required is composed of a single element, but say of a different density or
state than the default NIST one provided, it can be defined using the <strong>matdef</strong>
command with the following syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">materialname</span> <span class="p">:</span> <span class="n">matdef</span><span class="p">,</span> <span class="n">Z</span><span class="o">=&lt;</span><span class="nb">int</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">A</span><span class="o">=&lt;</span><span class="n">double</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">density</span><span class="o">=&lt;</span><span class="n">double</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">T</span><span class="o">=&lt;</span><span class="n">double</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">P</span><span class="o">=&lt;</span><span class="n">double</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">state</span><span class="o">=&lt;</span><span class="n">char</span><span class="o">*&gt;</span><span class="p">;</span>
</pre></div>
</div>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Parameter</p></td>
<td><p>Description</p></td>
<td><p>Default</p></td>
</tr>
<tr class="row-even"><td><p>Z</p></td>
<td><p>Atomic number</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>A</p></td>
<td><p>Mass number [g/mol]</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>density</p></td>
<td><p>Density in [g/cm3]</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>T</p></td>
<td><p>Temperature in [K]</p></td>
<td><p>300</p></td>
</tr>
<tr class="row-even"><td><p>P</p></td>
<td><p>Pressure [atm]</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>state</p></td>
<td><p>“solid”, “liquid” or “gas”</p></td>
<td><p>“solid”</p></td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">iron2</span> <span class="p">:</span> <span class="n">matdef</span><span class="p">,</span> <span class="n">Z</span><span class="o">=</span><span class="mi">26</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="mf">55.845</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="mf">7.87</span><span class="p">;</span>
</pre></div>
</div>
<p>A compound material can be specified in two manners:</p>
</section>
<section id="compound-material-by-atoms">
<h3>Compound Material by Atoms<a class="headerlink" href="#compound-material-by-atoms" title="Link to this heading"></a></h3>
<p>If the number of atoms of each component in a material unit is known,
the following syntax can be used:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">material</span><span class="o">&gt;</span> <span class="p">:</span> <span class="n">matdef</span><span class="p">,</span> <span class="n">density</span><span class="o">=&lt;</span><span class="n">double</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">T</span><span class="o">=&lt;</span><span class="n">double</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">P</span><span class="o">=&lt;</span><span class="n">double</span><span class="o">&gt;</span><span class="p">,</span>
             <span class="n">state</span><span class="o">=&lt;</span><span class="n">char</span><span class="o">*&gt;</span><span class="p">,</span> <span class="n">components</span><span class="o">=&lt;</span><span class="p">[</span><span class="nb">list</span><span class="o">&lt;</span><span class="n">char</span><span class="o">*&gt;</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
             <span class="n">componentsWeights</span><span class="o">=&lt;</span><span class="p">{</span><span class="nb">list</span><span class="o">&lt;</span><span class="nb">int</span><span class="o">&gt;</span><span class="p">}</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Parameter</p></td>
<td><p>Description</p></td>
</tr>
<tr class="row-even"><td><p>density</p></td>
<td><p>Density in [g/cm3]</p></td>
</tr>
<tr class="row-odd"><td><p>components</p></td>
<td><p>List of symbols for material components</p></td>
</tr>
<tr class="row-even"><td><p>componentsWeights</p></td>
<td><p>Number of atoms for each component in material unit</p></td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NbTi</span> <span class="p">:</span> <span class="n">matdef</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="mf">5.6</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Nb&quot;</span><span class="p">,</span><span class="s2">&quot;Ti&quot;</span><span class="p">],</span> <span class="n">componentsWeights</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">};</span>
</pre></div>
</div>
</section>
<section id="compound-material-by-mass-fraction">
<h3>Compound Material by Mass Fraction<a class="headerlink" href="#compound-material-by-mass-fraction" title="Link to this heading"></a></h3>
<p>On the other hand, if the mass fraction of each component is known, the
following syntax can be used:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">material</span><span class="o">&gt;</span> <span class="p">:</span> <span class="n">matdef</span><span class="p">,</span> <span class="n">density</span><span class="o">=&lt;</span><span class="n">double</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">T</span><span class="o">=&lt;</span><span class="n">double</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">P</span><span class="o">=&lt;</span><span class="n">double</span><span class="o">&gt;</span><span class="p">,</span>
             <span class="n">state</span><span class="o">=&lt;</span><span class="n">char</span><span class="o">*&gt;</span><span class="p">,</span> <span class="n">components</span><span class="o">=&lt;</span><span class="p">[</span><span class="nb">list</span><span class="o">&lt;</span><span class="n">char</span><span class="o">*&gt;</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
             <span class="n">componentsFractions</span><span class="o">=&lt;</span><span class="p">{</span><span class="nb">list</span><span class="o">&lt;</span><span class="n">double</span><span class="o">&gt;</span><span class="p">}</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Parameter</p></td>
<td><p>Description</p></td>
</tr>
<tr class="row-even"><td><p>components</p></td>
<td><p>List of symbols for material components</p></td>
</tr>
<tr class="row-odd"><td><p>componentsFractions</p></td>
<td><p>Mass fraction of each component in material unit</p></td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SmCo</span> <span class="p">:</span> <span class="n">matdef</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="mf">8.4</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">300.0</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Sm&quot;</span><span class="p">,</span><span class="s2">&quot;Co&quot;</span><span class="p">],</span> <span class="n">componentsFractions</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.338</span><span class="p">,</span><span class="mf">0.662</span><span class="p">};</span>
</pre></div>
</div>
<p>The second syntax can also be used to define materials which are composed by
other materials (and not by atoms).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Square brackets are required for the list of element symbols, curly
brackets for the list of weights or fractions.</p>
</div>
<p>New elements can be defined with the <strong>atom</strong> keyword:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">elementname</span> <span class="p">:</span> <span class="n">atom</span><span class="p">,</span> <span class="n">Z</span><span class="o">=&lt;</span><span class="nb">int</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">A</span><span class="o">=&lt;</span><span class="n">double</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=&lt;</span><span class="n">char</span><span class="o">*&gt;</span><span class="p">;</span>
</pre></div>
</div>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Parameter</p></td>
<td><p>Description</p></td>
</tr>
<tr class="row-even"><td><p>Z</p></td>
<td><p>Atomic number</p></td>
</tr>
<tr class="row-odd"><td><p>A</p></td>
<td><p>Mass number [g/mol]</p></td>
</tr>
<tr class="row-even"><td><p>symbol</p></td>
<td><p>Atom symbol</p></td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">myNiobium</span>  <span class="p">:</span> <span class="n">atom</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;myNb&quot;</span><span class="p">,</span> <span class="n">Z</span><span class="o">=</span><span class="mi">41</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="mf">92.906</span><span class="p">;</span>
<span class="n">myTitanium</span> <span class="p">:</span> <span class="n">atom</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;myTi&quot;</span><span class="p">,</span> <span class="n">Z</span><span class="o">=</span><span class="mi">22</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="mf">47.867</span><span class="p">;</span>
<span class="n">myNbTi</span>     <span class="p">:</span> <span class="n">matdef</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="mf">5.6</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;myNb&quot;</span><span class="p">,</span><span class="s2">&quot;myTi&quot;</span><span class="p">],</span> <span class="n">componentsWeights</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">};</span>
</pre></div>
</div>
</section>
<section id="predefined-materials">
<span id="id6"></span><h3>Predefined Materials<a class="headerlink" href="#predefined-materials" title="Link to this heading"></a></h3>
<p>The following elements are available by full name that refer to the Geant4 NIST
elements:</p>
<ul class="simple">
<li><p>aluminium</p></li>
<li><p>beryllium</p></li>
<li><p>carbon</p></li>
<li><p>chromium</p></li>
<li><p>copper</p></li>
<li><p>iron</p></li>
<li><p>lead</p></li>
<li><p>magnesium</p></li>
<li><p>nickel</p></li>
<li><p>nitrogen</p></li>
<li><p>silicon</p></li>
<li><p>titanium</p></li>
<li><p>tungsten</p></li>
<li><p>uranium</p></li>
<li><p>vanadium</p></li>
<li><p>zinc</p></li>
</ul>
<p>The following materials are also defined in BDSIM. The user should consult
<code class="code docutils literal notranslate"><span class="pre">bdsim/src/BDSMaterials.cc</span></code> for the full definition of each including
elements, mass fractions, temperature and state.</p>
<ul class="simple">
<li><p>air (G4_AIR)</p></li>
<li><p>airbdsim  (previously defined air in bdsim)</p></li>
<li><p>aralditef</p></li>
<li><p>awakeplasma</p></li>
<li><p>berylliumcopper</p></li>
<li><p>bn5000</p></li>
<li><p>bp_carbonmonoxide</p></li>
<li><p>calciumcarbonate</p></li>
<li><p>carbonfiber</p></li>
<li><p>carbonmonoxide</p></li>
<li><p>carbonsteel</p></li>
<li><p>cellulose (G4_CELLULOSE_CELLOPHANE)</p></li>
<li><p>clay</p></li>
<li><p>clayousMarl</p></li>
<li><p>concrete</p></li>
<li><p>copperdiamond</p></li>
<li><p>cu_2k (G4_Cu at 2K)</p></li>
<li><p>cu_4k (G4_Cu at 4K)</p></li>
<li><p>dy061</p></li>
<li><p>epoxyresin3</p></li>
<li><p>fusedsilica</p></li>
<li><p>gos_lanex</p></li>
<li><p>gos_ri1</p></li>
<li><p>graphite</p></li>
<li><p>graphitefoam</p></li>
<li><p>hy906</p></li>
<li><p>inermet170</p></li>
<li><p>inermet176</p></li>
<li><p>inermet180</p></li>
<li><p>invar</p></li>
<li><p>kapton</p></li>
<li><p>lanex</p></li>
<li><p>lanex2</p></li>
<li><p>laservac (same as vacuum but with different name)</p></li>
<li><p>leadtungstate</p></li>
<li><p>lhcconcrete</p></li>
<li><p>lhc_rock</p></li>
<li><p>lhe_1.9k</p></li>
<li><p>limousmarl</p></li>
<li><p>liquidhelium</p></li>
<li><p>marl</p></li>
<li><p>medex</p></li>
<li><p>molybdenumcarbide (also “mogr”)</p></li>
<li><p>mild_steel</p></li>
<li><p>n-bk7</p></li>
<li><p>nb_87k</p></li>
<li><p>nbti.1</p></li>
<li><p>nbti_4k</p></li>
<li><p>nbti_87k</p></li>
<li><p>niobium_2k</p></li>
<li><p>nb_2k (niobium_2k)</p></li>
<li><p>perspex</p></li>
<li><p>pet</p></li>
<li><p>pet_lanex</p></li>
<li><p>pet_opaque</p></li>
<li><p>polyurethane</p></li>
<li><p>quartz</p></li>
<li><p>rch1000_4k (ultra high molecular weight ethylene)</p></li>
<li><p>smco</p></li>
<li><p>soil</p></li>
<li><p>solidhydrogen</p></li>
<li><p>solidnitrogen</p></li>
<li><p>solidoxygen</p></li>
<li><p>stainless_steel_304L</p></li>
<li><p>stainless_steel_304L_2K</p></li>
<li><p>stainless_steel_304L_87K</p></li>
<li><p>stainless_steel_316LN</p></li>
<li><p>stainless_steel_316LN_2K</p></li>
<li><p>stainless_steel_316LN_87K</p></li>
<li><p>stainlesssteel</p></li>
<li><p>ti_87k</p></li>
<li><p>titaniumalloy</p></li>
<li><p>tungsten_heavy_alloy</p></li>
<li><p>ups923a</p></li>
<li><p>vacuum</p></li>
<li><p>water (G4_WATER)</p></li>
<li><p>weightiron</p></li>
<li><p>yag</p></li>
</ul>
</section>
<section id="vacuum-and-air">
<h3>Vacuum and Air<a class="headerlink" href="#vacuum-and-air" title="Link to this heading"></a></h3>
<p>The default “vacuum” material used in all beam pipes is composed of H, C and O with the
following fractions:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Element</strong></p></th>
<th class="head"><p><strong>Mass Fraction</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>H</p></td>
<td><p>0.482</p></td>
</tr>
<tr class="row-odd"><td><p>C</p></td>
<td><p>0.221</p></td>
</tr>
<tr class="row-even"><td><p>O</p></td>
<td><p>0.297</p></td>
</tr>
</tbody>
</table>
<p>The default pressure is 1e-12 bar, the temperature is 300K and the density is 1.16336e-15 g/cm3.</p>
<p>“air” is the G4_AIR material. As of Geant4.10.04.p02
(see geant4/source/materials/src/G4NistMaterialBuilder.cc), it is composed of C, N, O, Ar
with the following fractions:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Element</strong></p></th>
<th class="head"><p><strong>Mass Fraction</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>C</p></td>
<td><p>0.000124</p></td>
</tr>
<tr class="row-odd"><td><p>N</p></td>
<td><p>0.755267</p></td>
</tr>
<tr class="row-even"><td><p>O</p></td>
<td><p>0.231781</p></td>
</tr>
<tr class="row-odd"><td><p>Ar</p></td>
<td><p>0.012827</p></td>
</tr>
</tbody>
</table>
<p>It is a gas with density of 1.20479 mg/cm3.</p>
</section>
</section>
<section id="aperture-parameters">
<span id="id7"></span><h2>Aperture Parameters<a class="headerlink" href="#aperture-parameters" title="Link to this heading"></a></h2>
<p>For elements that contain a beam pipe, several aperture models can be used. These aperture
parameters can be set as the default for every element using the <code class="code docutils literal notranslate"><span class="pre">option</span></code> command
(see <a class="reference internal" href="model_control.html#bdsim-options"><span class="std std-ref">Options</span></a>) but can also be overridden for each element by specifying
them with the element definition. The aperture is controlled through the following parameters:</p>
<ul class="simple">
<li><p><cite>apertureType</cite></p></li>
<li><p><cite>beampipeRadius</cite> or <cite>aper1</cite></p></li>
<li><p><cite>aper2</cite></p></li>
<li><p><cite>aper3</cite></p></li>
<li><p><cite>aper4</cite></p></li>
<li><p><cite>vacuumMaterial</cite></p></li>
<li><p><cite>beampipeThickness</cite></p></li>
<li><p><cite>beampipeMaterial</cite></p></li>
</ul>
<p>For each aperture model, a different number of parameters are required. Here, we follow the MAD-X
convention and have four parameters. The user must specify them as required for that model.
BDSIM will check to see if the combination of parameters is valid. <cite>beampipeRadius</cite> and <cite>aper1</cite>
are degenerate.</p>
<p>Up to four parameters
can be used to specify the aperture shape (<em>aper1</em>, <em>aper2</em>, <em>aper3</em>, <em>aper4</em>).
These are used differently for each aperture model and match the MAD-X aperture definitions.
The required parameters and their meaning are given in the following table.</p>
<p>A completely custom aperture can be used with <cite>pointsfile</cite>. See the notes below.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If <strong>no beam pipe</strong> is desired, <code class="code docutils literal notranslate"><span class="pre">apertureType=&quot;circularvacuum&quot;</span></code> can be used that makes
only the vacuum volume without any beam pipe. The vacuum material is the usual vacuum
but can of course can be controlled with <code class="code docutils literal notranslate"><span class="pre">vacuumMaterial</span></code>. So you could create
a magnet with air and no beam pipe.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The default beam pipe material is “stainlesssteel”.</p>
</div>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Aperture Model</p></th>
<th class="head"><p># of
parameters</p></th>
<th class="head"><p><cite>aper1</cite></p></th>
<th class="head"><p><cite>aper2</cite></p></th>
<th class="head"><p><cite>aper3</cite></p></th>
<th class="head"><p><cite>aper4</cite></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><cite>circular</cite></p></td>
<td><p>1</p></td>
<td><p>radius</p></td>
<td><p>NA</p></td>
<td><p>NA</p></td>
<td><p>NA</p></td>
</tr>
<tr class="row-odd"><td><p><cite>rectangular</cite></p></td>
<td><p>2</p></td>
<td><p>x half-width</p></td>
<td><p>y half-width</p></td>
<td><p>NA</p></td>
<td><p>NA</p></td>
</tr>
<tr class="row-even"><td><p><cite>elliptical</cite></p></td>
<td><p>2</p></td>
<td><p>x semi-axis</p></td>
<td><p>y semi-axis</p></td>
<td><p>NA</p></td>
<td><p>NA</p></td>
</tr>
<tr class="row-odd"><td><p><cite>lhc</cite></p></td>
<td><p>3</p></td>
<td><p>x half-width of
rectangle</p></td>
<td><p>y half-width of
rectangle</p></td>
<td><p>radius of
circle</p></td>
<td><p>NA</p></td>
</tr>
<tr class="row-even"><td><p><cite>lhcdetailed</cite> (*)</p></td>
<td><p>3</p></td>
<td><p>x half-width of
rectangle</p></td>
<td><p>y half-width of
rectangle</p></td>
<td><p>radius of
circle</p></td>
<td><p>NA</p></td>
</tr>
<tr class="row-odd"><td><p><cite>rectellipse</cite></p></td>
<td><p>4</p></td>
<td><p>x half-width of
rectangle</p></td>
<td><p>y half-width of
rectangle</p></td>
<td><p>x semi-axis
of ellipse</p></td>
<td><p>y semi-axis
of ellipse</p></td>
</tr>
<tr class="row-even"><td><p><cite>racetrack</cite></p></td>
<td><p>3</p></td>
<td><p>horizontal offset
of circle</p></td>
<td><p>vertical offset
of circle</p></td>
<td><p>radius of
circular part</p></td>
<td><p>NA</p></td>
</tr>
<tr class="row-odd"><td><p><cite>octagonal</cite></p></td>
<td><p>4</p></td>
<td><p>x half-width</p></td>
<td><p>y half-width</p></td>
<td><p>x point of
start of edge</p></td>
<td><p>y point of
start of edge</p></td>
</tr>
<tr class="row-even"><td><p><cite>clicpcl</cite></p></td>
<td><p>4</p></td>
<td><p>x half-width</p></td>
<td><p>top ellipse
y half-height</p></td>
<td><p>bottom ellipse
y half-height</p></td>
<td><p>y separation
between ellipses</p></td>
</tr>
<tr class="row-odd"><td><p><cite>circularvacuum</cite></p></td>
<td><p>1</p></td>
<td><p>radius</p></td>
<td><p>NA</p></td>
<td><p>NA</p></td>
<td><p>NA</p></td>
</tr>
<tr class="row-even"><td><p><cite>rhombus</cite> (+)</p></td>
<td><p>2-3</p></td>
<td><p>x half-width</p></td>
<td><p>y half-width</p></td>
<td><p>radius of
corners</p></td>
<td><p>NA</p></td>
</tr>
<tr class="row-odd"><td><p><cite>pointsfile</cite> (**)</p></td>
<td><p>0</p></td>
<td><p>NA</p></td>
<td><p>NA</p></td>
<td><p>NA</p></td>
<td><p>NA</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>(*) <code class="code docutils literal notranslate"><span class="pre">lhcdetailed</span></code> aperture type will result in the <code class="code docutils literal notranslate"><span class="pre">beampipeMaterial</span></code> being ignored
and LHC-specific materials at 2K being used.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>(**) For points file, use <code class="code docutils literal notranslate"><span class="pre">apertureType=&quot;pointsfile:pathtofile.dat:cm&quot;;</span></code>. See below.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>(+) For the rhombus aperture, <cite>aper1</cite> and <cite>aper2</cite> are the maximum extents if there was no radius
of curvature for the corners. Therefore, the curved edges ‘eat’ into the shape.</p>
</div>
<p>These parameters can be set with the <em>option</em> command, as the default parameters
and also on a per element basis that overrides the defaults for that specific element.</p>
<p>In the case of <cite>clicpcl</cite> (CLIC Post Collision Line), the beam pipe is asymmetric. The centre is
the same as the geometric centre of the bottom ellipse. Therefore, <em>aper4</em>, the y separation
between ellipses is added on to the 0 position. The parameterisation is taken from
Phys. Rev. ST Accel. Beams <strong>12</strong>, 021001 (2009).</p>
<section id="circular">
<h3>circular<a class="headerlink" href="#circular" title="Link to this heading"></a></h3>
<a class="reference internal image-reference" href="_images/circular.png"><img alt="_images/circular.png" class="align-left" src="_images/circular.png" style="width: 40%;" /></a>
<p>A circular aperture is defined by one parameter, <code class="code docutils literal notranslate"><span class="pre">aper1</span></code>. The beam pipe
thickness is added outside this radius.</p>
<p><strong>Example</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span><span class="p">:</span> <span class="n">drift</span><span class="p">,</span> <span class="n">aperType</span><span class="o">=</span><span class="s2">&quot;circular&quot;</span><span class="p">,</span>
           <span class="n">aper1</span><span class="o">=</span><span class="mi">5</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
           <span class="n">beampipeThickness</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">mm</span><span class="p">;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</section>
<section id="rectangular">
<h3>rectangular<a class="headerlink" href="#rectangular" title="Link to this heading"></a></h3>
<a class="reference internal image-reference" href="_images/rectangular.png"><img alt="_images/rectangular.png" class="align-left" src="_images/rectangular.png" style="width: 40%;" /></a>
<p>A rectangular aperture is defined by two parameters, <code class="code docutils literal notranslate"><span class="pre">aper1</span></code> for the horizontal
half width, and <code class="code docutils literal notranslate"><span class="pre">aper2</span></code> for the vertical half width. The beam pipe
thickness is added outside this aperture.</p>
<p><strong>Example</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span><span class="p">:</span> <span class="n">drift</span><span class="p">,</span> <span class="n">aperType</span><span class="o">=</span><span class="s2">&quot;rectangular&quot;</span><span class="p">,</span>
           <span class="n">aper1</span><span class="o">=</span><span class="mi">5</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
           <span class="n">aper2</span><span class="o">=</span><span class="mf">2.1</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
           <span class="n">beampipeThickness</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">mm</span><span class="p">;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
</section>
<section id="elliptical">
<h3>elliptical<a class="headerlink" href="#elliptical" title="Link to this heading"></a></h3>
<a class="reference internal image-reference" href="_images/elliptical.png"><img alt="_images/elliptical.png" class="align-left" src="_images/elliptical.png" style="width: 40%;" /></a>
<p>An elliptical aperture is defined by two parameters, <code class="code docutils literal notranslate"><span class="pre">aper1</span></code> for the horizontal
semi-axis, and <code class="code docutils literal notranslate"><span class="pre">aper2</span></code> for the vertical semi-axis. The beam pipe
thickness is added outside this aperture.</p>
<p><strong>Example</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span><span class="p">:</span> <span class="n">drift</span><span class="p">,</span> <span class="n">aperType</span><span class="o">=</span><span class="s2">&quot;elliptical&quot;</span><span class="p">,</span>
           <span class="n">aper1</span><span class="o">=</span><span class="mi">5</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
           <span class="n">aper2</span><span class="o">=</span><span class="mf">2.1</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
           <span class="n">beampipeThickness</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">mm</span><span class="p">;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</section>
<section id="lhc">
<h3>lhc<a class="headerlink" href="#lhc" title="Link to this heading"></a></h3>
<a class="reference internal image-reference" href="_images/lhc.png"><img alt="_images/lhc.png" class="align-left" src="_images/lhc.png" style="width: 40%;" /></a>
<p>The LHC aperture shapre is defined by three parameters. It is the intersection (i.e. only
where both exist) of a circle and a rectangle centred on each other. <code class="code docutils literal notranslate"><span class="pre">aper1</span></code> is the
horizontal half-width of the rectangle. <code class="code docutils literal notranslate"><span class="pre">aper2</span></code> is the vertical half-height of the
rectangle. <code class="code docutils literal notranslate"><span class="pre">aper3</span></code> is the radius of the circle. Depending on these parameters, a similar
shape as shown can be achieved this way or apparently rotated 90 degrees with flat vertical
edges. If <code class="code docutils literal notranslate"><span class="pre">aper2</span></code> is less than <code class="code docutils literal notranslate"><span class="pre">aper3</span></code>, then the aperture will appear like the
image shown. The beam pipe thickness is added outside this aperture.
|</p>
<p><strong>Example</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span><span class="p">:</span> <span class="n">drift</span><span class="p">,</span> <span class="n">aperType</span><span class="o">=</span><span class="s2">&quot;lhc&quot;</span><span class="p">,</span>
           <span class="n">aper1</span><span class="o">=</span><span class="mf">2.202</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
           <span class="n">aper2</span><span class="o">=</span><span class="mf">1.714</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
           <span class="n">aper3</span><span class="o">=</span><span class="mf">2.202</span><span class="o">*</span><span class="n">cm</span>
           <span class="n">beampipeThickness</span><span class="o">=</span><span class="mi">1</span><span class="o">*</span><span class="n">mm</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="lhcdetailed">
<h3>lhcdetailed<a class="headerlink" href="#lhcdetailed" title="Link to this heading"></a></h3>
<p>This aperture type has the same parameters as <code class="code docutils literal notranslate"><span class="pre">lhc</span></code>. However, it includes more
detailed geometry with a circular second outer beam pipe as well as the 70 micron
layer of copper. The beam screen does not have the perforated holes as this was
deemed too detailed and would slow the simulation. This may cause errors if parameters
too far from the authentic LHC aperture parameters are used.</p>
</section>
<section id="rectellipse">
<h3>rectellipse<a class="headerlink" href="#rectellipse" title="Link to this heading"></a></h3>
<a class="reference internal image-reference" href="_images/rectellipse.png"><img alt="_images/rectellipse.png" class="align-left" src="_images/rectellipse.png" style="width: 40%;" /></a>
<p>The rectellipse aperture is similar to the LHC aperture shape, but intead of a
circle, it is the intersection of a rectangle and an ellipse. <code class="code docutils literal notranslate"><span class="pre">aper1</span></code> and
<code class="code docutils literal notranslate"><span class="pre">aper2</span></code> define the rectangle, and <code class="code docutils literal notranslate"><span class="pre">aper3</span></code> and <code class="code docutils literal notranslate"><span class="pre">aper4</span></code> define the
ellipse. The beam pipe thickness is added outside this aperture.</p>
<p><strong>Example</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span><span class="p">:</span> <span class="n">drift</span><span class="p">,</span> <span class="n">aperType</span><span class="o">=</span><span class="s2">&quot;rectellipse&quot;</span><span class="p">,</span>
           <span class="n">aper1</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
           <span class="n">aper2</span><span class="o">=</span><span class="mi">1</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
           <span class="n">aper3</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
           <span class="n">aper4</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">cm</span>
           <span class="n">beampipeThickness</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">mm</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="racetrack">
<h3>racetrack<a class="headerlink" href="#racetrack" title="Link to this heading"></a></h3>
<a class="reference internal image-reference" href="_images/racetrack.png"><img alt="_images/racetrack.png" class="align-left" src="_images/racetrack.png" style="width: 40%;" /></a>
<p>The racetrack aperture is defined by three parameters. The aperture is defined
by a circle with an offset in one quadrant that is then mirrored in all quadrants.
<code class="code docutils literal notranslate"><span class="pre">aper1</span></code> and <code class="code docutils literal notranslate"><span class="pre">aper2</span></code> are the horizontal and vertical offsets of the
centre of the circle in the positive quadrant (i.e. positive values). <code class="code docutils literal notranslate"><span class="pre">aper3</span></code>
is the radius of the circle. The horizontal half width is therefore <code class="code docutils literal notranslate"><span class="pre">aper1</span> <span class="pre">+</span> <span class="pre">`aper3</span></code>,
and similarly, the vertical half width is <code class="code docutils literal notranslate"><span class="pre">aper2</span> <span class="pre">+</span> <span class="pre">aper3</span></code>. The beam pipe
thickness is added outside this aperture.
|
|</p>
<p><strong>Example</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span><span class="p">:</span> <span class="n">drift</span><span class="p">,</span> <span class="n">aperType</span><span class="o">=</span><span class="s2">&quot;racetrack&quot;</span><span class="p">,</span>
           <span class="n">aper1</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
           <span class="n">aper2</span><span class="o">=</span><span class="mi">1</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
           <span class="n">aper3</span><span class="o">=</span><span class="mf">2.4</span><span class="o">*</span><span class="n">cm</span>
           <span class="n">beampipeThickness</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">mm</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="octagonal">
<h3>octagonal<a class="headerlink" href="#octagonal" title="Link to this heading"></a></h3>
<a class="reference internal image-reference" href="_images/octagonal.png"><img alt="_images/octagonal.png" class="align-left" src="_images/octagonal.png" style="width: 40%;" /></a>
<p>The octagonal aperture is defined by four parameters. <code class="code docutils literal notranslate"><span class="pre">aper1</span></code> and <code class="code docutils literal notranslate"><span class="pre">aper2</span></code>
definthe the horizontal and vertical half widths respectively of a full rectangle.
<code class="code docutils literal notranslate"><span class="pre">aper3</span></code> and <code class="code docutils literal notranslate"><span class="pre">aper4</span></code> define a (smaller) set of horizontal and vertical values
that define the points where the cut-off edge starts. The beam pipe
thickness is added outside this aperture.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This is not the same set of parameters as MADX, which uses the angles
between the origin and each cut-off point. This is particularly hard
to use as well as more difficult to implement so was not used in BDSIM.
The MADX community wanted to change this but it is kept for backwards
compatibility.</p>
</div>
<p><strong>Example</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span><span class="p">:</span> <span class="n">drift</span><span class="p">,</span> <span class="n">aperType</span><span class="o">=</span><span class="s2">&quot;octagonal&quot;</span><span class="p">,</span>
           <span class="n">aper1</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
           <span class="n">aper2</span><span class="o">=</span><span class="mi">1</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
           <span class="n">aper3</span><span class="o">=</span><span class="mf">1.1</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
           <span class="n">aper4</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="n">cm</span>
           <span class="n">beampipeThickness</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">mm</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="rhombus">
<h3>rhombus<a class="headerlink" href="#rhombus" title="Link to this heading"></a></h3>
<a class="reference internal image-reference" href="_images/rhombus.png"><img alt="_images/rhombus.png" class="align-left" src="_images/rhombus.png" style="width: 40%;" /></a>
<p>The rhombus aperture is defined by three parameters, <code class="code docutils literal notranslate"><span class="pre">aper1</span></code> for the horizontal
half width out to the point of a full rhombus, and <code class="code docutils literal notranslate"><span class="pre">aper2</span></code> for the vertical half width,
again out the point of a full rhombus. <code class="code docutils literal notranslate"><span class="pre">aper3</span></code> optionally defines the radius of
a circle used for the curved corners. Therefore, a small amount of width is lost at each tip.
The figure shows a rhombus where <code class="code docutils literal notranslate"><span class="pre">aper1</span> <span class="pre">=</span> <span class="pre">aper2</span></code>, however, these can be unequal.
The beam pipe thickness is added outside this aperture.</p>
<p><strong>Example</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span><span class="p">:</span> <span class="n">drift</span><span class="p">,</span> <span class="n">aperType</span><span class="o">=</span><span class="s2">&quot;rhombus&quot;</span><span class="p">,</span>
           <span class="n">aper1</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
           <span class="n">aper2</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
           <span class="n">aper3</span><span class="o">=</span><span class="mf">0.1</span><span class="o">*</span><span class="n">cm</span>
           <span class="n">beampipeThickness</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="n">mm</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="pointsfile">
<h3>pointsfile<a class="headerlink" href="#pointsfile" title="Link to this heading"></a></h3>
<p>For <strong>pointsfile</strong>, a text file can be used to list a set of x,y transverse points to specify
a custom shape. No other aperture parameters are required other than the aperture type. The
syntax is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pointsfile</span><span class="p">:</span><span class="n">filename</span><span class="o">.</span><span class="n">dat</span><span class="p">:</span><span class="n">units</span>
</pre></div>
</div>
<p>The string should contain no spaces and the values separated by colons <code class="code docutils literal notranslate"><span class="pre">:</span></code>. The second
colon and units are optional and if not supplied will be mm.</p>
<ul class="simple">
<li><p>At least 3 points are required</p></li>
<li><p>Each line should contain only 2 numbers</p></li>
<li><p>Empty lines will be ignored</p></li>
<li><p>Lines starting with <code class="code docutils literal notranslate"><span class="pre">!</span></code> or <code class="code docutils literal notranslate"><span class="pre">#</span></code> will be ignored.</p></li>
<li><p>Examples can be found in <code class="code docutils literal notranslate"><span class="pre">bdsim/examples/features/geometry/3_beampipes/12_pointsfile.gmad</span></code>.</p></li>
<li><p>The last point must not be duplicated.</p></li>
<li><p>The polygon given by the 2D points may be either clockwise or anti-clockwise wound
(the order of the points) and BDSIM will internally make it clockwise, which is
necessary to calculate the expansion of the polygon for the beam pipe shape.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">d1</span><span class="p">:</span> <span class="n">drift</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mf">0.2</span><span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">apertureType</span><span class="o">=</span><span class="s2">&quot;pointsfile:12_points.dat:cm&quot;</span><span class="p">,</span> <span class="n">beampipeThickness</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">mm</span><span class="p">;</span>
<span class="n">d2</span><span class="p">:</span> <span class="n">drift</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mf">0.2</span><span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">apertureType</span><span class="o">=</span><span class="s2">&quot;pointsfile:12_points.dat&quot;</span><span class="p">,</span> <span class="n">beampipeThickness</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">mm</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The user is entirely responsible for defining an enclosed shape and the points
must not define lines that cross each other (self-intersecting). The shape may be non-convex.
If the shape does not show in the visualiser, check for warnings from Geant4
that would indicate the shape is badly formed.</p>
</div>
<p>The example in <code class="code docutils literal notranslate"><span class="pre">bdsim/examples/features/geometry/3_beampipes/12_points.dat</span></code> is generated
by the accompanying Python script <code class="code docutils literal notranslate"><span class="pre">createPoints.py</span></code>. It creates a circle of some radius
with an oscillating boundary. This results in a star shape. The file contents are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">3.0</span>     <span class="mf">0.0</span>
<span class="mf">3.5594944939586357</span>      <span class="mf">0.44966872700413885</span>
<span class="mf">3.8269268103510368</span>      <span class="mf">0.982587799219406</span>
<span class="mf">3.6735994432667844</span>      <span class="mf">1.4544809126930356</span>
<span class="mf">3.144000183146753</span>       <span class="mf">1.7284287271798486</span>
<span class="mf">2.4270509831248424</span>      <span class="mf">1.7633557568774194</span>
<span class="mf">1.7584288736820426</span>      <span class="mf">1.6512746244216896</span>
<span class="mf">1.3060457301527224</span>      <span class="mf">1.5787380878937436</span>
<span class="mf">1.0978788199666678</span>      <span class="mf">1.7299802010673848</span>
<span class="mf">1.0270710863817312</span>      <span class="mf">2.1826371600832646</span>
<span class="mf">0.9270509831248422</span>      <span class="mf">2.85316954888546</span>
<span class="mf">0.6722839170258389</span>      <span class="mf">3.524235711679308</span>
<span class="mf">0.2480888913478514</span>      <span class="mf">3.943260008793256</span>
<span class="o">-</span><span class="mf">0.2480888913478518</span>     <span class="mf">3.943260008793256</span>
<span class="o">-</span><span class="mf">0.67228391702584</span>       <span class="mf">3.524235711679308</span>
<span class="o">-</span><span class="mf">0.9270509831248428</span>     <span class="mf">2.853169548885461</span>
<span class="o">-</span><span class="mf">1.0270710863817316</span>     <span class="mf">2.1826371600832646</span>
<span class="o">-</span><span class="mf">1.097878819966668</span>      <span class="mf">1.7299802010673846</span>
<span class="o">-</span><span class="mf">1.3060457301527224</span>     <span class="mf">1.5787380878937436</span>
<span class="o">-</span><span class="mf">1.7584288736820426</span>     <span class="mf">1.651274624421689</span>
<span class="o">-</span><span class="mf">2.4270509831248415</span>     <span class="mf">1.7633557568774194</span>
<span class="o">-</span><span class="mf">3.144000183146753</span>      <span class="mf">1.7284287271798482</span>
<span class="o">-</span><span class="mf">3.673599443266785</span>      <span class="mf">1.4544809126930345</span>
<span class="o">-</span><span class="mf">3.8269268103510368</span>     <span class="mf">0.982587799219406</span>
<span class="o">-</span><span class="mf">3.559494493958636</span>      <span class="mf">0.4496687270041383</span>
<span class="o">-</span><span class="mf">3.0000000000000004</span>     <span class="o">-</span><span class="mf">9.64873589805982e-16</span>
<span class="o">-</span><span class="mf">2.393193713928232</span>      <span class="o">-</span><span class="mf">0.3023306743816869</span>
<span class="o">-</span><span class="mf">1.98457215642075</span>       <span class="o">-</span><span class="mf">0.5095515237697232</span>
<span class="o">-</span><span class="mf">1.9050594720627234</span>     <span class="o">-</span><span class="mf">0.7542664034150331</span>
<span class="o">-</span><span class="mf">2.113839897116428</span>      <span class="o">-</span><span class="mf">1.162093317430443</span>
<span class="o">-</span><span class="mf">2.427050983124841</span>      <span class="o">-</span><span class="mf">1.7633557568774196</span>
<span class="o">-</span><span class="mf">2.6153828908464263</span>     <span class="o">-</span><span class="mf">2.4560080111504425</span>
<span class="o">-</span><span class="mf">2.518498208339415</span>      <span class="o">-</span><span class="mf">3.044341368760992</span>
<span class="o">-</span><span class="mf">2.117081949907311</span>      <span class="o">-</span><span class="mf">3.3359873519447065</span>
<span class="o">-</span><span class="mf">1.5276046630087032</span>     <span class="o">-</span><span class="mf">3.246325154712854</span>
<span class="o">-</span><span class="mf">0.9270509831248429</span>     <span class="o">-</span><span class="mf">2.8531695488854614</span>
<span class="o">-</span><span class="mf">0.4520039704885086</span>     <span class="o">-</span><span class="mf">2.3694877926928246</span>
<span class="o">-</span><span class="mf">0.12865422582802818</span>    <span class="o">-</span><span class="mf">2.044900361776374</span>
<span class="mf">0.12865422582802924</span>     <span class="o">-</span><span class="mf">2.0449003617763735</span>
<span class="mf">0.45200397048850954</span>     <span class="o">-</span><span class="mf">2.3694877926928233</span>
<span class="mf">0.9270509831248415</span>      <span class="o">-</span><span class="mf">2.85316954888546</span>
<span class="mf">1.5276046630087043</span>      <span class="o">-</span><span class="mf">3.2463251547128524</span>
<span class="mf">2.1170819499073117</span>      <span class="o">-</span><span class="mf">3.335987351944705</span>
<span class="mf">2.5184982083394165</span>      <span class="o">-</span><span class="mf">3.044341368760991</span>
<span class="mf">2.615382890846429</span>       <span class="o">-</span><span class="mf">2.456008011150442</span>
<span class="mf">2.4270509831248446</span>      <span class="o">-</span><span class="mf">1.7633557568774183</span>
<span class="mf">2.1138398971164296</span>      <span class="o">-</span><span class="mf">1.1620933174304438</span>
<span class="mf">1.9050594720627243</span>      <span class="o">-</span><span class="mf">0.7542664034150321</span>
<span class="mf">1.9845721564207497</span>      <span class="o">-</span><span class="mf">0.509551523769722</span>
<span class="mf">2.3931937139282304</span>      <span class="o">-</span><span class="mf">0.3023306743816855</span>
</pre></div>
</div>
<p>And this looks like:</p>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/12_pointsfile1.png"><img alt="_images/12_pointsfile1.png" src="_images/12_pointsfile1.png" style="width: 50%;" /></a>
</figure>
</section>
</section>
<section id="magnet-geometry-parameters">
<span id="id8"></span><h2>Magnet Geometry Parameters<a class="headerlink" href="#magnet-geometry-parameters" title="Link to this heading"></a></h2>
<p>As well as the beam pipe, magnet beam line elements also have further outer geometry beyond the
beam pipe. This geometry typically represents the magnetic poles and yoke of the magnet but there
are several geometry types to choose from. The possible different styles are described below and
syntax <strong>examples</strong> can be found in <em>examples/features/geometry/4_magnets/</em>. These are:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#mag-geom-none"><span class="std std-ref">No Magnet Outer Geometry - “none”</span></a></p></li>
<li><p><a class="reference internal" href="#mag-geom-cylindrical"><span class="std std-ref">Cylindrical - “cylindrical”</span></a></p></li>
<li><p><a class="reference internal" href="#mag-geom-polescircular"><span class="std std-ref">Poles Circular - “polescircular”</span></a></p></li>
<li><p><a class="reference internal" href="#mag-geom-polessquare"><span class="std std-ref">Poles Square (Default) - “polessquare”</span></a></p></li>
<li><p><a class="reference internal" href="#mag-geom-polesfacet"><span class="std std-ref">Poles Faceted - “polesfacet”</span></a></p></li>
<li><p><a class="reference internal" href="#mag-geom-polesfacetcrop"><span class="std std-ref">Poles Faceted with Crop - “polesfacetcrop”</span></a></p></li>
<li><p><a class="reference internal" href="#mag-geom-lhc"><span class="std std-ref">LHC Left &amp; Right - “lhcleft” | “lhcright”</span></a></p></li>
<li><p><a class="reference internal" href="#external-magnet-geometry"><span class="std std-ref">External Magnet Geometry</span></a> (e.g. a GDML file for the yoke)</p></li>
</ul>
<p>The magnet geometry is controlled by the following parameters.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These can all be specified using the <cite>option</cite> command as well as on a per element
basis, but in this case they act as a default that will be used if none are
specified by the element.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The option <code class="code docutils literal notranslate"><span class="pre">ignoreLocalMagnetGeometry</span></code> exists and if it is true (1), <strong>all</strong>
per-element magnet geometry definitions will be ignored and the ones specified
in Options will be used.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the case that the <cite>lhcleft</cite> or <cite>lhcright</cite> magnet geometry types are used,
the yoke field will be a sum of two regular yoke fields at the LHC beam pipe
separation. The option <code class="code docutils literal notranslate"><span class="pre">yokeFieldsMatchLHCGeometry</span></code> can be used to control
this. These are described in <a class="reference internal" href="dev_fields.html#fields-multipole-outer-lhc"><span class="std std-ref">Multipole Yoke - Dual</span></a>.</p>
</div>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Required</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><cite>magnetGeometryType</cite></p></td>
<td><div class="line-block">
<div class="line">The style of magnet geometry to use. One of:</div>
<div class="line"><cite>cylindrical</cite>, <cite>polescircular</cite>, <cite>polessquare</cite>,</div>
<div class="line"><cite>polesfacet</cite>, <cite>polesfacetcrop</cite>, <cite>lhcleft</cite>, <cite>lhcright</cite>,</div>
<div class="line"><cite>none</cite> and <cite>format:path</cite>.</div>
</div>
</td>
<td><p><cite>polessquare</cite></p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p><cite>horizontalWidth</cite></p></td>
<td><div class="line-block">
<div class="line"><strong>Full</strong> horizontal width of the magnet (m)</div>
</div>
</td>
<td><p>0.6 m</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-even"><td><p><cite>outerMaterial</cite></p></td>
<td><div class="line-block">
<div class="line">Material of the magnet</div>
</div>
</td>
<td><p>“iron”</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p><cite>yokeOnInside</cite></p></td>
<td><div class="line-block">
<div class="line">Whether the yoke of a dipole appears on the inside of the</div>
<div class="line">bend and if false, it’s on the outside. Applicable only</div>
<div class="line">to dipoles.</div>
</div>
</td>
<td><p>1</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-even"><td><p><cite>hStyle</cite></p></td>
<td><div class="line-block">
<div class="line">Whether a dipole (only a dipole) will be an H style one</div>
<div class="line">or a C style one (c style by default. True (‘1’) or False</div>
<div class="line">(‘0’).</div>
</div>
</td>
<td><p>0</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p><cite>vhRatio</cite></p></td>
<td><div class="line-block">
<div class="line">The vertical to horizontal ratio of a magnet. The width</div>
<div class="line">will always be the <cite>horizontalWidth</cite> and the height will</div>
<div class="line">scale according to this ratio. In the case of a vertical</div>
<div class="line">kicker it will be the height that is <cite>horizontalWidth</cite> (as</div>
<div class="line">the geometry is simply rotated). Ranges from 0.1 to 10.</div>
<div class="line">This currently <strong>only</strong> applies to dipoles with poled</div>
<div class="line">geometry.</div>
</div>
</td>
<td><p>0.8</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-even"><td><p><cite>coilWidthFraction</cite></p></td>
<td><div class="line-block">
<div class="line">Fraction of the available horizontal space between the</div>
<div class="line">pole and the yoke for dipole geometry that the coil will</div>
<div class="line">occupy. This currently only applies to dipoles with poled</div>
<div class="line">geometry. Ranges from 0.05 to 0.98.</div>
</div>
</td>
<td><p>0.9</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p><cite>coilHeightFraction</cite></p></td>
<td><div class="line-block">
<div class="line">Fraction of the available vertical space between the pole</div>
<div class="line">tip and the yoke for dipole geometry that the coil will</div>
<div class="line">occupy. This currently only applies to dipoles with poled</div>
<div class="line">geometry. Ranges from 0.05 to 0.98.</div>
</div>
</td>
<td><p>0.9</p></td>
<td><p>No</p></td>
</tr>
</tbody>
</table>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">option</span><span class="p">,</span> <span class="n">magnetGeometryType</span> <span class="o">=</span> <span class="s2">&quot;polesfacetcrop&quot;</span><span class="p">,</span>
        <span class="n">horizontalWidth</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">m</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">m1</span><span class="p">:</span> <span class="n">quadrupole</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mf">0.3</span><span class="o">*</span><span class="n">m</span><span class="p">,</span>
                <span class="n">k1</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span>
                <span class="n">magnetGeometryType</span><span class="o">=</span><span class="s2">&quot;gdml:geometryfiles/quad.gdml&quot;</span><span class="p">,</span>
                <span class="n">horizontalWidth</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">m</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The choice of magnet outer geometry will significantly affect the beam loss pattern in the
simulation, as particles and radiation may propagate much further along the beam line when
a magnet geometry with poles is used.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Use of “lhcleft” or “lhcright” will result in the <code class="code docutils literal notranslate"><span class="pre">outerMaterial</span></code> parameter being
ignored and the correct LHC materials being used. The secondary beam pipe included with this
will always be the correct LHC arc aperture and all materials are at 2K.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Should a custom selection of various magnet styles be required for your simulation, please
contact us (see <a class="reference internal" href="support.html#feature-request"><span class="std std-ref">Feature Request</span></a>) and this can be added - it is a relatively simple process.</p>
</div>
<section id="no-magnet-outer-geometry-none">
<span id="mag-geom-none"></span><h3>No Magnet Outer Geometry - “<cite>none</cite>”<a class="headerlink" href="#no-magnet-outer-geometry-none" title="Link to this heading"></a></h3>
<p>No geometry for the magnet outer part is built at all and nothing is placed in the model. This results
in only a beam pipe with the correct fields being provided.</p>
<a class="reference internal image-reference" href="_images/none_beamline.png"><img alt="_images/none_beamline.png" class="align-center" src="_images/none_beamline.png" style="width: 60%;" /></a>
</section>
<section id="cylindrical-cylindrical">
<span id="mag-geom-cylindrical"></span><h3>Cylindrical - “<cite>cylindrical</cite>”<a class="headerlink" href="#cylindrical-cylindrical" title="Link to this heading"></a></h3>
<p>The beam pipe is surrounded by a cylinder of material (the default is iron) whose outer diameter
is controlled by the <cite>horizontalWidth</cite> parameter. In the case of beam pipes that are not circular
in cross-section, the cylinder fits directly against the outside of the beam pipe.</p>
<p>This geometry is useful when a specific geometry is not known. The surrounding
magnet volume acts to produce secondary radiation as well as act as material for energy deposition,
therefore this geometry is best suited for the most general studies.</p>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/cylindrical_quadrupole.png"><img alt="_images/cylindrical_quadrupole.png" src="_images/cylindrical_quadrupole.png" style="width: 40%;" /></a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/cylindrical_sextupole.png"><img alt="_images/cylindrical_sextupole.png" src="_images/cylindrical_sextupole.png" style="width: 40%;" /></a>
</figure>
</section>
<section id="poles-circular-polescircular">
<span id="mag-geom-polescircular"></span><h3>Poles Circular - “<cite>polescircular</cite>”<a class="headerlink" href="#poles-circular-polescircular" title="Link to this heading"></a></h3>
<p>This magnet geometry has simple iron poles according to the order of the magnet and the yoke is
represented by an annulus. Currently no coils are implemented. If a non-symmetric beam pipe
geometry is used, the larger of the horizontal and vertical dimensions of the beam pipe will be
used to create the circular aperture at the pole tips.</p>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/polescircular_quadrupole.png"><img alt="_images/polescircular_quadrupole.png" src="_images/polescircular_quadrupole.png" style="width: 40%;" /></a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/polescircular_quadrupole_3d.png"><img alt="_images/polescircular_quadrupole_3d.png" src="_images/polescircular_quadrupole_3d.png" style="width: 40%;" /></a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/polescircular_sextupole.png"><img alt="_images/polescircular_sextupole.png" src="_images/polescircular_sextupole.png" style="width: 40%;" /></a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/polescircular_sextupole_3d.png"><img alt="_images/polescircular_sextupole_3d.png" src="_images/polescircular_sextupole_3d.png" style="width: 40%;" /></a>
</figure>
</section>
<section id="poles-square-default-polessquare">
<span id="mag-geom-polessquare"></span><h3>Poles Square (Default) - “<cite>polessquare</cite>”<a class="headerlink" href="#poles-square-default-polessquare" title="Link to this heading"></a></h3>
<p>This magnet geometry has again, individual poles according to the order of the magnet but the
yoke is an upright square section to which the poles are attached. This geometry behaves in the
same way as <cite>polescircular</cite> with regard to the beam pipe size.</p>
<p><cite>horizontalWidth</cite> is the full width of the magnet horizontally as shown in the figure below,
<strong>not</strong> the diagonal width.</p>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/polessquare_quadrupole.png"><img alt="_images/polessquare_quadrupole.png" src="_images/polessquare_quadrupole.png" style="width: 40%;" /></a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/polessquare_quadrupole_3d.png"><img alt="_images/polessquare_quadrupole_3d.png" src="_images/polessquare_quadrupole_3d.png" style="width: 40%;" /></a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/polessquare_sextupole.png"><img alt="_images/polessquare_sextupole.png" src="_images/polessquare_sextupole.png" style="width: 40%;" /></a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/polessquare_sextupole_3d.png"><img alt="_images/polessquare_sextupole_3d.png" src="_images/polessquare_sextupole_3d.png" style="width: 40%;" /></a>
</figure>
</section>
<section id="poles-faceted-polesfacet">
<span id="mag-geom-polesfacet"></span><h3>Poles Faceted - “<cite>polesfacet</cite>”<a class="headerlink" href="#poles-faceted-polesfacet" title="Link to this heading"></a></h3>
<p>This magnet geometry is much like <cite>polessquare</cite>; however, the yoke is such that the pole always
joins at a flat piece of yoke and not in a corner. This geometry behaves in the
same way as <cite>polescircular</cite> with regards to the beam pipe size.</p>
<p><cite>horizontalWidth</cite> is the full width as shown in the figure.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>In Geant4 V11.0, the visualiser cannot handle the Boolean solids created by this
geometry and the poles appear invisible. They are in-fact there, but the Geant4
visualisation system cannot make the 3D meshes for the visualisation.</p>
</div>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/polesfacet_quadrupole.png"><img alt="_images/polesfacet_quadrupole.png" src="_images/polesfacet_quadrupole.png" style="width: 40%;" /></a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/polesfacet_quadrupole_3d.png"><img alt="_images/polesfacet_quadrupole_3d.png" src="_images/polesfacet_quadrupole_3d.png" style="width: 40%;" /></a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/polesfacet_sextupole.png"><img alt="_images/polesfacet_sextupole.png" src="_images/polesfacet_sextupole.png" style="width: 40%;" /></a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/polesfacet_sextupole_3d.png"><img alt="_images/polesfacet_sextupole_3d.png" src="_images/polesfacet_sextupole_3d.png" style="width: 40%;" /></a>
</figure>
</section>
<section id="poles-faceted-with-crop-polesfacetcrop">
<span id="mag-geom-polesfacetcrop"></span><h3>Poles Faceted with Crop - “<cite>polesfacetcrop</cite>”<a class="headerlink" href="#poles-faceted-with-crop-polesfacetcrop" title="Link to this heading"></a></h3>
<p>This magnet geometry is quite similar to <cite>polesfacet</cite>, but the yoke in between each
pole is cropped to form another facet. This results in the magnet geometry having
double the number of poles as sides.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The poles in this geometry may not appear in the visualiser when
using Geant4 V11. This is because of limitations introduced in the
Geant4 visualiser Boolean processing engine. The geometry is still there,
but just the visualiser can’t generate a 3D mesh for it.</p>
</div>
<p><cite>horizontalWidth</cite> is the full width horizontally as shown in the figure.</p>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/polesfacetcrop_quadrupole.png"><img alt="_images/polesfacetcrop_quadrupole.png" src="_images/polesfacetcrop_quadrupole.png" style="width: 40%;" /></a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/polesfacetcrop_quadrupole_3d.png"><img alt="_images/polesfacetcrop_quadrupole_3d.png" src="_images/polesfacetcrop_quadrupole_3d.png" style="width: 40%;" /></a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/polesfacetcrop_sextupole.png"><img alt="_images/polesfacetcrop_sextupole.png" src="_images/polesfacetcrop_sextupole.png" style="width: 40%;" /></a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/polesfacetcrop_sextupole_3d.png"><img alt="_images/polesfacetcrop_sextupole_3d.png" src="_images/polesfacetcrop_sextupole_3d.png" style="width: 40%;" /></a>
</figure>
</section>
<section id="lhc-left-right-lhcleft-lhcright">
<span id="mag-geom-lhc"></span><h3>LHC Left &amp; Right - “<cite>lhcleft</cite>” | “<cite>lhcright</cite>”<a class="headerlink" href="#lhc-left-right-lhcleft-lhcright" title="Link to this heading"></a></h3>
<p><cite>lhcleft</cite> and <cite>lhcright</cite> provide more detailed magnet geometry appropriate for the LHC. Here, the
left and right suffixes refer to the shift of the magnet body with respect to the reference beam line.
Therefore, <cite>lhcleft</cite> has the magnet body shifted to the left in the direction of beam travel and the
‘active’ beam pipe is the right one. Vice versa for the <cite>lhcright</cite> geometry.</p>
<p>For this geometry, only the <cite>sbend</cite> and <cite>quadrupole</cite> have been implemented.  All other magnet geometry
defaults to the cylindrical set.</p>
<p>This geometry is parameterised to a degree regarding the beam pipe chosen.  Of course, parameters similar
to the LHC make most sense, as does use of the <cite>lhcdetailed</cite> aperture type. Examples are shown with various
beam pipes and both <cite>sbend</cite> and <cite>quadrupole</cite> geometries.</p>
<ul class="simple">
<li><p><code class="code docutils literal notranslate"><span class="pre">outerMaterial</span></code> is ignored with this choice of geometry.</p></li>
</ul>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="_images/lhcleft_sbend.png"><img alt="lhcleft_sbend" src="_images/lhcleft_sbend.png" style="width: 60%;" /></a></p></td>
<td><p><a class="reference internal" href="_images/lhcleft_quadrupole.png"><img alt="lhcleft_quadrupole" src="_images/lhcleft_quadrupole.png" style="width: 60%;" /></a></p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="_images/lhcleft_quadrupole_square.png"><img alt="lhcleft_quadrupole_square" src="_images/lhcleft_quadrupole_square.png" style="width: 60%;" /></a></p></td>
<td><p><a class="reference internal" href="_images/lhcleft_sextupole.png"><img alt="lhcleft_sextupole" src="_images/lhcleft_sextupole.png" style="width: 60%;" /></a></p></td>
</tr>
</tbody>
</table>
</section>
<section id="external-magnet-geometry">
<span id="id9"></span><h3>External Magnet Geometry<a class="headerlink" href="#external-magnet-geometry" title="Link to this heading"></a></h3>
<p>A geometry file may be placed around a beam pipe inside a BDSIM magnet instance. The beam pipe
will be constructed as normal and will use the appropriate BDSIM tracking routines, but the
yoke geometry will be loaded from the file provided. The external geometry <strong>must have a cut out</strong>
in its container volume for the beam pipe to fit, i.e. both the beam pipe and the yoke exist
at the same level in the geometry hierarchy (both are placed in one container for the magnet).
The beam pipe is not placed ‘inside’ the yoke. This is shown schematically below:</p>
<figure class="align-center" id="id23">
<a class="reference internal image-reference" href="_images/magnet-hierarchy-schematic.pdf"><img alt="_images/magnet-hierarchy-schematic.pdf" src="_images/magnet-hierarchy-schematic.pdf" style="width: 100%;" /></a>
<figcaption>
<p><span class="caption-text">Geometrical hierarchy of a magnet. Here, a quadrupole is shown, but all magnets
have the same geometrical structure even if the specific shapes are different.</span><a class="headerlink" href="#id23" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>Therefore, if using a GDML file for the yoke of the magnet (labelled “outer” in the figure),
care should be taken to make the outermost <em>container</em> volume, not just a box, but a box with
a cylinder cut out of it, i.e. a Boolean solid.</p>
<p>This will work for <cite>solenoid</cite>, <cite>sbend</cite>, <cite>rbend</cite>, <cite>quadrupole</cite>, <cite>sextupole</cite>, <cite>octupole</cite>,
<cite>decapole</cite>, <cite>multipole</cite>, <cite>muonspoiler</cite>, <cite>vkicker</cite>, <cite>hkicker</cite> element types in BDSIM.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">q1</span><span class="p">:</span> <span class="n">quadrupole</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">20</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span> <span class="n">k1</span><span class="o">=</span><span class="mf">0.0235</span><span class="p">,</span> <span class="n">magnetGeometryType</span><span class="o">=</span><span class="s2">&quot;gdml:mygeometry/atf2quad.gdml&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">autoColour=1</span></code> can also be used to automatically colour the supplied geometry by
density if desired. This is on by default.  Example to turn it off:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">q1</span><span class="p">:</span> <span class="n">quadrupole</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">20</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span> <span class="n">k1</span><span class="o">=</span><span class="mf">0.0235</span><span class="p">,</span> <span class="n">magnetGeometryType</span><span class="o">=</span><span class="s2">&quot;gdml:mygeometry/atf2quad.gdml&quot;</span><span class="p">,</span> <span class="n">autoColour</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
</section>
</section>
<section id="cavity-geometry-parameters">
<span id="id10"></span><h2>Cavity Geometry Parameters<a class="headerlink" href="#cavity-geometry-parameters" title="Link to this heading"></a></h2>
<p>A more detailed rf cavity geometry may be described by constructing a ‘cavity’ object
in gmad and attaching it by name to an element.  The following parameters may be added
to a cavity object:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Parameter</strong></p></th>
<th class="head"><p><strong>Required</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><cite>name</cite></p></td>
<td><p>Yes</p></td>
<td><p>Name of the object</p></td>
</tr>
<tr class="row-odd"><td><p><cite>type</cite></p></td>
<td><p>Yes</p></td>
<td><p>(elliptical | rectangular | pillbox)</p></td>
</tr>
<tr class="row-even"><td><p><cite>material</cite></p></td>
<td><p>Yes</p></td>
<td><p>The material for the cavity</p></td>
</tr>
<tr class="row-odd"><td><p><cite>irisRadius</cite></p></td>
<td><p>No</p></td>
<td><p>The radius of the narrowest part</p></td>
</tr>
<tr class="row-even"><td><p><cite>equatorRadius</cite></p></td>
<td><p>No</p></td>
<td><p>The radius of the widest part</p></td>
</tr>
<tr class="row-odd"><td><p><cite>halfCellLength</cite></p></td>
<td><p>No</p></td>
<td><p>Half-length along a cell</p></td>
</tr>
<tr class="row-even"><td><p><cite>equatorHorizontalAxis</cite></p></td>
<td><p>Elliptical only</p></td>
<td><p>Horizontal semi-axis of the ellipse at the cavity equator</p></td>
</tr>
<tr class="row-odd"><td><p><cite>equatorVerticalAxis</cite></p></td>
<td><p>Elliptical only</p></td>
<td><p>Vertical semi-axis of the ellipse at the cavity equator</p></td>
</tr>
<tr class="row-even"><td><p><cite>irisHorizontalAxis</cite></p></td>
<td><p>Elliptical only</p></td>
<td><p>Horizontal semi-axis of the ellipse at the iris</p></td>
</tr>
<tr class="row-odd"><td><p><cite>irisVerticalAxis</cite></p></td>
<td><p>Elliptical only</p></td>
<td><p>Vertical semi-axis of the ellipse at the iris</p></td>
</tr>
<tr class="row-even"><td><p><cite>tangentLineAngle</cite></p></td>
<td><p>Elliptical only</p></td>
<td><p>Angle to the vertical line connecting two ellipses</p></td>
</tr>
<tr class="row-odd"><td><p><cite>thickness</cite></p></td>
<td><p>No</p></td>
<td><p>Thickness of material</p></td>
</tr>
<tr class="row-even"><td><p><cite>numberOfPoints</cite></p></td>
<td><p>No</p></td>
<td><p>Number of points to generate around 2 <span class="math notranslate nohighlight">\(\pi\)</span>.</p></td>
</tr>
<tr class="row-odd"><td><p><cite>numberOfCells</cite></p></td>
<td><p>No</p></td>
<td><p>Number of cells to construct</p></td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">shinyCavity</span><span class="p">:</span> <span class="n">cavitymodel</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;elliptical&quot;</span><span class="p">,</span>
                     <span class="n">irisRadius</span> <span class="o">=</span> <span class="mi">35</span><span class="o">*</span><span class="n">mm</span><span class="p">,</span>
                     <span class="n">equatorRadius</span> <span class="o">=</span> <span class="mf">103.3</span><span class="o">*</span><span class="n">mm</span><span class="p">,</span>
                     <span class="n">halfCellLength</span> <span class="o">=</span> <span class="mf">57.7</span><span class="o">*</span><span class="n">mm</span><span class="p">,</span>
                     <span class="n">equatorHorizontalAxis</span> <span class="o">=</span> <span class="mi">40</span><span class="o">*</span><span class="n">mm</span><span class="p">,</span>
                     <span class="n">equatorVerticalAxis</span> <span class="o">=</span> <span class="mi">42</span><span class="o">*</span><span class="n">mm</span><span class="p">,</span>
                     <span class="n">irisHorizontalAxis</span> <span class="o">=</span> <span class="mi">12</span><span class="o">*</span><span class="n">mm</span><span class="p">,</span>
                     <span class="n">irisVerticalAxis</span> <span class="o">=</span> <span class="mi">19</span><span class="o">*</span><span class="n">mm</span><span class="p">,</span>
                     <span class="n">tangentLineAngle</span> <span class="o">=</span> <span class="mf">13.3</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">,</span>
                     <span class="n">thickness</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">mm</span><span class="p">,</span>
                     <span class="n">numberOfPoints</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
                     <span class="n">numberOfCells</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
<figure class="align-center" id="id24">
<a class="reference internal image-reference" href="_images/elliptical-cavity2.png"><img alt="_images/elliptical-cavity2.png" src="_images/elliptical-cavity2.png" style="width: 50%;" /></a>
<figcaption>
<p><span class="caption-text">Elliptical cavity geometry example from <code class="code docutils literal notranslate"><span class="pre">bdsim/examples/features/geometry/12_cavities/rfcavity-geometry-elliptical.gmad</span></code>.</span><a class="headerlink" href="#id24" title="Link to this image"></a></p>
</figcaption>
</figure>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/elliptical-cavity.pdf"><img alt="_images/elliptical-cavity.pdf" src="_images/elliptical-cavity.pdf" style="width: 40%;" /></a>
</figure>
<p>The parameterisation used to define elliptical cavities in BDSIM.
The symbols used in the figure map to the cavity options according to the table below.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Symbol</strong></p></th>
<th class="head"><p><strong>BDSIM Cavity Parameter</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(R\)</span></p></td>
<td><p>equatorRadius</p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(r\)</span></p></td>
<td><p>irisRadius</p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(A\)</span></p></td>
<td><p>equatorHorizontalAxis</p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(B\)</span></p></td>
<td><p>equatorVerticalAxis</p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(a\)</span></p></td>
<td><p>irisHorizontalAxis</p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(b\)</span></p></td>
<td><p>irisVerticalAxis</p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(\alpha\)</span></p></td>
<td><p>tangentLineAngle</p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(L\)</span></p></td>
<td><p>halfCellLength</p></td>
</tr>
</tbody>
</table>
</section>
<section id="externally-provided-geometry">
<span id="id11"></span><h2>Externally Provided Geometry<a class="headerlink" href="#externally-provided-geometry" title="Link to this heading"></a></h2>
<p>BDSIM provides the ability to use externally provided geometry in the Geant4 model constructed
by BDSIM. Different formats are supported (see <a class="reference internal" href="#geometry-formats"><span class="std std-ref">Geometry Formats</span></a>). External
geometry can be used in several ways:</p>
<ol class="arabic simple">
<li><p>A placement of a piece of geometry unrelated to the beam line (see <a class="reference internal" href="#placements"><span class="std std-ref">Placements</span></a>)</p></li>
<li><p>Wrapped around the beam pipe in a BDSIM magnet element (see <a class="reference internal" href="#external-magnet-geometry"><span class="std std-ref">External Magnet Geometry</span></a>)</p></li>
<li><p>As a general element in the beam line where the geometry constitutes the whole object. (see <a class="reference internal" href="model_construction.html#element"><span class="std std-ref">element</span></a>)</p></li>
<li><p>As the world volume in which the BDSIM beamline is placed. (see <a class="reference internal" href="#external-world-geometry"><span class="std std-ref">External World Geometry</span></a>)</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If a given geometry file is reused in different components, it will be reloaded on purpose
to generate a unique set of logical volumes so we have the possibility of different fields,
cuts, regions, colours etc. It will only be loaded once though, if the same component
is used repeatedly. <strong>However</strong>, specifically for a <cite>placement</cite>, this can be overridden
by specifying the parameter <code class="code docutils literal notranslate"><span class="pre">dontReloadGeometry</span></code> in the placement definition -
see <a class="reference internal" href="#placements"><span class="std std-ref">Placements</span></a>.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If including any external geometry, overlaps must be checked in the visualiser by
running <code class="code docutils literal notranslate"><span class="pre">/geometry/test/run</span></code> before the model is used for a physics study.</p>
</div>
<section id="geometry-formats">
<span id="id12"></span><h3>Geometry Formats<a class="headerlink" href="#geometry-formats" title="Link to this heading"></a></h3>
<p>The following geometry formats are supported. More may be added in collaboration with the BDSIM
developers - please see <a class="reference internal" href="support.html#feature-request"><span class="std std-ref">Feature Request</span></a>. The syntax and preparation of these geometry
formats are described in more detail in <a class="reference internal" href="externalgeometry.html#external-geometry-formats"><span class="std std-ref">External Geometry Formats</span></a>.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Format String</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>gdml</p></td>
<td><div class="line-block">
<div class="line">Geometry Description Markup Language - Geant4’s official geometry</div>
<div class="line">persistency format - recommended, maintained and supported</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>mokka</p></td>
<td><div class="line-block">
<div class="line">An SQL style description of geometry - not maintained</div>
</div>
</td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>With the <cite>option, checkOverlaps=1;</cite> turned on, each externally loaded piece of geometry will
also be checked for overlaps.</p></li>
</ul>
</section>
<section id="gdml-geometry-specifics">
<span id="geometry-gdml"></span><h3>GDML Geometry Specifics<a class="headerlink" href="#gdml-geometry-specifics" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>The Geant4 installation that BDSIM is compiled with repsect to must have GDML support turned on.</p></li>
<li><p>BDSIM must be compiled with the GDML build option in CMake turned on for GDML loading to work.</p></li>
</ul>
<section id="auxiliary-colour-information">
<h4>Auxiliary Colour Information<a class="headerlink" href="#auxiliary-colour-information" title="Link to this heading"></a></h4>
<p>When preparing a GDML file for input to BDSIM, you can supply extra information in the form of
an auxiliary tag in GDML. This is attached the <code class="code docutils literal notranslate"><span class="pre">volume</span></code> and an example is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">volume</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;q2_outer_pole_lv0x600003006e40&quot;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">materialref</span> <span class="n">ref</span><span class="o">=</span><span class="s2">&quot;G4_Fe0x147912550&quot;</span><span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="n">solidref</span> <span class="n">ref</span><span class="o">=</span><span class="s2">&quot;q2_outer_pole_solid0x600003006bc0&quot;</span><span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="n">auxiliary</span> <span class="n">auxtype</span><span class="o">=</span><span class="s2">&quot;bds_vrgba&quot;</span> <span class="n">auxvalue</span><span class="o">=</span><span class="s2">&quot;1 0.82 0.1 0.1 1&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">volume</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The format should be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">auxiliary</span> <span class="n">auxtype</span><span class="o">=</span><span class="s2">&quot;bds_vrgba&quot;</span> <span class="n">auxvalue</span><span class="o">=</span><span class="s2">&quot;v r g b a&quot;</span><span class="o">/&gt;</span>
</pre></div>
</div>
<p>where <code class="code docutils literal notranslate"><span class="pre">v</span></code> is a 1 or 0 for visible or not. <code class="code docutils literal notranslate"><span class="pre">r</span> <span class="pre">g</span> <span class="pre">b</span> <span class="pre">a</span></code> are double values for the
normalised red green blue and alpha colour components. These should range from 0 to 1 (inclusive).</p>
</section>
<section id="creating-gdml-geometry">
<h4>Creating GDML Geometry<a class="headerlink" href="#creating-gdml-geometry" title="Link to this heading"></a></h4>
<p>To create customised geometry, we recommend our separate (free) Python package, <strong>pyg4ometry</strong>. This
is a Python package that can be used in a script to create Geant4 or FLUKA geometry or convert
it into GDML and has many examples. It can also be used to <strong>check for overlaps</strong> in any GDML file
and validate geometry.</p>
<p>See <a class="reference internal" href="python_utilities.html#python-geometry-preparation"><span class="std std-ref">Geometry Preparation</span></a> for details and links to the software and manual. This
package is used for many of the examples included with BDSIM and the Python scripts are
included with the examples.</p>
</section>
<section id="material-names-and-usage">
<h4>Material Names And Usage<a class="headerlink" href="#material-names-and-usage" title="Link to this heading"></a></h4>
<p>Rules for materials in a GDML file:</p>
<ul class="simple">
<li><p>A NIST material (e.g. <code class="code docutils literal notranslate"><span class="pre">G4_AIR</span></code>) may be used by name without full definition. The XML
validator may warning that they are undefined - this is ok as true, but they will be available
at runtime.</p></li>
<li><p>A BDSIM predefined material (or indeed one defined in the input GMAD) may be used by name
without a full definition in a GDML file. Similarly, there may be a warning from the XML
validator, but the material will be available at run time.</p></li>
<li><p>A BDSIM material by one of it’s aliases in BDSIM may be used by name, similarly.</p></li>
<li><p>It is allowed to define a material inside a GDML file with the same name as one in BDSIM
as the GDML preprocessor (see below) will change the name.</p></li>
<li><p>Do not define a material fully but with the same name as a NIST material. Whilst Geant4
will construct the material when loading the GDML file, it will attach the material by
<strong>name</strong> and may not find your material definition from the GDML file.</p></li>
</ul>
<p>BDSIM will exit if a conflict in naming (and therefore ambiguous materials could be set)
is found.</p>
</section>
<section id="gdml-preprocessing">
<span id="geometry-gdml-preprocessing"></span><h4>GDML Preprocessing<a class="headerlink" href="#gdml-preprocessing" title="Link to this heading"></a></h4>
<p>Geant4’s GDML loader, which BDSIM uses to load GDML files, was only designed to use 1 GDML file.
Unlike Geant4’s C++ classes where names to do not matter, in GDML, each object is identified by
name. An example of some GDML defining solids is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">solids</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">box</span> <span class="n">lunit</span><span class="o">=</span><span class="s2">&quot;mm&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;box&quot;</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;20&quot;</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;30&quot;</span> <span class="n">z</span><span class="o">=</span><span class="s2">&quot;40&quot;</span><span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="n">box</span> <span class="n">lunit</span><span class="o">=</span><span class="s2">&quot;mm&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;world&quot;</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;200&quot;</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;200&quot;</span> <span class="n">z</span><span class="o">=</span><span class="s2">&quot;200&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">solids</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>When loading a file, if Geant4 finds an object in memory (Geant4’s registries of objects)
already with that name, it uses that object instead of reading the one from the file. e.g. in
this case, another solid with the name “box”. This can have the unintended consequence of
thinking you are loading a piece of geometry but getting a completely different piece! This
can cause overlaps, bad tracking and an incorrect model and results. Worse still, it may go unseen.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If including any external geometry, overlaps must be checked in the visualiser by
running <code class="code docutils literal notranslate"><span class="pre">/geometry/test/run</span></code> before the model is used for a physics study.</p>
</div>
<p>The most common use of Geant4 is for a detector model where the entire model is written
in 1 GDML file, hence this design in Geant4.</p>
<p>However, in BDSIM, we may wish to piece together (like LEGO bricks) many pieces of
geometry in and around an accelerator. To compensate for this Geant4 behaviour,
we <strong>preprocess</strong> a GDML file. This means, we create a temporary copy of the file,
and change all the names adding a unique string to the beginning of them all - typically
the element or placement the GDML file will be used in. This allows us to load multiple
files with possibly degenerate names safely.</p>
<p>For each name we change, we must check for any uses elsewhere in the file. Therefore,
this can be a <span class="math notranslate nohighlight">\(O(N^2)\)</span> problem with the number of names. In the case of a GDML
file that includes a large tessellated solid, each individual 3-vector position is
written with it’s own name and this vastly increases the number of names to process.</p>
<p>In this case, it is possible to <strong>keep the temporary *preprocessed* file</strong> and edit the
input GMAD file to use this new file. However, this strategy means that if the GDML
file is updated, it has to be preprocessed again and copied and the input edited (not ideal).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">option</span><span class="p">,</span> <span class="n">preprocessGDML</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>The <strong>Schema</strong> is a set of rules of what is allowed in the GDML file that generally uses the
XML syntax. It defines which <em>tags</em> are allowed and what parameters they can have. This is
directed to by the URL at the very top of the file and is found online.  e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;?xml version=&quot;1.0&quot; ?&gt;
&lt;gdml xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:noNamespaceSchemaLocation=&quot;http://service-spi.web.cern.ch/service-spi/app/releases/GDML/schema/gdml.xsd&quot;&gt;
</pre></div>
</div>
<p>If however, you need <strong>offline access</strong>, then BDSIM includes a copy of the latest GDML Schema.
During the preprocessing, this is automatically substituted for the one included with BDSIM.
If you use a custom Schema or do not wish to use this feature, it can be turned off with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">option</span><span class="p">,</span> <span class="n">preprocessGDMLSchema</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>This is independent of the <code class="code docutils literal notranslate"><span class="pre">preprocessGDML</span></code> option above, i.e. with that turned off, but
<cite>preprocessGDMLSchema</cite> on (by default), we can preprocess only the Schema location.</p>
<ul class="simple">
<li><p>BDSIM will put the preprocessed GDML files in a temporary directory and remove
them once finished. The temporary files can be retained by using the option
<code class="code docutils literal notranslate"><span class="pre">option,</span> <span class="pre">removeTemporaryFiles=0;</span></code>.</p></li>
<li><p>BDSIM will create a temporary directory based on the template name “bdsim_XXXXXX” where the
X characters will be replaced by a randomly generated alpha-numeric sequence from the system
using <cite>mkdtemp</cite>.</p></li>
<li><p>BDSIM will try <code class="code docutils literal notranslate"><span class="pre">/tmp/</span></code>, then <code class="code docutils literal notranslate"><span class="pre">/temp/</span></code>, then the current working directory in that
order to create the temporary directory. This behaviour can be overridden by specifying the option
<code class="code docutils literal notranslate"><span class="pre">option,</span> <span class="pre">temporaryDirectory=&quot;/path/to/desired/directory&quot;</span></code>. <code class="code docutils literal notranslate"><span class="pre">&quot;./&quot;</span></code> could be used
for example for the current working directory.</p></li>
</ul>
<p>The BDSIM GDML preprocessor has some limitations. We cannot support variables in values.
In this case, the user should load a GDML file with Geant4 and re-export it. This will
‘flatten’ / resolve any variables, e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">variable</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;offsetX&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s2">&quot;3&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">position</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;offsetX+3&quot;</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;0&quot;</span> <span class="n">z</span><span class="o">=</span><span class="s2">&quot;-3|/&gt;</span>
</pre></div>
</div>
<p>would not work, as the <em>variable</em> “offsetX” is referred to in the <em>value</em> “x” in the position tag.</p>
</section>
</section>
<section id="external-world-geometry">
<span id="id13"></span><h3>External World Geometry<a class="headerlink" href="#external-world-geometry" title="Link to this heading"></a></h3>
<p>External geometry can be supplied as the world volume with the option <cite>worldGeometryFile</cite>
(see <a class="reference internal" href="model_control.html#options-geometry"><span class="std std-ref">Geometry Options</span></a>). The BDSIM beamline will be placed inside this world volume
provided in the file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">option</span><span class="p">,</span> <span class="n">worldGeometryFile</span><span class="o">=</span><span class="s2">&quot;gdml:myworld.gdml&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>Unlike the standard BDSIM world volume whose size is
set dynamically, the external world volume will have fixed dimensions, therefore the user should supply
a world volume of sufficient size so as to fully encompass the BDSIM beamline. Should the extents of the
BDSIM beamline be larger than the world extents, the beamline will not be constructed and BDSIM will exit.</p>
<p><cite>worldGeometryFile</cite> should be of the format <cite>format:filename</cite>, where <cite>format</cite> is the geometry
format being used (<cite>gdml</cite> | <cite>gmad</cite> | <cite>mokka</cite>) and filename is the path to the geometry
file. See <a class="reference internal" href="#externally-provided-geometry"><span class="std std-ref">Externally Provided Geometry</span></a> for more details.</p>
<ul class="simple">
<li><p>See also <a class="reference internal" href="model_control.html#physics-bias-importance-sampling"><span class="std std-ref">Geometric Importance Sampling</span></a> for usage of this.</p></li>
<li><p>The world <strong>material</strong> will be taken from the GDML file and the option <code class="code docutils literal notranslate"><span class="pre">worldMaterial</span></code>
will be ignored. If the option <code class="code docutils literal notranslate"><span class="pre">worldMaterial</span></code> is specified as well as
<code class="code docutils literal notranslate"><span class="pre">worldGeometryFile</span></code>, BDSIM will issue a warning but proceed.</p></li>
<li><p>The option <code class="code docutils literal notranslate"><span class="pre">autoColourWorldGeometryFile</span></code> can be used (default true) to colour
the supplied geometry by density. See <a class="reference internal" href="#automatic-colours"><span class="std std-ref">Automatic Colours</span></a> for details.</p></li>
<li><p>The option <code class="code docutils literal notranslate"><span class="pre">biasForWorldContents</span></code> may be used to attach a bias object to the
daughter volumes (i.e. excluding the world volume itself) of the loaded world geometry.
This is useful for shielding.</p></li>
<li><p>The option <code class="code docutils literal notranslate"><span class="pre">biasForWorldVolume</span></code> may be used to attach a bias object to the world
volume itself (only). See <a class="reference internal" href="model_control.html#physics-biasing"><span class="std std-ref">Physics Biasing</span></a> for details.</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Be careful to avoid name clashing if loading multiple GDML files including the world.
The usual preprocessGDML option is on to protect against this, but should the user wish,
this can be turned off for quicker loading times. The user must therefore ensure no
name clashing (i.e. degenerate names for anything between GDML files).</p>
</div>
</section>
</section>
<section id="placements">
<span id="id14"></span><h2>Placements<a class="headerlink" href="#placements" title="Link to this heading"></a></h2>
<p>Aside from a beam line, pieces of geometry may be placed at any location in the world with
any orientation. The mechanism to do this in BDSIM is called “placements”. Either an
externally provided piece of geometry (e.g. GDML file and optional field map) or a BDSIM
provided accelerator component can be placed by declaring a <code class="code docutils literal notranslate"><span class="pre">placement</span></code> object in
the input.</p>
<p>For geometry to be placed as part of the beam line, use the <a class="reference internal" href="model_construction.html#element"><span class="std std-ref">element</span></a> component in a line.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If the geometry overlaps, tracking faults may occur from Geant4 as well as
incorrect results and there may not always be warnings provided. For this reason,
BDSIM will <strong>always</strong> use the Geant4 overlap checker when placing external geometry
into the world volume. This only ensures the container doesn’t overlap with BDSIM
geometry, not that the internal geometry is valid.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>You cannot place external geometry ‘inside’ an accelerator component with a
placement. Although it may appear OK in the visualiser, the hierarchy of the
geometry will be wrong and the tracking will not work as expected. Avoid this.</p>
</div>
<p>There are 3 possible ways to place a piece of geometry.</p>
<ol class="arabic simple">
<li><p>In global Cartesian coordinates.</p>
<ul class="simple">
<li><p><cite>x</cite>, <cite>y</cite>, <cite>z</cite> and any rotation are with respect to the world frame of reference.</p></li>
</ul>
</li>
<li><p>In curvilinear coordinates.</p>
<ul class="simple">
<li><p><cite>s</cite>, <cite>x</cite>, <cite>y</cite> are used along with a rotation. The transform for the distance <cite>s</cite> along the beamline
is first applied. <cite>x</cite>, <cite>y</cite> and the rotation are with respect to that frame.</p></li>
</ul>
</li>
<li><p>In curvilinear coordinates with respect to a beam line element by name.</p>
<ul class="simple">
<li><p>The name of an element is used to look up its (mid-point) <cite>s</cite> coordinate. <cite>s</cite>, <cite>x</cite>, <cite>y</cite> and the rotation
are with respect to the centre of that element. <strong>Therefore</strong>, <cite>s</cite> in this case is <cite>local</cite> curvilinear
<cite>s</cite>.</p></li>
</ul>
</li>
</ol>
<p>The scenario is automatically selected based on which parameters are set. If <cite>s</cite> is non-zero, then
it is either scenario 2 or 3. If <cite>referenceElement</cite> is specified, scenario 3 is assumed.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>For both scenarios 2) and 3), a placement can only be made <strong>inside</strong> the S length of
the accelerator - it is not possible to place something beyond the accelerator currently.
In this case, the user should resort to a global placement.</p>
</div>
<p>Two styles of rotation can be used: either a set of three Euler angles, or the axis-angle
rotation scheme, where a <strong>unit</strong> vector is provided in <span class="math notranslate nohighlight">\(x,y,z\)</span> and an angle to
rotate about that. The later is usually easier to imagine.</p>
<p>The following parameters may be specified with a placement in BDSIM:</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p><strong>Parameter</strong></p></td>
<td><p><strong>Description</strong></p></td>
</tr>
<tr class="row-even"><td><p>geometryFile</p></td>
<td><p><code class="code docutils literal notranslate"><span class="pre">format:file</span></code> - which geometry format and file to use</p></td>
</tr>
<tr class="row-odd"><td><p>stripOuterVolume</p></td>
<td><p>(1 or 0) if true, then remove and discard the outer logical volume
from the loaded geometry and turn it into an ‘assembly’ volume
with the contents placed with the correct relative transform in
the world.</p></td>
</tr>
<tr class="row-even"><td><p>bdsimElement</p></td>
<td><p>Name of the beam line element defined in the parser to be used</p></td>
</tr>
<tr class="row-odd"><td><p>x</p></td>
<td><p>Offset in global x</p></td>
</tr>
<tr class="row-even"><td><p>y</p></td>
<td><p>Offset in global y</p></td>
</tr>
<tr class="row-odd"><td><p>z</p></td>
<td><p>Offset in global z</p></td>
</tr>
<tr class="row-even"><td><p>s</p></td>
<td><p>Curvilinear s coordinate (global | local depending on parameters)</p></td>
</tr>
<tr class="row-odd"><td><p>phi</p></td>
<td><p>Euler angle phi for rotation</p></td>
</tr>
<tr class="row-even"><td><p>theta</p></td>
<td><p>Euler angle theta for rotation</p></td>
</tr>
<tr class="row-odd"><td><p>psi</p></td>
<td><p>Euler angle psi for rotation</p></td>
</tr>
<tr class="row-even"><td><p>axisX</p></td>
<td><p>Axis angle rotation x-component of unit vector</p></td>
</tr>
<tr class="row-odd"><td><p>axisY</p></td>
<td><p>Axis angle rotation y-component of unit vector</p></td>
</tr>
<tr class="row-even"><td><p>axisZ</p></td>
<td><p>Axis angle rotation z-component of unit vector</p></td>
</tr>
<tr class="row-odd"><td><p>angle</p></td>
<td><p>Axis angle, angle to rotate about unit vector</p></td>
</tr>
<tr class="row-even"><td><p>axisAngle</p></td>
<td><p>Boolean whether to use axis angle rotation scheme (default false)</p></td>
</tr>
<tr class="row-odd"><td><p>sensitive</p></td>
<td><p>Whether the geometry records energy deposition (default true)</p></td>
</tr>
<tr class="row-even"><td><p>referenceElement</p></td>
<td><p>Name of element to place geometry with respect to (string)</p></td>
</tr>
<tr class="row-odd"><td><p>referenceElementNumber</p></td>
<td><p>Occurrence of <cite>referenceElement</cite> to place with respect to if it
is used more than once in the sequence. Zero counting.</p></td>
</tr>
<tr class="row-even"><td><p>autoColour</p></td>
<td><p>Boolean whether the geometry should be automatically coloured by
density if no colour information is supplied. (default true)</p></td>
</tr>
<tr class="row-odd"><td><p>fieldAll</p></td>
<td><p>Name of field object definition to be used as the field for the
whole geometry including all daughter volumes.</p></td>
</tr>
<tr class="row-even"><td><p>dontReloadGeometry</p></td>
<td><p>(Boolean) Purposively circumvent BDSIM’s reloading of the same
geometry file for each placement, i.e. reuse it. This will mean
any cuts or fields or sensitivity will be the same.</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>Only one of <code class="code docutils literal notranslate"><span class="pre">bdsimElement</span></code> or <code class="code docutils literal notranslate"><span class="pre">geometryFile</span></code> should be used in a placement.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">bdsimElement</span></code> should be used to name a component to place. In this case the component
should be defined <strong>before</strong> the placement definition in the input GMAD.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">geometryFile</span></code> should be used to place an externally provided geometry file.</p></li>
<li><p>This is intended to place geometry alongside the beam line and <strong>not</strong> inside or as part of it.</p></li>
<li><p>The user is responsible for ensuring that the geometry does not
overlap with any other geometry including the beam line.</p></li>
<li><p>Only in special cases, such as for a magnet yoke, can externally provided
geometry be placed “inside” BDSIM geometry.</p></li>
<li><p>The geometry may also have a field map overlaid on it.</p></li>
<li><p>Placements cannot be made with respect to other placements.</p></li>
<li><p>There is the possibility to strip off the outermost logical volume and place the contents
with the compound transform in the world. Useful for preparing for example, shielding.
See the parameter below <code class="code docutils literal notranslate"><span class="pre">stripOuterVolume=1</span></code>.</p></li>
<li><p>Examples can be found in <code class="code docutils literal notranslate"><span class="pre">bdsim/examples/features/geometry/13_placements</span></code>.</p></li>
<li><p>The file path provided in <code class="code docutils literal notranslate"><span class="pre">geometryFile</span></code> should either be relative to where bdsim
is executed from or an absolute path.</p></li>
<li><p>The main beam line begins at (0,0,0) by default but may be offset.  See
<a class="reference internal" href="model_control.html#beamline-offset"><span class="std std-ref">Offset for Main Beam Line</span></a> for more details.</p></li>
<li><p><code class="code docutils literal notranslate"><span class="pre">dontReloadGeometry</span></code> is useful when you have lots of repeated placements of the same thing
that is essentially passive material with the same sensitivity e.g. shielding. Specifically,
when you don’t want to reload the geometry and don’t want to preprocess it.</p></li>
</ul>
<p><cite>referenceElementNumber</cite> is the occurrence of that element in the sequence. For example, if a sequence
was:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">l1</span><span class="p">:</span> <span class="n">line</span><span class="o">=</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span><span class="n">sb1</span><span class="p">,</span><span class="n">d2</span><span class="p">,</span><span class="n">qd1</span><span class="p">,</span><span class="n">d2</span><span class="p">,</span><span class="n">df1</span><span class="p">,</span><span class="n">d2</span><span class="p">,</span><span class="n">sb1</span><span class="p">,</span><span class="n">d1</span><span class="p">);</span>
</pre></div>
</div>
<p>and we wanted to place with respect to the first element, we would use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">p1</span><span class="p">:</span> <span class="n">placement</span><span class="p">,</span> <span class="n">referenceElement</span><span class="o">=</span><span class="s2">&quot;d1&quot;</span><span class="p">,</span>
               <span class="n">referenceElementNumber</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>And the <cite>referenceElementNumber</cite> argument is optional as the default is 0. If we want to place with respect to
the fourth usage of “d2”, we would use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">p1</span><span class="p">:</span> <span class="n">placement</span><span class="p">,</span> <span class="n">referenceElement</span><span class="o">=</span><span class="s2">&quot;d2&quot;</span><span class="p">,</span>
               <span class="n">referenceElementNumber</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span>
</pre></div>
</div>
<p>If we want to placement at some coordinates with an axis-angle rotation (easier to perceive), we
would use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">p1</span><span class="p">:</span> <span class="n">placement</span><span class="p">,</span> <span class="n">geometryFile</span><span class="o">=</span><span class="s2">&quot;gdml:anExampleFile.gdml&quot;</span><span class="p">,</span>
               <span class="n">x</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">30</span><span class="o">*</span><span class="n">m</span><span class="p">,</span>
               <span class="n">axisAngle</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
               <span class="n">axisY</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
               <span class="n">angle</span><span class="o">=</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
</pre></div>
</div>
<p>This would place with an offset of <span class="math notranslate nohighlight">\(x, y, z = 2, 0.1, 30 m\)</span>, then a rotation about the Y axis
of <span class="math notranslate nohighlight">\(\pi/4\)</span>. We use the flag <code class="code docutils literal notranslate"><span class="pre">axisAngle=1</span></code> to turn ‘on’ the axis angle rotation
(instead of the Euler angles one), and <code class="code docutils literal notranslate"><span class="pre">axisX</span></code>, <code class="code docutils literal notranslate"><span class="pre">axisY</span></code>, <code class="code docutils literal notranslate"><span class="pre">axisZ</span></code> are the
components of the unit vector about which to rotate by <code class="code docutils literal notranslate"><span class="pre">angle</span></code>. Each component is by
default 0, so we need only define the axis we want as 1 if aligned with one of the global
axes.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Dipoles are split in BDSIM into many small straight sections. These must have a unique
name to appear correctly in the Geant4 visualisation system. The splitting is done
dynamically based on the angle of the bend and if it has pole face rotations on one
or both sides. The names are mangled and so the original name will not be found.
The user should run the visualiser first
and identify the name of the segment of the dipole they wish to place with respect to.
Alternatively, in the case of low angle bends, the element before or after can be used
with a finite <cite>s</cite> offset.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Geant4 uses a right-handed coordinate system and <span class="math notranslate nohighlight">\(m\)</span> and <span class="math notranslate nohighlight">\(rad\)</span> are
the default units for offsets and angles in BDSIM.</p>
</div>
<section id="external-geometry-file">
<h3>External Geometry File<a class="headerlink" href="#external-geometry-file" title="Link to this heading"></a></h3>
<p>The following is an example syntax used to place a piece of geometry:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">leadblock</span><span class="p">:</span> <span class="n">placement</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">m</span><span class="p">,</span>
                      <span class="n">y</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
                      <span class="n">z</span> <span class="o">=</span> <span class="mi">12</span><span class="o">*</span><span class="n">m</span><span class="p">,</span>
                      <span class="n">geometryFile</span><span class="o">=</span><span class="s2">&quot;gdml:mygeometry/detector.gdml&quot;</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="bdsim-component">
<h3>BDSIM Component<a class="headerlink" href="#bdsim-component" title="Link to this heading"></a></h3>
<p>The following is an example of placing a <strong>single</strong> BDSIM-generated component at an arbitrary position:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">block1</span><span class="p">:</span> <span class="n">rcol</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">1</span><span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="s2">&quot;Cu&quot;</span><span class="p">;</span>
<span class="n">pl1</span><span class="p">:</span> <span class="n">placement</span><span class="p">,</span> <span class="n">bdsimElement</span><span class="o">=</span><span class="s2">&quot;block1&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">20</span><span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">axisAngle</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axisY</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Care must be taken not to define the same placement name twice. If <cite>leadblock</cite>
were declared again here, the first definition would be updated with parameters
from the second, leading to possibly unexpected geometry.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For using a general piece of geometry as part of a beam line, it is better to use
the <cite>element</cite> beam line element.  See <a class="reference internal" href="model_construction.html#element"><span class="std std-ref">element</span></a>.  The length should be specified
accurately and then the beam line will fit together well without any air gaps.</p>
</div>
</section>
</section>
<section id="tunnel-geometry">
<span id="id15"></span><h2>Tunnel Geometry<a class="headerlink" href="#tunnel-geometry" title="Link to this heading"></a></h2>
<p>BDSIM can build a tunnel around the beam line. Currently, there are two main ways to control this.</p>
<ol class="arabic simple">
<li><p>The tunnel follows the beam line, bending automatically (recommended)</p></li>
<li><p>The tunnel is just built in a straight line - this may be useful for linear colliders but
may also cause geometry overlaps (the user is responsible for checking this!)</p></li>
</ol>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>With option 2, the user is entirely responsible to ensure no overlaps occur
(through good design).</p>
</div>
<p>Examples of tunnel geometry can be found with the BDSIM source code in
<code class="code docutils literal notranslate"><span class="pre">bdsim/examples/features/geometry/tunnel*</span></code> and are described in <a class="reference internal" href="examples/5_tunnel.html#tunnel-examples"><span class="std std-ref">Tunnel Geometry</span></a>.</p>
<p>The automatic tunnel building is controlled through the following options used with the
<code class="code docutils literal notranslate"><span class="pre">option</span></code> command.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Tunnel Parameters</strong></p></th>
<th class="head"><p><strong>Default</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>buildTunnel</p></td>
<td><p>0 (false)</p></td>
<td><p>Whether to build a tunnel</p></td>
</tr>
<tr class="row-odd"><td><p>buildTunnelStraight</p></td>
<td><p>0 (false)</p></td>
<td><p>Whether to build a tunnel, ignoring the
beamline and just in a straight line</p></td>
</tr>
<tr class="row-even"><td><p>buildTunnelFloor</p></td>
<td><p>1 (true)</p></td>
<td><p>Whether to add a floor to the tunnel</p></td>
</tr>
<tr class="row-odd"><td><p>tunnelIsInfiniteAbsorber</p></td>
<td><p>0 (false)</p></td>
<td><p>Whether all particles entering the
tunnel material should be killed or not</p></td>
</tr>
<tr class="row-even"><td><p>tunnelType</p></td>
<td><p>“circular”</p></td>
<td><p>Which style of tunnel to use - one of:
“circular`, “elliptical”, “square”,
“rectangular”</p></td>
</tr>
<tr class="row-odd"><td><p>tunnelAper1</p></td>
<td><p>2</p></td>
<td><p>Tunnel aperture parameter #1, typically
horizontal (m)</p></td>
</tr>
<tr class="row-even"><td><p>tunnelAper2</p></td>
<td><p>2</p></td>
<td><p>Tunnel aperture parameter #2, typically
vertical (m)</p></td>
</tr>
<tr class="row-odd"><td><p>tunnelThickness</p></td>
<td><p>0.1</p></td>
<td><p>Thickness of tunnel wall (m)</p></td>
</tr>
<tr class="row-even"><td><p>tunnelSoilThickness</p></td>
<td><p>1.0</p></td>
<td><p>Soil thickness outside tunnel wall (m)</p></td>
</tr>
<tr class="row-odd"><td><p>tunnelMaterial</p></td>
<td><p>“concrete”</p></td>
<td><p>Material for tunnel wall</p></td>
</tr>
<tr class="row-even"><td><p>soilMaterial</p></td>
<td><p>“soil”</p></td>
<td><p>Material for soil outside tunnel wall</p></td>
</tr>
<tr class="row-odd"><td><p>tunnelOffsetX</p></td>
<td><p>0</p></td>
<td><p>Horizontal offset of the tunnel with
respect to the beam line reference
trajectory</p></td>
</tr>
<tr class="row-even"><td><p>tunnelOffsetY</p></td>
<td><p>0</p></td>
<td><p>Vertical offset of the tunnel with
respect to the beam line reference
trajectory</p></td>
</tr>
<tr class="row-odd"><td><p>tunnelFloorOffset</p></td>
<td><p>1.0</p></td>
<td><p>The offset of the tunnel floor from the
centre of the tunnel (<strong>not</strong> the beam
line). Must be positive.</p></td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">option</span><span class="p">,</span> <span class="n">buildTunnel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">tunnelOffsetX</span> <span class="o">=</span> <span class="o">-</span><span class="mi">35</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
        <span class="n">tunnelOffsetY</span> <span class="o">=</span> <span class="mi">30</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
        <span class="n">tunnelAper1</span> <span class="o">=</span> <span class="mi">220</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
        <span class="n">tunnelThickness</span> <span class="o">=</span> <span class="mi">30</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
        <span class="n">tunnelSoilThickness</span> <span class="o">=</span> <span class="mi">23</span><span class="o">*</span><span class="n">m</span><span class="p">;</span>
</pre></div>
</div>
<p>These parameters are shown schematically in the figure below (gaps not to scale, elliptical
shown as an example).</p>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/tunnel_parameters.pdf"><img alt="_images/tunnel_parameters.pdf" src="_images/tunnel_parameters.pdf" style="width: 80%;" /></a>
</figure>
<p>The soil around the tunnel is typically symmetric, with the <cite>tunnelSoilThickness</cite> being added to
the larger of the horizontal and vertical tunnel dimensions.</p>
<p>Construction of the tunnel geometry may fail in particular cases of different beam lines.
Beam lines with very strong bends ( &gt; 0.5 rad) over a few metres may cause overlapping
geometry. In future, it will be possible to override the automatic algorithm between
certain elements in the beamline, but for now such situations must be avoided.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Surrounding the beam line with a tunnel completely means that every particle simulated
will have to eventually hit something and not escape. This means that every single particle
will likely create a shower of particles down to 0 energy. This can increase simulation time.
To avoid this, or at least control this behaviour, it is recommended to use the options
<code class="code docutils literal notranslate"><span class="pre">minimumKineticEnergyTunnel</span></code> or <code class="code docutils literal notranslate"><span class="pre">tunnelIsInfiniteAbsorber</span></code>.</p>
</div>
</section>
<section id="crystals">
<span id="id16"></span><h2>Crystals<a class="headerlink" href="#crystals" title="Link to this heading"></a></h2>
<p>To use various crystal components in BDSIM such as <a class="reference internal" href="model_construction.html#element-crystal-col"><span class="std std-ref">crystalcol</span></a>, a crystal definition
must first be made. This contains all of the required information to construct the
crystal. The following parameters are required:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Parameter</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>material</p></td>
<td><p>Material that the crystal will be composed of</p></td>
</tr>
<tr class="row-odd"><td><p>data</p></td>
<td><p>Path to data files, including first part of file name</p></td>
</tr>
<tr class="row-even"><td><p>shape</p></td>
<td><p>Geometry used - one of (box, cylinder, torus)</p></td>
</tr>
<tr class="row-odd"><td><p>lengthX</p></td>
<td><p>X-dimension full length [m]</p></td>
</tr>
<tr class="row-even"><td><p>lengthY</p></td>
<td><p>Y-dimension full length [m]</p></td>
</tr>
<tr class="row-odd"><td><p>lengthZ</p></td>
<td><p>Z-dimension full length [m]</p></td>
</tr>
<tr class="row-even"><td><p>sizeA</p></td>
<td><p>Unit cell a dimension [m]*</p></td>
</tr>
<tr class="row-odd"><td><p>sizeB</p></td>
<td><p>Unit cell b dimension [m]*</p></td>
</tr>
<tr class="row-even"><td><p>sizeC</p></td>
<td><p>Unit cell c dimension [m]*</p></td>
</tr>
<tr class="row-odd"><td><p>alpha</p></td>
<td><p>Interaxial angle <span class="math notranslate nohighlight">\(\alpha\)</span> in units of <span class="math notranslate nohighlight">\(\pi/2\)</span></p></td>
</tr>
<tr class="row-even"><td><p>beta</p></td>
<td><p>Interaxial angle <span class="math notranslate nohighlight">\(\beta\)</span> in units of <span class="math notranslate nohighlight">\(\pi/2\)</span></p></td>
</tr>
<tr class="row-odd"><td><p>gamma</p></td>
<td><p>Interaxial angle <span class="math notranslate nohighlight">\(\gamma\)</span> in units of <span class="math notranslate nohighlight">\(\pi/2\)</span></p></td>
</tr>
<tr class="row-even"><td><p>spaceGroup</p></td>
<td><p>Space grouping of lattice (integer)</p></td>
</tr>
<tr class="row-odd"><td><p>bendingAngleYAxis</p></td>
<td><p>Angle that the crystal is bent about Y-axis [rad].</p></td>
</tr>
<tr class="row-even"><td><p>bendingAngleZAxis</p></td>
<td><p>Angle that the crystal is bent about Z-axis [rad].</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>(*) Note, the units of metres may seem ridiculous, but the parser is consistently in S.I.
(or as much as possible). We recommend using units in the parser such as Angstroms.
See <a class="reference internal" href="input_syntax.html#coordinates-and-units"><span class="std std-ref">Coordinates &amp; Units</span></a>.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Depending on the shape chosen, the geometry may or may not represent the bending angle.
The <cite>bendingAngleYAxis</cite> is always supplied to the channelling physics process
irrespective of the geometry. This is important to note that the crystal may be a box,
but the ‘crystal’ inside (in terms of the physics process) is not related to the geometry
and is bent. The physical geometry is merely a volume where the crystal parameters
apply.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If there is no vertical bending angle, the torus geometry will reduce to the
cylinder geometry,  as this is faster for tracking. Similarly, if the cylinder is used
and there is no horizontal bending angle, a box will be used, as it’s not possible
to construct a cylinder with an infinite bending radius.</p>
</div>
<p>It is entirely possible to add more shapes to the code. Please contact the developers
<a class="reference internal" href="support.html#feature-request"><span class="std std-ref">Feature Request</span></a>.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lovelycrystal</span><span class="p">:</span> <span class="n">crystal</span><span class="p">,</span> <span class="n">material</span> <span class="o">=</span> <span class="s2">&quot;G4_Si&quot;</span><span class="p">,</span>
                      <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;data/Si220pl&quot;</span><span class="p">,</span>
                      <span class="n">shape</span> <span class="o">=</span> <span class="s2">&quot;box&quot;</span><span class="p">,</span>
                      <span class="n">lengthY</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
                      <span class="n">lengthX</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">mm</span><span class="p">,</span>
                      <span class="n">lengthZ</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">mm</span><span class="p">,</span>
                      <span class="n">sizeA</span> <span class="o">=</span> <span class="mf">5.43</span><span class="o">*</span><span class="n">ang</span><span class="p">,</span>
                      <span class="n">sizeB</span> <span class="o">=</span> <span class="mf">5.43</span><span class="o">*</span><span class="n">ang</span><span class="p">,</span>
                      <span class="n">sizeC</span> <span class="o">=</span> <span class="mf">5.43</span><span class="o">*</span><span class="n">ang</span><span class="p">,</span>
                      <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="n">beta</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="n">gamma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="n">spaceGroup</span> <span class="o">=</span> <span class="mi">227</span><span class="p">,</span>
                      <span class="n">bendingAngleYAxis</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">rad</span><span class="p">,</span>
                      <span class="n">bendingAngleZAxis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">uglycrystal</span><span class="p">:</span> <span class="n">crystal</span><span class="p">,</span> <span class="n">material</span> <span class="o">=</span> <span class="s2">&quot;G4_Si&quot;</span><span class="p">,</span>
                      <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;data/Si220pl&quot;</span><span class="p">,</span>
                      <span class="n">shape</span> <span class="o">=</span> <span class="s2">&quot;box&quot;</span><span class="p">,</span>
                      <span class="n">lengthY</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span>
                      <span class="n">lengthX</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">mm</span><span class="p">,</span>
                      <span class="n">lengthZ</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">mm</span><span class="p">,</span>
                      <span class="n">sizeA</span> <span class="o">=</span> <span class="mf">5.43</span><span class="o">*</span><span class="n">ang</span><span class="p">,</span>
                      <span class="n">sizeB</span> <span class="o">=</span> <span class="mf">5.43</span><span class="o">*</span><span class="n">ang</span><span class="p">,</span>
                      <span class="n">sizeC</span> <span class="o">=</span> <span class="mf">5.43</span><span class="o">*</span><span class="n">ang</span><span class="p">,</span>
                      <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="n">beta</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="n">gamma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="n">spaceGroup</span> <span class="o">=</span> <span class="mi">227</span><span class="p">,</span>
                      <span class="n">bendingAngleYAxis</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span><span class="o">*</span><span class="n">rad</span><span class="p">,</span>
                      <span class="n">bendingAngleZAxis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>More examples can be found in <a class="reference internal" href="examples/11_crystals.html#crystal-examples"><span class="std std-ref">Crystals</span></a>.</p>
</section>
<section id="colours">
<span id="id17"></span><h2>Colours<a class="headerlink" href="#colours" title="Link to this heading"></a></h2>
<p>Most items allow you to define a custom colour for them to aid in visualisation. This includes
all magnets and collimators, the shield and degrader. The colour can be defined with red, green
and blue components, as well as a level of transparency, alpha. RGB values can range from 0
to 255. Once defined, a colour may not be redefined. The syntax to define a colour is</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>NAME: newcolour, red=#, green=#, blue=#, alpha=#
</pre></div>
</div>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">purple</span><span class="p">:</span> <span class="n">newcolour</span><span class="p">,</span> <span class="n">red</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">green</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">blue</span><span class="o">=</span><span class="mi">128</span><span class="p">;</span>
<span class="n">col1</span><span class="p">:</span> <span class="n">rcol</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mf">0.2</span><span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">xsize</span><span class="o">=</span><span class="mi">5</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span> <span class="n">ysize</span><span class="o">=</span><span class="mi">4</span><span class="o">*</span><span class="n">cm</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="s2">&quot;purple&quot;</span><span class="p">,</span> <span class="n">material</span><span class="o">=</span><span class="s2">&quot;copper&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>and:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">purple</span><span class="p">:</span> <span class="n">newcolour</span><span class="p">,</span> <span class="n">red</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">green</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">blue</span><span class="o">=</span><span class="mi">128</span><span class="p">;</span>
<span class="n">orange</span><span class="p">:</span> <span class="n">newcolour</span><span class="p">,</span> <span class="n">red</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">green</span><span class="o">=</span><span class="mi">140</span><span class="p">,</span> <span class="n">blue</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">nicegreen</span><span class="p">:</span> <span class="n">newcolour</span><span class="p">,</span> <span class="n">red</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">green</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">blue</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

<span class="n">d1</span><span class="p">:</span> <span class="n">drift</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">1</span><span class="o">*</span><span class="n">m</span><span class="p">;</span>
<span class="n">basebend</span><span class="p">:</span> <span class="n">sbend</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mf">0.9</span><span class="p">;</span>
<span class="n">sb1</span><span class="p">:</span> <span class="n">basebend</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="s2">&quot;purple&quot;</span><span class="p">;</span>
<span class="n">sb3</span><span class="p">:</span> <span class="n">basebend</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="s2">&quot;nicegreen&quot;</span><span class="p">;</span>
<span class="n">sb4</span><span class="p">:</span> <span class="n">basebend</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">;</span>
<span class="n">sb5</span><span class="p">:</span> <span class="n">basebend</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">;</span>
<span class="n">sb6</span><span class="p">:</span> <span class="n">basebend</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">;</span>

<span class="n">beamline</span><span class="p">:</span> <span class="n">line</span><span class="o">=</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span><span class="n">sb1</span><span class="p">,</span><span class="n">d1</span><span class="p">,</span><span class="n">basebend</span><span class="p">,</span><span class="n">d1</span><span class="p">,</span><span class="n">sb3</span><span class="p">,</span><span class="n">d1</span><span class="p">,</span><span class="n">sb4</span><span class="p">,</span><span class="n">d1</span><span class="p">,</span><span class="n">sb5</span><span class="p">,</span><span class="n">d1</span><span class="p">,</span><span class="n">sb6</span><span class="p">,</span><span class="n">d1</span><span class="p">);</span>
<span class="n">use</span><span class="p">,</span> <span class="n">beamline</span><span class="p">;</span>
<span class="n">sample</span><span class="p">,</span> <span class="nb">all</span><span class="p">;</span>

<span class="n">beam</span><span class="p">,</span>  <span class="n">particle</span><span class="o">=</span><span class="s2">&quot;proton&quot;</span><span class="p">,</span>
       <span class="n">energy</span><span class="o">=</span> <span class="mi">50</span><span class="o">*</span><span class="n">GeV</span><span class="p">;</span>
</pre></div>
</div>
<p>This examples if from <cite>bdsim/examples/features/visualisation/coloured_sbend.gmad</cite> and
produces the model shown below.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="_images/coloured_sbends.png"><img alt="_images/coloured_sbends.png" src="_images/coloured_sbends.png" style="width: 80%;" /></a>
</figure>
<ul class="simple">
<li><p>Colours can only be specified on an element-by-element basis.</p></li>
<li><p>Colour names are case-sensitive.</p></li>
<li><p>New colour names must not clash with predefined BDSIM colour names.</p></li>
</ul>
<p>All available colours in BDSIM can be found by running BDSIM with the <code class="code docutils literal notranslate"><span class="pre">--colours</span></code> command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bdsim</span> <span class="o">--</span><span class="n">colours</span>
</pre></div>
</div>
<p>For convenience the predefined colours in BDSIM are:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>R</p></th>
<th class="head"><p>G</p></th>
<th class="head"><p>B</p></th>
<th class="head"><p>A</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>LHCcoil</p></td>
<td><p>229</p></td>
<td><p>191</p></td>
<td><p>0</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>LHCcollar</p></td>
<td><p>229</p></td>
<td><p>229</p></td>
<td><p>229</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>LHCcopperskin</p></td>
<td><p>184</p></td>
<td><p>133</p></td>
<td><p>10</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>LHCyoke</p></td>
<td><p>0</p></td>
<td><p>127</p></td>
<td><p>255</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>LHCyokered</p></td>
<td><p>209</p></td>
<td><p>25</p></td>
<td><p>25</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>awakescreen</p></td>
<td><p>175</p></td>
<td><p>196</p></td>
<td><p>222</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>awakespectrometer</p></td>
<td><p>0</p></td>
<td><p>102</p></td>
<td><p>204</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>beampipe</p></td>
<td><p>102</p></td>
<td><p>102</p></td>
<td><p>102</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>black</p></td>
<td><p>0</p></td>
<td><p>0</p></td>
<td><p>0</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>blue</p></td>
<td><p>0</p></td>
<td><p>0</p></td>
<td><p>255</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>brown</p></td>
<td><p>114</p></td>
<td><p>63</p></td>
<td><p>0</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>coil</p></td>
<td><p>184</p></td>
<td><p>115</p></td>
<td><p>51</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>collimator</p></td>
<td><p>63</p></td>
<td><p>102</p></td>
<td><p>51</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>copper</p></td>
<td><p>184</p></td>
<td><p>115</p></td>
<td><p>51</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>crystal</p></td>
<td><p>175</p></td>
<td><p>196</p></td>
<td><p>222</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>cyan</p></td>
<td><p>0</p></td>
<td><p>255</p></td>
<td><p>255</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>decapole</p></td>
<td><p>76</p></td>
<td><p>51</p></td>
<td><p>178</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>default</p></td>
<td><p>229</p></td>
<td><p>229</p></td>
<td><p>229</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>degrader</p></td>
<td><p>159</p></td>
<td><p>159</p></td>
<td><p>159</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>dipolefringe</p></td>
<td><p>229</p></td>
<td><p>229</p></td>
<td><p>229</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>drift</p></td>
<td><p>102</p></td>
<td><p>102</p></td>
<td><p>102</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>ecol</p></td>
<td><p>63</p></td>
<td><p>102</p></td>
<td><p>51</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>element</p></td>
<td><p>229</p></td>
<td><p>229</p></td>
<td><p>229</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>gap</p></td>
<td><p>229</p></td>
<td><p>229</p></td>
<td><p>229</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>gdml</p></td>
<td><p>102</p></td>
<td><p>51</p></td>
<td><p>0</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>gray</p></td>
<td><p>127</p></td>
<td><p>127</p></td>
<td><p>127</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>green</p></td>
<td><p>0</p></td>
<td><p>255</p></td>
<td><p>0</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>grey</p></td>
<td><p>127</p></td>
<td><p>127</p></td>
<td><p>127</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>hkicker</p></td>
<td><p>76</p></td>
<td><p>51</p></td>
<td><p>178</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>iron</p></td>
<td><p>129</p></td>
<td><p>81</p></td>
<td><p>74</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>jcol</p></td>
<td><p>63</p></td>
<td><p>102</p></td>
<td><p>51</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>kapton</p></td>
<td><p>236</p></td>
<td><p>96</p></td>
<td><p>20</p></td>
<td><p>0.5</p></td>
</tr>
<tr class="row-even"><td><p>kicker</p></td>
<td><p>0</p></td>
<td><p>102</p></td>
<td><p>204</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>lead</p></td>
<td><p>96</p></td>
<td><p>104</p></td>
<td><p>115</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>magenta</p></td>
<td><p>255</p></td>
<td><p>0</p></td>
<td><p>255</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>marker</p></td>
<td><p>229</p></td>
<td><p>229</p></td>
<td><p>229</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>multipole</p></td>
<td><p>118</p></td>
<td><p>135</p></td>
<td><p>153</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>muonspoiler</p></td>
<td><p>0</p></td>
<td><p>205</p></td>
<td><p>208</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>octupole</p></td>
<td><p>0</p></td>
<td><p>153</p></td>
<td><p>76</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>opaquebox</p></td>
<td><p>51</p></td>
<td><p>51</p></td>
<td><p>51</p></td>
<td><p>0.2</p></td>
</tr>
<tr class="row-even"><td><p>paralleltransporter</p></td>
<td><p>229</p></td>
<td><p>229</p></td>
<td><p>229</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>quadrupole</p></td>
<td><p>209</p></td>
<td><p>25</p></td>
<td><p>25</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>rbend</p></td>
<td><p>0</p></td>
<td><p>102</p></td>
<td><p>204</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>rcol</p></td>
<td><p>63</p></td>
<td><p>102</p></td>
<td><p>51</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>reallyreallydarkgrey</p></td>
<td><p>51</p></td>
<td><p>51</p></td>
<td><p>51</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>rectangularbend</p></td>
<td><p>0</p></td>
<td><p>102</p></td>
<td><p>204</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>red</p></td>
<td><p>255</p></td>
<td><p>0</p></td>
<td><p>0</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>rf</p></td>
<td><p>118</p></td>
<td><p>135</p></td>
<td><p>153</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>rfcavity</p></td>
<td><p>118</p></td>
<td><p>135</p></td>
<td><p>153</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>rfx</p></td>
<td><p>118</p></td>
<td><p>135</p></td>
<td><p>153</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>rfy</p></td>
<td><p>118</p></td>
<td><p>135</p></td>
<td><p>153</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>rmatrix</p></td>
<td><p>229</p></td>
<td><p>229</p></td>
<td><p>229</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>sbend</p></td>
<td><p>0</p></td>
<td><p>102</p></td>
<td><p>204</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>screen</p></td>
<td><p>175</p></td>
<td><p>196</p></td>
<td><p>222</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>screenframe</p></td>
<td><p>178</p></td>
<td><p>178</p></td>
<td><p>178</p></td>
<td><p>0.4</p></td>
</tr>
<tr class="row-odd"><td><p>sectorbend</p></td>
<td><p>0</p></td>
<td><p>102</p></td>
<td><p>204</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>sextupole</p></td>
<td><p>255</p></td>
<td><p>204</p></td>
<td><p>0</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>shield</p></td>
<td><p>138</p></td>
<td><p>135</p></td>
<td><p>119</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>soil</p></td>
<td><p>138</p></td>
<td><p>90</p></td>
<td><p>0</p></td>
<td><p>0.4</p></td>
</tr>
<tr class="row-odd"><td><p>solenoid</p></td>
<td><p>255</p></td>
<td><p>139</p></td>
<td><p>0</p></td>
<td><p>0.7</p></td>
</tr>
<tr class="row-even"><td><p>srfcavity</p></td>
<td><p>175</p></td>
<td><p>196</p></td>
<td><p>222</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>target</p></td>
<td><p>63</p></td>
<td><p>102</p></td>
<td><p>51</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>thinmultipole</p></td>
<td><p>229</p></td>
<td><p>229</p></td>
<td><p>229</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>thinrmatrix</p></td>
<td><p>229</p></td>
<td><p>229</p></td>
<td><p>229</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>tkicker</p></td>
<td><p>0</p></td>
<td><p>102</p></td>
<td><p>204</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>traj_negative</p></td>
<td><p>204</p></td>
<td><p>0</p></td>
<td><p>0</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>traj_neutral</p></td>
<td><p>51</p></td>
<td><p>178</p></td>
<td><p>0</p></td>
<td><p>0.2</p></td>
</tr>
<tr class="row-odd"><td><p>traj_positive</p></td>
<td><p>0</p></td>
<td><p>51</p></td>
<td><p>229</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>tunnel</p></td>
<td><p>138</p></td>
<td><p>135</p></td>
<td><p>119</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>tunnelfloor</p></td>
<td><p>127</p></td>
<td><p>127</p></td>
<td><p>114</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>undulator</p></td>
<td><p>159</p></td>
<td><p>159</p></td>
<td><p>159</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>vkicker</p></td>
<td><p>186</p></td>
<td><p>84</p></td>
<td><p>211</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>warning</p></td>
<td><p>255</p></td>
<td><p>19</p></td>
<td><p>146</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>water</p></td>
<td><p>0</p></td>
<td><p>102</p></td>
<td><p>204</p></td>
<td><p>0.5</p></td>
</tr>
<tr class="row-even"><td><p>white</p></td>
<td><p>255</p></td>
<td><p>255</p></td>
<td><p>255</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>wirescanner</p></td>
<td><p>138</p></td>
<td><p>135</p></td>
<td><p>119</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>yellow</p></td>
<td><p>255</p></td>
<td><p>255</p></td>
<td><p>0</p></td>
<td><p>1</p></td>
</tr>
</tbody>
</table>
</section>
<section id="automatic-colours">
<span id="id18"></span><h2>Automatic Colours<a class="headerlink" href="#automatic-colours" title="Link to this heading"></a></h2>
<p>In the case where an automatic colouring option is used, BDSIM can automatically assign a colour
to volumes based on their material for visualisation purposes. This is done with a set of predefined
ones for common elements and materials, and then the fall back is to use the state and the density. The
materials state sets the opacity and the density is used to scale a grey colour. In all cases, the geometry
will be visible.</p>
</section>
<section id="regions">
<span id="id19"></span><h2>Regions<a class="headerlink" href="#regions" title="Link to this heading"></a></h2>
<p>In Geant4, it is possible to have different <em>regions</em> - each with their own production cuts
and user limits. A “region” in Geant4 terms is a collection of Logical Volumes that have the
same set of production cuts and don’t necessarily have to be beside each other.</p>
<p>Production cuts are a length scale over which the simulation is considered correct and
can roughly be thought of as the length a secondary would have to travel in that material
to be tracked.</p>
<p>In BDSIM, there is one default region that applies everywhere. It is controlled
by <code class="code docutils literal notranslate"><span class="pre">option,</span> <span class="pre">defaultRangeCut</span></code> along with the other options <code class="code docutils literal notranslate"><span class="pre">prodCutXXXX</span></code>
(see <a class="reference internal" href="model_control.html#physics-process-options"><span class="std std-ref">Physics Processes</span></a>).</p>
<p>The <code class="code docutils literal notranslate"><span class="pre">defaultRangeCut</span></code> acts as a default for the 4 possible range cuts for
protons, photons, electrons and positrons, unless their <code class="code docutils literal notranslate"><span class="pre">prodCutXXXX</span></code> option
is specified.  Aside from the global options, a <code class="code docutils literal notranslate"><span class="pre">custregion</span></code> object may be
declared that defines a set of range cuts. This object can then be attached to
beam line elements. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">precisionRegion</span><span class="p">:</span> <span class="n">cutsregion</span><span class="p">,</span> <span class="n">prodCutProtons</span><span class="o">=</span><span class="mi">1</span><span class="o">*</span><span class="n">m</span><span class="p">,</span>
                             <span class="n">prodCutElectrons</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">m</span><span class="p">,</span>
                             <span class="n">prodCutPositrons</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">m</span><span class="p">,</span>
                             <span class="n">prodCutPhotons</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">mm</span><span class="p">;</span>

<span class="n">d1</span><span class="p">:</span> <span class="n">drift</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="s2">&quot;precisionRegion&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>The following parameters are available in the <cite>cutsregion</cite> object and as global options:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Parameter</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>defaultRangeCut</p></td>
<td><p>The default range cut for this object.</p></td>
</tr>
<tr class="row-odd"><td><p>prodCutProtons</p></td>
<td><p>The range cut for protons.</p></td>
</tr>
<tr class="row-even"><td><p>prodCutPhotons</p></td>
<td><p>The range cut for photons / gammas.</p></td>
</tr>
<tr class="row-odd"><td><p>prodCutElectrons</p></td>
<td><p>The range cut for electrons.</p></td>
</tr>
<tr class="row-even"><td><p>prodCutPositrons</p></td>
<td><p>The range cut for positrons.</p></td>
</tr>
</tbody>
</table>
<p>Geant4 translates these range cuts into an energy per particle type per material. This
method is documented as being much more physically accurate than a simple energy
cut across all volumes for all particle types. i.e. the computation time can be
reduced but the physical accuracy maintained in areas of vastly different
density.</p>
<ul class="simple">
<li><p>The default for Geant4 is <strong>1 mm</strong> or <strong>0.7 mm</strong> depending on the version.
This approximately corresponds to keV energy scales in air for most particles.</p></li>
<li><p>The related energies in various materials do not scale linearly or continuously
with the range parameter. This is OK.</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Setting a length scale longer or larger than the beam line element or
volume the region will be used in may result in inaccurate physics
result and peaks and troughs in energy deposition around boundaries.</p>
</div>
<ul class="simple">
<li><p>If the <cite>option, defaultRangeCut</cite> is set, this will be the default for the other options
if not specified.</p></li>
<li><p>If <cite>defaultRangeCut</cite> is not specified in a <cite>cutsregion</cite> object, the default for each
range will be the corresponding range from the options. e.g. <cite>option, prodCutProtons</cite>
will be the default for <cite>prodCutProtons</cite> in a <cite>cutsregion</cite> object if <cite>defaultRangeCut</cite>
is not specified in the object.</p></li>
<li><p>See <code class="code docutils literal notranslate"><span class="pre">bdsim/examples/features/processes/regions</span></code> for documented examples.</p></li>
</ul>
</section>
<section id="one-turn-map">
<span id="id20"></span><h2>One Turn Map<a class="headerlink" href="#one-turn-map" title="Link to this heading"></a></h2>
<p>Geant4 mandates that there are no overlaps between solids, which in
BDSIM means that a thin 1 nm gap is placed between each lattice
element.  Whilst these thin gaps have a negligible effect for a single
pass or turn, over several turns it introduces a sizeable inaccuracy
in the tracking (in the context of large circular models).
To correct for this, BDSIM models can be supplemented
with a one turn map which is applied at the end of each turn to right
the primary back onto the correct trajectory.  To ensure physical
results the one turn map is only applied to primaries, if they did not
interact on the previous turn, and if they are within 5% of the
reference momentum.  The one turn map is also not applied on the first
turn where there the beam is offset in S, but applied on following
turns, still accounting for the exceptions mentioned above.</p>
<p>The map must be of the format as written by MAD-X-PTC’s <code class="docutils literal notranslate"><span class="pre">PTC_NORMAL</span></code>
command.  A one turn map (in this case, 12th order) can be generated
in MAD-X with the following</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PTC_CREATE_UNIVERSE</span><span class="p">;</span>
<span class="n">PTC_CREATE_LAYOUT</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">nst</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="n">true</span><span class="p">,</span> <span class="n">resplit</span><span class="p">,</span> <span class="n">xbend</span><span class="p">;</span>
<span class="n">PTC_NORMAL</span><span class="p">,</span><span class="n">maptable</span><span class="p">,</span><span class="n">icase</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">no</span><span class="o">=</span><span class="mi">12</span><span class="p">;</span>
<span class="n">write</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="s2">&quot;map_table&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="s2">&quot;my_oneturn_map_file&quot;</span><span class="p">;</span>
<span class="n">PTC_END</span><span class="p">;</span>
</pre></div>
</div>
<p>To use then use the one turn map with BDSIM</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">option</span><span class="p">,</span> <span class="n">ptcOneTurnMapFileName</span><span class="o">=</span><span class="s2">&quot;path/to/my_oneturn_map_file&quot;</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>This can only be used with circular machines.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="model_control.html" class="btn btn-neutral float-left" title="Model Control" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="model_conversion.html" class="btn btn-neutral float-right" title="Model Conversion" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Beam Delivery Simulation (BDSIM) Copyright (c) Royal Holloway, University of London, 2001 - 2025.
      <span class="lastupdated">Last updated on Jun 13, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JYMKZHVZJ2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-JYMKZHVZJ2', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>