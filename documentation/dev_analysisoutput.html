<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sensitivity, Output &amp; Analysis &mdash; BDSIM 1.7.7.develop documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=fd3f3429" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=106dc6df"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Analysis Suite" href="dev_analysissuite.html" />
    <link rel="prev" title="Beam Generation" href="dev_beamgeneration.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            BDSIM
              <img src="_static/bdsim-logo-small.jpg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.7.7.develop
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="licence.html">Licence &amp; Disclaimer</a></li>
<li class="toctree-l1"><a class="reference internal" href="authorship.html">Authorship</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="running.html">Running BDSIM</a></li>
<li class="toctree-l1"><a class="reference internal" href="input_syntax.html">Input Syntax</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_construction.html">Model Construction</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_control.html">Model Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_customisation.html">Model Customisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="model_conversion.html">Model Conversion</a></li>
<li class="toctree-l1"><a class="reference internal" href="externalgeometry.html">External Geometry Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="output.html">Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="output_analysis.html">Output Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="python_utilities.html">Python Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="visualisation.html">Visualisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="interfacing.html">Interfacing</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples &amp; Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html">Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="history.html">Version History</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="developer.html">Developer Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="dev_introduction.html">Purpose of Developer Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev_contributing.html">Contributing</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev_testing.html">Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev_styleguide.html">Style Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev_documentation_build.html">Documentation Builds</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev_release.html">Release Checklist</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev_release.html#change-of-year-or-licence">Change Of Year or Licence</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev_programlayout.html">Program Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev_buildsystem.html">Build System &amp; Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev_parser.html">Parser</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev_geantusage.html">Geant4 User Action Classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev_geometry.html">Geometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev_tracking.html">Tracking Algorithms</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev_fields.html">Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev_beamgeneration.html">Beam Generation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Sensitivity, Output &amp; Analysis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#information-from-geant4">Information From Geant4</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sensitive-detectors">Sensitive Detectors</a></li>
<li class="toctree-l4"><a class="reference internal" href="#attaching-sensitive-detectors">Attaching Sensitive Detectors</a></li>
<li class="toctree-l4"><a class="reference internal" href="#collimators">Collimators</a></li>
<li class="toctree-l4"><a class="reference internal" href="#trajectory-creation-storage">Trajectory Creation &amp; Storage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#aperture-impacts">Aperture Impacts</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#output">Output</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#how-a-root-file-works">How A ROOT File Works</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="dev_analysissuite.html">Analysis Suite</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="model_description.html">Model Description</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">BDSIM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="developer.html">Developer Documentation</a></li>
      <li class="breadcrumb-item active">Sensitivity, Output &amp; Analysis</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/dev_analysisoutput.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="sensitivity-output-analysis">
<span id="dev-analysisoutput"></span><h1>Sensitivity, Output &amp; Analysis<a class="headerlink" href="#sensitivity-output-analysis" title="Link to this heading"></a></h1>
<section id="information-from-geant4">
<h2>Information From Geant4<a class="headerlink" href="#information-from-geant4" title="Link to this heading"></a></h2>
<p>Geant4 allows the developer to gather information at every stage of the simulation, but is
by default a <em>quiet</em> simulation with no output generated.</p>
<p>BDSIM collects information broadly in two ways. Firstly, through sensitive detector (“SD”)
classes that are attached to individual volumes and make a ‘hit’, which is a snapshot of
some desired information.  Secondly, through trajectory information. Trajectories are created
for the passage of a single particle throughout the whole geometry, whereas SDs only generate
information for particles taking steps in the volumes they are attached to.</p>
<section id="sensitive-detectors">
<h3>Sensitive Detectors<a class="headerlink" href="#sensitive-detectors" title="Link to this heading"></a></h3>
<p>The role of a sensitive detector is to generate output information from steps taken in
a volume. It is registered to a ‘logical volume’ and generates hits when
particles pass through only the logical volume(s) it’s attached to.</p>
<p>These ‘hits’ are then stored in a ‘collection’ (i.e. vector) that can be processed
at the end of an event.</p>
<p>BDSIM provides several SD classes to prepare different types of information. The
two main sensitive detector classes in BDSIM are <cite>BDSSDEnergyDeposition</cite> and
<cite>BDSSDSampler</cite>. These are responsible for generating energy deposition hits in
accelerator components and for recording information in sampler volumes respectively.
The hits are translated and put into output structures in the end of event action
in BDSEventAction.</p>
<p>There is usually only one instance of the sensitive detector class even though it
is attached to many logical volumes. These are held in the singleton class
BDSSDManager.</p>
<ul class="simple">
<li><p>Each instance of a sensitive detector produces one collection.</p></li>
<li><p>Hits should contain only the required information as there will be many (millions)
of these objects.</p></li>
<li><p>The energy deposition hit (<cite>BDSHitEnergyDeposition</cite>) is split in two parts - the default
part and the optional part. This is to save transient memory by around 80% for these hits
when only using basic energy deposition.</p></li>
</ul>
</section>
<section id="attaching-sensitive-detectors">
<h3>Attaching Sensitive Detectors<a class="headerlink" href="#attaching-sensitive-detectors" title="Link to this heading"></a></h3>
<p>All beam line objects in BDSIM generally attach the sensitive detector they want
at construction time. This is done through the BDSGeometryComponent base class
that keeps a map of G4LogicalVolume* to BDSSDType, a class enum(eration) for which
sensitive detector class to use.</p>
<p>During the placement of the beam lines in BDSDetectorConstruction, the SD classes
are retrieved from BDSSDManager and attached to the G4LogicalVolumes. At this stage
the user options are applied and if the hits are not required because some output
options are turned off, the SDs will not be attached saving CPU time and memory
during the simulation.</p>
<ul class="simple">
<li><p>Only SDs that are requried are attached based on the options.</p></li>
</ul>
</section>
<section id="collimators">
<h3>Collimators<a class="headerlink" href="#collimators" title="Link to this heading"></a></h3>
<p>Collimators have their own sensitivity as extra collimator specific information can
be stored. The sensitive detector is really two on top of each other. The regular energy
deposition one is used then the colliamtor specific one. This is done to ensure consistent
information between the two (the randomly chosen point along the step where the deposition
‘happens’). The collimator hits always require the full energy deposition hits, so the
energy deposition part of the collimator hit is in a different collection of ‘full’
energy deposition hits. These are mixed (stored) with the simple energy deposition
hits at the end to give the same information but with reduced transient memory usage.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The developer must ensure consistent use of output options from global constants
in both <cite>BDSSDManager</cite> and <cite>BDSOutput</cite>. i.e. the options should be used to control
both the generation and the storage of hits. Only what’s needed for output should
be generated in the first place to save memory. Extra hits can build up, even if
acceptable from one collection, there are many and this may overall lead to
inefficient use of memory, limiting use of high throughput computing resources.</p>
</div>
</section>
<section id="trajectory-creation-storage">
<h3>Trajectory Creation &amp; Storage<a class="headerlink" href="#trajectory-creation-storage" title="Link to this heading"></a></h3>
<p>Trajectory objects are created for each new track in the Geant4 user tracking action
hook (in <cite>BDSTrackingAction</cite>). If turned on for all particles, this would record
every piece of available information for the full simulation - an unmanageable amount
of data in large studies. Therefore, this is by default only turned on for primary
particles. The trajectory information is used by the Geant4 visualisers to view the
tracks, so it must be turned on in this case too.</p>
<p>If the user turns on trajectory storage, trajectories are created for every particle
in the event and then filtered to store only the ones of interest in the output
in the end of event action in <cite>BDSEventAction</cite>.</p>
</section>
<section id="aperture-impacts">
<h3>Aperture Impacts<a class="headerlink" href="#aperture-impacts" title="Link to this heading"></a></h3>
<p>For aperture impacts, a unique sensitive detector for this type of information is attached
only to the beam pipe logical volume (i.e. not the vacuum nor container volumes). This is
chosen as it’s not easily possible to discern between particles leaving the vacuum volume
along the direction of travel or transversely and into the beam pipe.</p>
<p>To identify the impact point, the prestep point in the beam pipe must be on the volume
boundary. The momentum vector is projected (i.e. the dot product) along the surface
normal at that point (queried from G4VSolid* interface from every shape). This surface
normal can be pointint into the accelerator or out depending if it’s the inside or outside
surface. The inside one, is flipped to be one pointint outwards. This flip is detected by
again detecting a negative dot product of the surface normal with the radial vector from
the curvilinear axis to the current point. If the dot product of the momentum vector
with the outwards pointing surface normal is negative, the particle is identified as
leaving the beam pipe.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This technique may not work with a non-convex beam pipe shape.</p>
</div>
</section>
</section>
<section id="output">
<h2>Output<a class="headerlink" href="#output" title="Link to this heading"></a></h2>
<p>BDSIM writes currently to one format which is ROOT (we call it “root event” format).
The code is designed so that other formats can be added in future without affecting
the current structure of the program or output formats.</p>
<p>Generally, we keep all the information we might want to store in the output in a
base class called BDSOutputStructures. This contains only the basic information
that will be stored. BDSOutput inherits this class and is an abstract interface for
any specific output format. BDSOutput helps fill the objects in BDSOutputStructures
as well as define the interface for all output.</p>
<p>Any output format is represented by a class that inherits BDSOutput, such as
BDSOutputROOT for example. We use ROOT objects and classes in BDSIM as they are
convenient for preparing the output information from a particle physics study.
BDSOutputROOT is relatively simple as it is relatively simple to store ROOT objects
in a ROOT file. Any other output format that is written would have access to the
information in the base class BDSOutputStructures and can translate and write that
as required. We also define ROOT dictionaries and create shared libraries with all
the classes used in the output so that they can be easily loaded again.</p>
<ul class="simple">
<li><p>Generally, we use SI units + GeV and ns in the output.</p></li>
</ul>
<section id="how-a-root-file-works">
<h3>How A ROOT File Works<a class="headerlink" href="#how-a-root-file-works" title="Link to this heading"></a></h3>
<p>The ROOT file system works by have an instance of whatever you want to store that
exists in the current memory. The file is laid out pointing to these local objects
(roughly SetBranchAddress(‘name in output’, &amp;localObject) ). The developer then
sets the values of the local object, i.e. to the data they want to store. The
Fill function (on a ROOT ‘Tree’) is then called which copies the data to the file.</p>
<p>Loading the file is done in reverse. First a local empty object is created, the file
is attached to it and GetEntry() is called which loads one entry from the output
into the local object, which can then be read by the user just as if they’d created
it then and there.</p>
<p>A ROOT file can store data as one of objects in the file (such as a histogram), but
the most common usage is with a ‘Tree’ (TTree class), that is really equivalent to
a vector. Whatever structure the tree has is duplicated for each ‘entry’. In a tree,
there can be single objects or ‘branches’ with ‘leaves’ (so a maximum number of dimensions
of 2). These objects may be basic C++ types or ROOT objects, or classes defined by
the user. The ROOT file secretly stores a template of all classes stored in it, so
even if a user class is used to write a file and later on, the software is lost, the
data can still be read.</p>
<p>In BDSIM, the main output tree is called “Event” and each entry in that tree represents
one event in the simulation that starts with one primary particle fired into the accelerator.
Everything you see in the Event tree is replicated for each event but with different data
of course.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="dev_beamgeneration.html" class="btn btn-neutral float-left" title="Beam Generation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="dev_analysissuite.html" class="btn btn-neutral float-right" title="Analysis Suite" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Beam Delivery Simulation (BDSIM) Copyright (c) Royal Holloway, University of London, 2001 - 2025.
      <span class="lastupdated">Last updated on Jun 13, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JYMKZHVZJ2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-JYMKZHVZJ2', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>